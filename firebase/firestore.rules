rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPERS ====================

    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Obtiene el ID del usuario actual
    function userId() {
      return request.auth.uid;
    }

    // Verifica si el usuario es miembro del grupo
    function isGroupMember(groupId) {
      let group = get(/databases/$(database)/documents/groups/$(groupId));
      return group != null && userId() in group.data.members;
    }

    // Verifica si el usuario es admin del grupo
    function isGroupAdmin(groupId) {
      let group = get(/databases/$(database)/documents/groups/$(groupId));
      return group != null
        && userId() in group.data.members
        && group.data.members[userId()].role == 'admin';
    }

    // Verifica si el usuario es el creador del grupo
    function isGroupCreator(groupId) {
      let group = get(/databases/$(database)/documents/groups/$(groupId));
      return group != null && group.data.createdBy == userId();
    }

    // Valida que los campos requeridos estén presentes
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // ==================== INVITATIONS ====================
    // Invitaciones por email para unirse a grupos
    match /invitations/{invitationId} {
      // El invitado puede leer sus invitaciones, o el admin del grupo
      allow read: if isAuthenticated()
        && (resource.data.invitedEmail == request.auth.token.email
            || isGroupAdmin(resource.data.groupId));

      // Solo admins del grupo pueden crear invitaciones
      allow create: if isAuthenticated()
        && hasRequiredFields(['groupId', 'groupName', 'invitedEmail', 'invitedBy', 'invitedByName', 'status', 'expiresAt', 'createdAt'])
        && request.resource.data.status == 'pending'
        && isGroupAdmin(request.resource.data.groupId);

      // El invitado puede rechazar (cambiar status a 'rejected')
      // El admin puede actualizar otros campos
      allow update: if isAuthenticated()
        && (
          // Invitado rechaza
          (resource.data.invitedEmail == request.auth.token.email
           && resource.data.status == 'pending'
           && request.resource.data.status == 'rejected')
          // Admin actualiza
          || isGroupAdmin(resource.data.groupId)
        );

      // Admins del grupo pueden eliminar
      allow delete: if isAuthenticated()
        && isGroupAdmin(resource.data.groupId);
    }

    // ==================== USERS ====================

    match /users/{uid} {
      // Cualquier usuario autenticado puede leer perfiles públicos
      allow read: if isAuthenticated();

      // Solo el propio usuario puede crear/modificar su perfil
      allow create: if isAuthenticated() && uid == request.auth.uid;
      allow update: if isAuthenticated() && uid == request.auth.uid;

      // No se permite eliminar usuarios
      allow delete: if false;

      // ==================== USER LISTS ====================
      // Listas personales del usuario (pueden compartirse con miembros)
      match /lists/{listId} {
        // Propietario o miembro de la lista puede leer
        allow read: if isAuthenticated()
          && (uid == request.auth.uid || request.auth.uid in resource.data.members);

        // Solo el propietario puede crear
        allow create: if isAuthenticated() && uid == request.auth.uid;

        // Propietario o miembro puede actualizar (items, estado, etc.)
        allow update: if isAuthenticated()
          && (uid == request.auth.uid || request.auth.uid in resource.data.members);

        // Solo el propietario puede eliminar
        allow delete: if isAuthenticated() && uid == request.auth.uid;

        // Items de la lista del usuario
        match /items/{itemId} {
          // Propietario o miembro de la lista puede acceder
          allow read: if isAuthenticated()
            && (uid == request.auth.uid
                || request.auth.uid in get(/databases/$(database)/documents/users/$(uid)/lists/$(listId)).data.members);

          allow create, update, delete: if isAuthenticated()
            && (uid == request.auth.uid
                || request.auth.uid in get(/databases/$(database)/documents/users/$(uid)/lists/$(listId)).data.members);
        }

        // Tickets procesados de la lista del usuario
        match /tickets/{ticketId} {
          // Propietario o miembro de la lista puede acceder
          allow read: if isAuthenticated()
            && (uid == request.auth.uid
                || request.auth.uid in get(/databases/$(database)/documents/users/$(uid)/lists/$(listId)).data.members);

          allow create, update, delete: if isAuthenticated()
            && (uid == request.auth.uid
                || request.auth.uid in get(/databases/$(database)/documents/users/$(uid)/lists/$(listId)).data.members);
        }
      }

      // ==================== CUSTOM CATEGORIES ====================
      // Categorías personalizadas del usuario para listas agnósticas
      match /customCategories/{categoryId} {
        allow read: if isAuthenticated() && uid == request.auth.uid;
        allow create: if isAuthenticated() && uid == request.auth.uid
          && hasRequiredFields(['name', 'icon']);
        allow update: if isAuthenticated() && uid == request.auth.uid;
        allow delete: if isAuthenticated() && uid == request.auth.uid;
      }
    }

    // ==================== GROUPS ====================

    match /groups/{groupId} {
      // Solo miembros pueden leer el grupo
      allow read: if isAuthenticated() && isGroupMember(groupId);

      // Cualquier usuario autenticado puede crear un grupo
      allow create: if isAuthenticated()
        && hasRequiredFields(['name', 'createdBy', 'createdAt', 'members'])
        && request.resource.data.createdBy == userId()
        && userId() in request.resource.data.members
        && request.resource.data.members[userId()].role == 'admin';

      // Solo admins pueden actualizar el grupo
      allow update: if isAuthenticated() && isGroupAdmin(groupId);

      // Solo el creador puede eliminar el grupo
      allow delete: if isAuthenticated() && isGroupCreator(groupId);

      // ==================== CATEGORIES ====================
      // Categorías custom por grupo (para listas de compra y generales)
      match /categories/{categoryId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);
        allow create: if isAuthenticated() && isGroupMember(groupId);
        allow update: if isAuthenticated() && isGroupMember(groupId);
        allow delete: if isAuthenticated() && isGroupAdmin(groupId);
      }

      // ==================== PRODUCTS ====================

      match /products/{productId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);
        allow create: if isAuthenticated() && isGroupMember(groupId);
        allow update: if isAuthenticated() && isGroupMember(groupId);
        allow delete: if isAuthenticated() && isGroupAdmin(groupId);
      }

      // ==================== SHARED LIST REFS ====================
      // Referencias a listas compartidas con miembros del grupo
      match /sharedListRefs/{refId} {
        // Propietario o miembros incluidos pueden leer
        allow read: if isAuthenticated()
          && isGroupMember(groupId)
          && (resource.data.ownerId == request.auth.uid
              || request.auth.uid in resource.data.members);

        // Solo el propietario de la lista puede crear/actualizar la referencia
        allow create: if isAuthenticated()
          && isGroupMember(groupId)
          && request.resource.data.ownerId == request.auth.uid;

        allow update: if isAuthenticated()
          && isGroupMember(groupId)
          && resource.data.ownerId == request.auth.uid;

        // Solo el propietario puede eliminar
        allow delete: if isAuthenticated()
          && isGroupMember(groupId)
          && resource.data.ownerId == request.auth.uid;
      }

      // ==================== SHOPPING LISTS ====================

      match /shoppingLists/{listId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);
        allow create: if isAuthenticated() && isGroupMember(groupId);
        allow update: if isAuthenticated() && isGroupMember(groupId);
        allow delete: if isAuthenticated()
          && (isGroupAdmin(groupId) || resource.data.createdBy == userId());

        // ==================== LIST ITEMS ====================

        match /items/{itemId} {
          allow read: if isAuthenticated() && isGroupMember(groupId);
          allow create: if isAuthenticated() && isGroupMember(groupId);
          allow update: if isAuthenticated() && isGroupMember(groupId);
          allow delete: if isAuthenticated() && isGroupMember(groupId);
        }
      }

      // ==================== PURCHASES ====================

      match /purchases/{purchaseId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);
        allow create: if isAuthenticated() && isGroupMember(groupId);
        allow update: if isAuthenticated()
          && isGroupMember(groupId)
          && resource.data.createdBy == userId();
        allow delete: if isAuthenticated()
          && (isGroupAdmin(groupId) || resource.data.createdBy == userId());

        match /items/{itemId} {
          allow read: if isAuthenticated() && isGroupMember(groupId);
          allow write: if isAuthenticated() && isGroupMember(groupId);
        }
      }

      // ==================== PRICE HISTORY ====================

      match /priceHistory/{productId}/entries/{entryId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);
        allow create: if isAuthenticated() && isGroupMember(groupId);
        allow update: if false;
        allow delete: if isAuthenticated() && isGroupAdmin(groupId);
      }
    }
  }
}
