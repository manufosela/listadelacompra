---
/**
 * AuthGuard Component
 * Protege páginas que requieren autenticación.
 *
 * Estrategia optimizada para View Transitions:
 * - Si hay sesión cacheada (window.__authUser): contenido visible inmediatamente
 * - Si no hay sesión cacheada: muestra spinner mientras verifica
 * - Si no hay usuario: redirige a login
 */

interface Props {
  redirectTo?: string;
}

const { redirectTo = '/login' } = Astro.props;
---

<div
  id="auth-guard"
  class="auth-guard"
  data-redirect={redirectTo}
>
  <div class="auth-guard-content">
    <div class="auth-spinner"></div>
    <p>Verificando sesión...</p>
  </div>
</div>

<div id="auth-content" class="auth-content">
  <slot />
</div>

<style>
  /* Por defecto: guard oculto, contenido visible */
  /* Esto evita flash en View Transitions cuando ya hay sesión */
  .auth-guard {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background: var(--color-bg, white);
    display: none; /* Oculto por defecto */
    align-items: center;
    justify-content: center;
    z-index: 99999;
    margin: 0;
    padding: 0;
  }

  .auth-guard.checking {
    display: flex; /* Solo visible cuando verificamos */
  }

  .auth-guard-content {
    text-align: center;
  }

  .auth-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: auth-spin 0.8s linear infinite;
    margin: 0 auto 1rem;
  }

  .auth-guard-content p {
    color: #64748b;
    font-size: 1rem;
    margin: 0;
  }

  .auth-content {
    display: block; /* Visible por defecto */
  }

  .auth-content.hidden {
    display: none;
  }

  @keyframes auth-spin {
    to { transform: rotate(360deg); }
  }
</style>

<script is:inline>
  // Ejecución síncrona inmediata - antes de cualquier render
  (function() {
    var authGuard = document.getElementById('auth-guard');
    var authContent = document.getElementById('auth-content');
    if (!authGuard || !authContent) return;

    // Si ya hay usuario cacheado, no hacer nada (defaults ya muestran contenido)
    if (window.__authUser) {
      return;
    }

    // Si no hay usuario cacheado, mostrar guard y ocultar contenido mientras verificamos
    authGuard.classList.add('checking');
    authContent.classList.add('hidden');
  })();

  // Lógica de verificación de auth (solo se registra una vez)
  if (!window.__authGuardListenerRegistered) {
    window.__authGuardListenerRegistered = true;

    function completeAuth(user) {
      var authGuard = document.getElementById('auth-guard');
      var authContent = document.getElementById('auth-content');
      if (!authGuard || !authContent) return;

      if (user) {
        window.__authUser = user;
        authGuard.classList.remove('checking');
        authContent.classList.remove('hidden');
      } else {
        window.__authUser = null;
        var redirectTo = authGuard.dataset.redirect || '/login';
        window.location.href = redirectTo;
      }
    }

    async function checkAuth() {
      // Si ya verificamos y hay usuario, no hacer nada
      if (window.__authUser) return;

      var authGuard = document.getElementById('auth-guard');
      if (!authGuard) return;

      // Si el guard no está mostrando "checking", no necesitamos verificar
      if (!authGuard.classList.contains('checking')) return;

      try {
        var auth = await import('/js/auth.js');

        if (auth.isAuthResolved()) {
          completeAuth(auth.getCurrentUser());
        } else {
          window.addEventListener('auth-ready', function(e) {
            completeAuth(e.detail.user);
          }, { once: true });
        }
      } catch (e) {
        console.error('Error checking auth:', e);
        completeAuth(null);
      }
    }

    // Verificar en carga inicial y en cada View Transition
    checkAuth();
    document.addEventListener('astro:page-load', checkAuth);
  } else {
    // En navegaciones subsiguientes, verificar si necesitamos chequear
    (async function() {
      if (window.__authUser) return; // Ya autenticado

      var authGuard = document.getElementById('auth-guard');
      if (!authGuard || !authGuard.classList.contains('checking')) return;

      try {
        var auth = await import('/js/auth.js');
        if (auth.isAuthResolved()) {
          var user = auth.getCurrentUser();
          if (user) {
            window.__authUser = user;
            authGuard.classList.remove('checking');
            var authContent = document.getElementById('auth-content');
            if (authContent) authContent.classList.remove('hidden');
          } else {
            window.location.href = authGuard.dataset.redirect || '/login';
          }
        }
      } catch (e) {
        console.error('Error in subsequent auth check:', e);
      }
    })();
  }
</script>
