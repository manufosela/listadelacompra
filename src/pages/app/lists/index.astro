---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Listas">
  <div class="lists-page">
    <header class="page-header">
      <div>
        <h1>Listas</h1>
        <p id="user-greeting"></p>
      </div>
      <div class="header-actions">
        <a href="/app/lists/new" class="btn btn-primary">+ Nueva lista</a>
      </div>
    </header>

    <!-- Scanner compartido para todas las listas -->
    <hc-ticket-scanner id="shared-scanner" button-hidden></hc-ticket-scanner>

    <!-- Tabs y controles -->
    <div class="tabs-row">
      <div class="tabs">
        <button id="tab-mine" class="tab active">Mis listas</button>
        <button id="tab-archived" class="tab">
          Archivadas
          <span id="archived-count" class="tab-badge" hidden>0</span>
        </button>
      </div>
      <div class="view-toggle">
        <button id="filter-shared" class="view-toggle-btn" title="Solo compartidas" aria-pressed="false">ü§ù</button>
        <button id="view-grid" class="view-toggle-btn" title="Vista iconos">‚ò∑</button>
        <button id="view-list" class="view-toggle-btn active" title="Vista lista">‚ò∞</button>
      </div>
    </div>

    <div id="lists-container" class="lists-container">
      <!-- Se carga din√°micamente -->
    </div>

    <!-- Modal de confirmaci√≥n de borrado -->
    <div id="delete-modal" class="confirm-modal" hidden>
      <div class="confirm-modal-backdrop"></div>
      <div class="confirm-modal-content">
        <div class="confirm-modal-icon">üóëÔ∏è</div>
        <h3>Eliminar lista</h3>
        <p id="delete-modal-message">¬øEliminar esta lista?</p>
        <p class="confirm-modal-warning">Esta acci√≥n no se puede deshacer.</p>
        <div class="confirm-modal-actions">
          <button type="button" class="btn btn-secondary" id="delete-cancel-btn">Cancelar</button>
          <button type="button" class="btn btn-danger" id="delete-confirm-btn">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { getUserLists, cloneList, deleteList } from '/js/lists.js';
  import { db } from '/js/firebase-config.js';
  import { collection, query, onSnapshot, orderBy, doc, updateDoc, serverTimestamp, where } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  import { toast } from '/js/toast.js';
  import { getCurrentGroupId } from '/js/group.js';
  import '/components/hc-ticket-scanner.js';

  // Helper para formatear fechas
  function formatDate(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
  }

  let currentTab = 'mine';
  let viewMode = localStorage.getItem('listsViewMode') || 'list';
  let showSharedOnly = localStorage.getItem('listsSharedOnly') === 'true';
  let myLists = [];
  let sharedLists = [];
  let unsubscribe = null;
  let currentUser = null;
  let initialized = false;
  let tabsInitialized = false;
  let sharedRefsUnsub = null;
  const sharedListUnsubs = new Map();
  const sharedListsMap = new Map();

  function getElements() {
    return {
      container: document.getElementById('lists-container'),
      tabMine: document.getElementById('tab-mine'),
      tabArchived: document.getElementById('tab-archived'),
      archivedCount: document.getElementById('archived-count'),
      greeting: document.getElementById('user-greeting'),
      filterShared: document.getElementById('filter-shared'),
      viewGrid: document.getElementById('view-grid'),
      viewList: document.getElementById('view-list')
    };
  }

  function setupTabs() {
    if (tabsInitialized) return;
    tabsInitialized = true;

    const { tabMine, tabArchived, viewGrid, viewList, filterShared } = getElements();

    function setActiveTab(tab) {
      tabMine?.classList.remove('active');
      tabArchived?.classList.remove('active');
      tab?.classList.add('active');
    }

    tabMine?.addEventListener('click', () => {
      currentTab = 'mine';
      setActiveTab(tabMine);
      renderLists();
    });

    tabArchived?.addEventListener('click', () => {
      currentTab = 'archived';
      setActiveTab(tabArchived);
      renderLists();
    });
    currentTab = 'mine';

    filterShared?.addEventListener('click', () => {
      showSharedOnly = !showSharedOnly;
      localStorage.setItem('listsSharedOnly', String(showSharedOnly));
      filterShared.setAttribute('aria-pressed', String(showSharedOnly));
      filterShared.classList.toggle('active', showSharedOnly);
      renderLists();
    });

    // View toggle
    viewGrid?.addEventListener('click', () => {
      viewMode = 'grid';
      localStorage.setItem('listsViewMode', 'grid');
      viewGrid.classList.add('active');
      viewList?.classList.remove('active');
      renderLists();
    });

    viewList?.addEventListener('click', () => {
      viewMode = 'list';
      localStorage.setItem('listsViewMode', 'list');
      viewList.classList.add('active');
      viewGrid?.classList.remove('active');
      renderLists();
    });

    // Aplicar estado inicial del toggle
    if (viewMode === 'list') {
      viewList?.classList.add('active');
      viewGrid?.classList.remove('active');
    } else {
      viewGrid?.classList.add('active');
      viewList?.classList.remove('active');
    }

    if (filterShared) {
      filterShared.setAttribute('aria-pressed', String(showSharedOnly));
      filterShared.classList.toggle('active', showSharedOnly);
    }
  }

  function clearSharedSubscriptions() {
    if (sharedRefsUnsub) {
      sharedRefsUnsub();
      sharedRefsUnsub = null;
    }
    sharedListUnsubs.forEach(unsub => unsub());
    sharedListUnsubs.clear();
    sharedListsMap.clear();
  }

  function updateSharedLists() {
    sharedLists = Array.from(sharedListsMap.values());
    renderLists();
  }

  async function setupSharedListSubscriptions() {
    clearSharedSubscriptions();

    const groupId = getCurrentGroupId();
    if (!groupId || !currentUser?.uid) {
      sharedLists = [];
      renderLists();
      return;
    }

    const refsRef = collection(db, 'groups', groupId, 'sharedListRefs');
    const refsQuery = query(refsRef, where('members', 'array-contains', currentUser.uid));

    sharedRefsUnsub = onSnapshot(refsQuery, (snapshot) => {
      const refs = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
      const refKeys = new Set(refs.map(ref => `${ref.ownerId}:${ref.listId}`));

      // Eliminar listeners que ya no aplican
      for (const [key, unsub] of sharedListUnsubs.entries()) {
        if (!refKeys.has(key)) {
          unsub();
          sharedListUnsubs.delete(key);
          sharedListsMap.delete(key);
        }
      }

      // A√±adir listeners nuevos
      refs.forEach((ref) => {
        const key = `${ref.ownerId}:${ref.listId}`;
        if (sharedListUnsubs.has(key)) return;

        const listRef = doc(db, 'users', ref.ownerId, 'lists', ref.listId);
        const unsub = onSnapshot(listRef, (listSnap) => {
          if (!listSnap.exists()) {
            sharedListsMap.delete(key);
            updateSharedLists();
            return;
          }

          const listData = listSnap.data();
          sharedListsMap.set(key, {
            id: ref.listId,
            ...listData,
            ownerId: ref.ownerId,
            ownerName: ref.ownerName,
            shared: true
          });
          updateSharedLists();
        });

        sharedListUnsubs.set(key, unsub);
      });

      updateSharedLists();
    }, (error) => {
      console.error('Error loading shared list refs:', error);
      sharedLists = [];
      renderLists();
    });
  }

  async function initPage(user) {
    // Evitar inicializaciones m√∫ltiples
    if (initialized && currentUser?.uid === user?.uid) return;
    initialized = true;

    const { greeting } = getElements();
    currentUser = user;

    // Cancelar suscripci√≥n anterior si existe
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }

    setupTabs();

    const displayName = user.displayName?.split(' ')[0] || 'Usuario';
    if (greeting) greeting.textContent = `Hola, ${displayName}`;

    // Cargar listas compartidas en tiempo real
    await setupSharedListSubscriptions();

    // Primero mostrar datos cacheados de mis listas
    try {
      const cachedLists = await getUserLists(user);
      if (cachedLists && cachedLists.length > 0) {
        myLists = cachedLists;
        renderLists();
      }
    } catch (e) {
      console.warn('Error loading cached lists:', e);
    }

    // Luego suscribirse para actualizaciones en tiempo real
    const listsRef = collection(db, 'users', user.uid, 'lists');
    const q = query(listsRef, orderBy('updatedAt', 'desc'));

    unsubscribe = onSnapshot(q, (snapshot) => {
      myLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderLists();
    }, (error) => {
      console.error('Error loading lists:', error);
    });
  }

  function tryInit() {
    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) initPage(user);
    } else {
      window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);

  document.addEventListener('astro:before-swap', () => {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }
    clearSharedSubscriptions();
    initialized = false;
    tabsInitialized = false;
  });

  // Helper para renderizar icono (imagen o emoji)
  function renderIcon(list, cssClass = '') {
    if (list.iconUrl) {
      return `<img src="${list.iconUrl}" alt="" class="list-icon-img ${cssClass}" />`;
    }
    return list.icon || 'üõí';
  }

  function isSharedList(list) {
    if (!list) return false;
    if (list.shared) return true;
    if (list.ownerId === currentUser?.uid && Array.isArray(list.members)) {
      return list.members.length > 1;
    }
    return false;
  }

  // Helper para generar los botones de acci√≥n
  function renderActionButtons(list, isOwner) {
    const isAgnostic = list.listType === 'agnostic';
    const listId = list.id;
    const ownerId = list.ownerId || currentUser.uid;

    let buttons = '';

    // Clonar lista (siempre disponible)
    buttons += `
      <button class="list-action-btn clone-btn" data-list-id="${listId}" data-owner-id="${ownerId}" data-list-name="${list.name}" title="Clonar lista" aria-label="Clonar lista">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
      </button>
    `;

    // Escanear ticket (solo para listas no agn√≥sticas y no cerradas)
    if (!isAgnostic && !list.closed) {
      buttons += `
        <button class="list-action-btn scan-btn" data-list-id="${listId}" data-owner-id="${ownerId}" title="Escanear ticket" aria-label="Escanear ticket">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
        </button>
      `;
    }

    // Editar y archivar/borrar (solo para propietarios)
    if (isOwner) {
      // Editar solo si no est√° archivada
      if (!list.closed) {
        buttons += `
          <a href="/app/lists/edit?id=${listId}" class="list-action-btn" title="Editar lista" aria-label="Editar lista">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
          </a>
          <button class="list-action-btn archive-btn" data-list-id="${listId}" data-owner-id="${ownerId}" title="Archivar lista" aria-label="Archivar lista">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
            </svg>
          </button>
        `;
      } else {
        // Reabrir y borrar para listas archivadas
        buttons += `
          <button class="list-action-btn restore-btn" data-list-id="${listId}" data-owner-id="${ownerId}" title="Reabrir lista" aria-label="Reabrir lista">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
            </svg>
          </button>
          <button class="list-action-btn delete-btn danger" data-list-id="${listId}" data-owner-id="${ownerId}" data-list-name="${list.name}" title="Eliminar lista" aria-label="Eliminar lista">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        `;
      }
    }

    return buttons ? `<div class="list-actions-group">${buttons}</div>` : '';
  }

  function setupActionListeners() {
    // Botones de escanear ticket - abrir scanner directamente sin navegar
    document.querySelectorAll('.scan-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const listId = btn.dataset.listId;
        const ownerId = btn.dataset.ownerId;

        const scanner = document.getElementById('shared-scanner');
        if (scanner) {
          // Configurar el scanner con los datos de la lista
          scanner.setAttribute('list-id', listId);
          scanner.setAttribute('user-id', ownerId);
          scanner.listItems = []; // Sin items para matching, todo ser√° "nuevo"
          scanner.open();
        }
      });
    });

    // Botones de archivar
    document.querySelectorAll('.archive-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const listId = btn.dataset.listId;
        const ownerId = btn.dataset.ownerId;
        const isClosed = btn.dataset.closed === 'true';
        const newClosed = !isClosed;

        try {
          const listRef = doc(db, 'users', ownerId, 'lists', listId);
          await updateDoc(listRef, {
            closed: newClosed,
            archivedAt: newClosed ? serverTimestamp() : null,
            archivedBy: newClosed ? currentUser?.uid : null,
            updatedAt: serverTimestamp(),
            updatedBy: currentUser?.uid
          });
          toast.success(newClosed ? 'Lista archivada' : 'Lista reabierta');
        } catch (error) {
          console.error('Error al archivar:', error);
          toast.error('Error al cambiar estado de la lista');
        }
      });
    });

    // Botones de clonar
    document.querySelectorAll('.clone-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const listId = btn.dataset.listId;
        const ownerId = btn.dataset.ownerId;

        try {
          btn.disabled = true;
          toast.info('Clonando lista...');
          const newList = await cloneList(listId, ownerId);
          toast.success(`Lista "${newList.name}" creada`);
          btn.disabled = false;
        } catch (error) {
          console.error('Error al clonar:', error);
          toast.error('Error al clonar la lista');
          btn.disabled = false;
        }
      });
    });

    // Botones de restaurar (reabrir lista archivada)
    document.querySelectorAll('.restore-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const listId = btn.dataset.listId;
        const ownerId = btn.dataset.ownerId;

        try {
          const listRef = doc(db, 'users', ownerId, 'lists', listId);
          await updateDoc(listRef, {
            closed: false,
            archivedAt: null,
            archivedBy: null,
            updatedAt: serverTimestamp(),
            updatedBy: currentUser?.uid
          });
          toast.success('Lista reabierta');
        } catch (error) {
          console.error('Error al reabrir:', error);
          toast.error('Error al reabrir la lista');
        }
      });
    });

    // Botones de eliminar - abrir modal de confirmaci√≥n
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const listId = btn.dataset.listId;
        const listName = btn.dataset.listName;
        showDeleteModal(listId, listName);
      });
    });
  }

  // Modal de confirmaci√≥n de borrado
  let pendingDeleteListId = null;

  function showDeleteModal(listId, listName) {
    pendingDeleteListId = listId;
    const modal = document.getElementById('delete-modal');
    const message = document.getElementById('delete-modal-message');

    if (message) {
      message.textContent = `¬øEliminar la lista "${listName}"?`;
    }

    if (modal) {
      modal.hidden = false;
    }
  }

  function hideDeleteModal() {
    const modal = document.getElementById('delete-modal');
    if (modal) {
      modal.hidden = true;
    }
    pendingDeleteListId = null;
  }

  async function confirmDelete() {
    if (!pendingDeleteListId) return;

    try {
      await deleteList(pendingDeleteListId);
      toast.success('Lista eliminada');
      hideDeleteModal();
    } catch (error) {
      console.error('Error al eliminar:', error);
      toast.error('Error al eliminar la lista');
    }
  }

  // Configurar listeners del modal (una sola vez)
  function setupDeleteModalListeners() {
    const modal = document.getElementById('delete-modal');
    const cancelBtn = document.getElementById('delete-cancel-btn');
    const confirmBtn = document.getElementById('delete-confirm-btn');
    const backdrop = modal?.querySelector('.confirm-modal-backdrop');

    cancelBtn?.addEventListener('click', hideDeleteModal);
    confirmBtn?.addEventListener('click', confirmDelete);
    backdrop?.addEventListener('click', hideDeleteModal);

    // Cerrar con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal?.hidden) {
        hideDeleteModal();
      }
    });
  }

  // Inicializar listeners del modal
  setupDeleteModalListeners();

  function renderLists() {
    const { container, archivedCount } = getElements();
    if (!container) return;

    const combinedLists = [
      ...myLists.map(list => ({
        ...list,
        ownerId: list.ownerId || currentUser.uid,
        ownerName: list.ownerName || currentUser.displayName || currentUser.email?.split('@')[0] || 'Usuario',
        shared: false
      })),
      ...sharedLists
    ];

    const orderedCombinedLists = [...combinedLists].sort((a, b) => {
      const getTime = (value) => {
        if (!value) return 0;
        if (typeof value.toMillis === 'function') return value.toMillis();
        if (typeof value.toDate === 'function') return value.toDate().getTime();
        return new Date(value).getTime();
      };
      return getTime(b.updatedAt) - getTime(a.updatedAt);
    });

    // Filtrar listas abiertas y cerradas
    const filteredLists = showSharedOnly
      ? orderedCombinedLists.filter(isSharedList)
      : orderedCombinedLists;

    const openLists = filteredLists.filter(l => !l.closed);
    const archivedLists = filteredLists.filter(l => l.closed);

    // Actualizar badge de archivadas
    if (archivedCount) {
      if (archivedLists.length > 0) {
        archivedCount.textContent = archivedLists.length;
        archivedCount.hidden = false;
      } else {
        archivedCount.hidden = true;
      }
    }

    let lists;
    if (currentTab === 'archived') {
      lists = archivedLists;
    } else {
      lists = openLists;
    }

    const isArchivedTab = currentTab === 'archived';
    const hasShared = orderedCombinedLists.some(list => list.ownerId && list.ownerId !== currentUser.uid);

    if (lists.length === 0) {
      let emptyMessage = 'No tienes listas todav√≠a';
      if (isArchivedTab) {
        emptyMessage = 'No tienes listas archivadas';
      }

      container.innerHTML = `
        <div class="empty-state">
          <p>${emptyMessage}</p>
          ${!isArchivedTab ? '<a href="/app/lists/new" class="btn btn-primary">Crear mi primera lista</a>' : ''}
        </div>
      `;
      return;
    }

    if (viewMode === 'list') {
      // Vista lista/tabla
      container.innerHTML = `
        <div class="lists-table-wrapper">
          <table class="lists-table">
            <thead>
              <tr>
                <th></th>
                <th>Nombre</th>
                <th>Elementos</th>
                ${isArchivedTab ? '<th>Creada</th><th>Archivada</th>' : ''}
                ${hasShared ? '<th>Propietario</th>' : ''}
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${lists.map(list => {
                const isOwner = list.ownerId === currentUser.uid;
                const listUrl = isOwner
                  ? `/app/list?id=${list.id}`
                  : `/app/list?id=${list.id}&owner=${list.ownerId}`;
                const sharedBadge = isSharedList(list)
                  ? `<span class="shared-badge">Compartida</span>`
                  : '';

                return `
                  <tr>
                    <td class="icon-cell"><a href="${listUrl}">${renderIcon(list)}</a></td>
                    <td class="name-cell">
                      <a href="${listUrl}">
                        ${list.name}
                        ${list.members?.length > 1 ? `<span class="members-badge">üë• ${list.members.length}</span>` : ''}
                        ${!isOwner ? `<span class="owner-badge">De ${list.ownerName || 'otra persona'}</span>` : ''}
                        ${sharedBadge}
                      </a>
                    </td>
                    <td class="count-cell"><a href="${listUrl}">${list.itemCount || 0}</a></td>
                    ${isArchivedTab ? `
                      <td class="date-cell"><a href="${listUrl}">${formatDate(list.createdAt)}</a></td>
                      <td class="date-cell"><a href="${listUrl}">${formatDate(list.archivedAt)}</a></td>
                    ` : ''}
                    ${hasShared ? `<td class="owner-cell"><a href="${listUrl}">${list.ownerName || ''}</a></td>` : ''}
                    <td class="actions-cell">${renderActionButtons(list, isOwner)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      // Vista grid (iconos)
      container.innerHTML = `
        <div class="lists-grid">
          ${lists.map(list => {
            const isOwner = list.ownerId === currentUser.uid;
            const listUrl = isOwner
              ? `/app/list?id=${list.id}`
              : `/app/list?id=${list.id}&owner=${list.ownerId}`;
            const sharedBadge = isSharedList(list)
              ? `<span class="shared-badge">Compartida</span>`
              : '';

            return `
              <div class="list-card-wrapper">
                <a href="${listUrl}" class="list-card">
                  <div class="list-card-icon">${renderIcon(list)}</div>
                  <div class="list-card-name">${list.name}</div>
                  ${!isOwner ? `
                    <div class="list-card-owner">
                      <span class="owner-badge">De ${list.ownerName}</span>
                    </div>
                  ` : ''}
                  ${sharedBadge ? `
                    <div class="list-card-owner">
                      ${sharedBadge}
                    </div>
                  ` : ''}
                  <div class="list-card-meta">
                    ${!isArchivedTab ? `<span>${list.itemCount || 0} elementos</span>` : ''}
                    ${list.members?.length > 1 ? `<span class="members-badge">üë• ${list.members.length}</span>` : ''}
                  </div>
                  ${isArchivedTab ? `
                    <div class="list-card-dates">
                      <span class="date-label">Creada: ${formatDate(list.createdAt)}</span>
                      <span class="date-label">Archivada: ${formatDate(list.archivedAt)}</span>
                    </div>
                  ` : ''}
                </a>
                ${renderActionButtons(list, isOwner)}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Configurar listeners para los botones de acci√≥n
    setupActionListeners();
  }
</script>

<style is:global>
  .lists-page {
    max-width: 800px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .page-header h1 {
    margin-bottom: var(--space-xs);
  }

  .page-header p {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  /* Tabs row */
  .tabs-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: var(--space-xs);
  }

  /* View toggle */
  .view-toggle {
    display: flex;
    background: var(--color-bg-secondary);
    border-radius: 0.375rem;
    padding: 0.125rem;
    margin-bottom: -1px;
  }

  .view-toggle-btn {
    padding: 0.375rem 0.5rem;
    border: none;
    background: transparent;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 1rem;
    color: var(--color-text-secondary);
    transition: all 0.15s ease;
    line-height: 1;
  }

  .view-toggle-btn:hover {
    color: var(--color-text);
  }

  .view-toggle-btn.active {
    background: var(--color-bg);
    color: var(--color-primary);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .shared-badge {
    font-size: var(--font-size-xs);
    color: #0f766e;
    background: rgba(13, 148, 136, 0.12);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    margin-left: var(--space-xs);
  }

  .tab {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: -1px;
  }

  .tab:hover {
    color: var(--color-text);
  }

  .tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    font-size: 11px;
    font-weight: 600;
    background: var(--color-primary);
    color: white;
    border-radius: 9px;
  }

  /* Grid de listas */
  .lists-container {
    min-height: 200px;
  }

  .lists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-md);
  }

  .list-card-wrapper {
    position: relative;
  }

  .list-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-lg) var(--space-md);
    padding-bottom: calc(var(--space-lg) + 40px);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
    text-align: center;
  }

  .list-card:hover {
    border-color: var(--color-text);
    transform: translateY(-2px);
  }

  .list-card-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-sm);
  }

  .list-card-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
    line-height: 1.3;
  }

  .list-card-owner {
    margin-bottom: var(--space-xs);
  }

  .owner-badge {
    font-size: var(--font-size-xs);
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  .list-card-meta {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .members-badge {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  /* Botones de acci√≥n en grid */
  .list-card-wrapper .list-actions-group {
    position: absolute;
    bottom: var(--space-sm);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
  }

  .list-action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-secondary);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .list-action-btn:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .list-action-btn.active {
    background: var(--color-text-secondary);
    border-color: var(--color-text-secondary);
    color: white;
  }

  .list-action-btn.danger:hover {
    background: #dc2626;
    border-color: #dc2626;
    color: white;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-2xl) var(--space-lg);
    color: var(--color-text-secondary);
  }

  .empty-state p {
    margin-bottom: var(--space-lg);
  }

  @media (max-width: 480px) {
    .lists-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .list-card {
      padding: var(--space-md);
      padding-bottom: calc(var(--space-md) + 40px);
    }

    .list-card-icon {
      font-size: 2rem;
    }
  }

  /* Table view styles */
  .lists-table-wrapper {
    overflow-x: auto;
  }

  .lists-table {
    width: 100%;
    border-collapse: collapse;
  }

  .lists-table th,
  .lists-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .lists-table th {
    font-weight: 500;
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    background: var(--color-bg-secondary);
  }

  .lists-table tbody tr {
    transition: background 0.15s ease;
  }

  .lists-table tbody tr:hover {
    background: var(--color-bg-secondary);
  }

  .lists-table .icon-cell a,
  .lists-table .name-cell a,
  .lists-table .count-cell a,
  .lists-table .owner-cell a {
    color: inherit;
    text-decoration: none;
    display: block;
    width: 100%;
    height: 100%;
  }

  .lists-table .icon-cell,
  .lists-table .name-cell,
  .lists-table .count-cell,
  .lists-table .owner-cell {
    cursor: pointer;
  }

  .lists-table .icon-cell {
    width: 50px;
    font-size: 1.5rem;
    text-align: center;
  }

  .list-icon-img {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    object-fit: cover;
  }

  .list-card-icon .list-icon-img {
    width: 48px;
    height: 48px;
  }

  .lists-table .name-cell {
    font-weight: 500;
  }

  .lists-table .name-cell .members-badge {
    margin-left: var(--space-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .lists-table .count-cell {
    color: var(--color-text-secondary);
    white-space: nowrap;
  }

  .lists-table .owner-cell {
    color: var(--color-text-secondary);
  }

  .lists-table .date-cell {
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
    white-space: nowrap;
  }

  .lists-table .date-cell a {
    color: inherit;
    text-decoration: none;
  }

  /* Fechas en cards */
  .list-card-dates {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: var(--space-xs);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .list-card-dates .date-label {
    display: block;
  }

  .lists-table .actions-cell {
    width: 150px;
    text-align: right;
  }

  .lists-table .actions-cell .list-actions-group {
    display: inline-flex;
    gap: 4px;
    justify-content: flex-end;
  }

  @media (max-width: 480px) {
    .tabs-row {
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .view-toggle {
      order: -1;
      width: 100%;
      justify-content: flex-end;
      margin-bottom: var(--space-sm);
    }

    .lists-table .actions-cell {
      width: auto;
    }

    .list-action-btn {
      width: 28px;
      height: 28px;
    }

    .list-action-btn svg {
      width: 14px;
      height: 14px;
    }
  }

  /* Modal de confirmaci√≥n */
  .confirm-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-md);
  }

  .confirm-modal[hidden] {
    display: none;
  }

  .confirm-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
  }

  .confirm-modal-content {
    position: relative;
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    animation: modal-enter 0.2s ease-out;
  }

  @keyframes modal-enter {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .confirm-modal-icon {
    font-size: 3rem;
    margin-bottom: var(--space-md);
  }

  .confirm-modal-content h3 {
    margin-bottom: var(--space-sm);
    font-size: var(--font-size-lg);
  }

  .confirm-modal-content p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
  }

  .confirm-modal-warning {
    font-size: var(--font-size-sm);
    color: #dc2626;
  }

  .confirm-modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    margin-top: var(--space-lg);
  }

  .confirm-modal-actions .btn {
    min-width: 100px;
  }

  .btn-danger {
    background: #dc2626;
    color: white;
    border: none;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }
</style>
