---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Nueva Lista">
  <div class="new-list-page">
    <a href="/app" class="back-link">‚Üê Volver</a>

    <h1>Crear Nueva Lista</h1>

    <form id="new-list-form" class="form">
      <!-- Icono y Nombre -->
      <div class="form-row icon-name-row">
        <div class="form-group icon-group">
          <label>Icono</label>
          <button type="button" id="icon-selector-btn" class="icon-selector-btn">
            <span id="selected-icon">üõí</span>
          </button>
          <input type="hidden" id="icon" value="üõí" />
        </div>
        <div class="form-group name-group">
          <label for="name">Nombre de la lista *</label>
          <input type="text" id="name" required placeholder="Ej: Compra semanal" />
        </div>
      </div>

      <!-- Selector de iconos (modal) -->
      <div id="icon-picker" class="icon-picker" hidden>
        <div class="icon-grid">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <!-- Tipo de lista -->
      <div class="form-group">
        <label>Tipo de lista</label>
        <div class="list-type-options">
          <label class="list-type-option">
            <input type="radio" name="listType" value="shopping" checked />
            <div class="list-type-card">
              <span class="list-type-icon">üõí</span>
              <div class="list-type-info">
                <strong>Lista de Compra</strong>
                <small>Productos con cantidades, unidades y precios</small>
              </div>
            </div>
          </label>
          <label class="list-type-option">
            <input type="radio" name="listType" value="agnostic" />
            <div class="list-type-card">
              <span class="list-type-icon">üìù</span>
              <div class="list-type-info">
                <strong>Lista General</strong>
                <small>Items con notas y prioridad, sin costes</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Tipo de gasto (solo para listas de compra) -->
      <div class="form-group" id="expense-type-group">
        <label>Tipo de gasto</label>
        <div class="expense-type-options">
          <label class="expense-option">
            <input type="radio" name="expenseType" value="common" checked />
            <div class="expense-card">
              <span class="expense-icon">üè†</span>
              <div class="expense-info">
                <strong>Gasto Com√∫n</strong>
                <small>Se paga de un fondo com√∫n del grupo</small>
              </div>
            </div>
          </label>
          <label class="expense-option">
            <input type="radio" name="expenseType" value="shared" />
            <div class="expense-card">
              <span class="expense-icon">‚ûó</span>
              <div class="expense-info">
                <strong>Gasto a dividir</strong>
                <small>Se divide entre los miembros seleccionados</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Miembros -->
      <div class="form-group">
        <label>Compartir con miembros</label>
        <div id="members-container" class="members-container">
          <p class="loading-text">Cargando miembros...</p>
        </div>
        <small class="form-help">Selecciona qu√© miembros del grupo pueden ver y editar esta lista</small>
      </div>

      <!-- Tienda (opcional, solo para listas de compra) -->
      <div class="form-group" id="store-group">
        <label for="store">Tienda (opcional)</label>
        <input type="text" id="store" placeholder="Ej: Mercadona, Carrefour..." />
      </div>

      <!-- Opciones avanzadas -->
      <details class="advanced-options">
        <summary>Opciones avanzadas</summary>
        <div class="advanced-content">
          <div class="form-group">
            <label for="date">Fecha programada</label>
            <input type="date" id="date" />
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="recurring" />
              Lista recurrente
            </label>
          </div>

          <div id="recurring-options" class="recurring-options" hidden>
            <div class="form-group">
              <label for="frequency">Frecuencia</label>
              <select id="frequency">
                <option value="weekly">Semanal</option>
                <option value="biweekly">Quincenal</option>
                <option value="monthly">Mensual</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <div class="form-actions">
        <a href="/app" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary" id="submit-btn">Crear lista</button>
      </div>
    </form>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { toast } from '/js/toast.js';
  import { getCurrentGroupId, getGroup } from '/js/group.js';
  import { createList } from '/js/lists.js';

  // Iconos disponibles seg√∫n tipo de lista
  const SHOPPING_ICONS = [
    'üõí', 'üõçÔ∏è', 'üè™', 'üè¨', 'üõµ', 'üì¶',
    'ü•ó', 'üçé', 'ü•©', 'üßÄ', 'ü•ñ', 'üç™',
    'üßπ', 'üß¥', 'üíä', 'üêï', 'üéÅ', 'üéÑ'
  ];

  const GENERAL_ICONS = [
    'üìù', '‚úÖ', 'üìã', 'üéØ', 'üí°', '‚≠ê',
    '‚úàÔ∏è', '‚õ∫', 'üèïÔ∏è', 'üéí', 'üß≥', 'üó∫Ô∏è',
    'üíª', 'üì±', 'üéÆ', '‚öΩ', 'üèÉ', 'üö¥',
    'üè†', 'üîß', 'üìö', '‚úèÔ∏è', 'üíº', 'üìÑ'
  ];

  let currentListType = 'shopping';

  let groupMembers = [];
  let selectedMembers = [];
  let currentUser = null;

  // Inicializar selector de iconos
  const iconGrid = document.querySelector('.icon-grid');
  const iconPicker = document.getElementById('icon-picker');
  const iconSelectorBtn = document.getElementById('icon-selector-btn');
  const selectedIconSpan = document.getElementById('selected-icon');
  const iconInput = document.getElementById('icon');
  const nameInput = document.getElementById('name');

  // Funci√≥n para actualizar el grid de iconos seg√∫n el tipo de lista
  function updateIconGrid(listType) {
    const icons = listType === 'shopping' ? SHOPPING_ICONS : GENERAL_ICONS;
    const defaultIcon = listType === 'shopping' ? 'üõí' : 'üìù';

    iconGrid.innerHTML = '';
    icons.forEach(icon => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'icon-option';
      btn.textContent = icon;
      btn.addEventListener('click', () => {
        selectedIconSpan.textContent = icon;
        iconInput.value = icon;
        iconPicker.hidden = true;
        document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
      if (icon === defaultIcon) btn.classList.add('selected');
      iconGrid.appendChild(btn);
    });

    // Actualizar icono seleccionado por defecto
    selectedIconSpan.textContent = defaultIcon;
    iconInput.value = defaultIcon;

    // Actualizar placeholder del nombre
    nameInput.placeholder = listType === 'shopping'
      ? 'Ej: Compra semanal'
      : 'Ej: Cosas para el viaje';
  }

  // Inicializar con tipo shopping
  updateIconGrid('shopping');

  iconSelectorBtn.addEventListener('click', () => {
    iconPicker.hidden = !iconPicker.hidden;
  });

  // Cerrar picker al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!iconPicker.contains(e.target) && e.target !== iconSelectorBtn && !iconSelectorBtn.contains(e.target)) {
      iconPicker.hidden = true;
    }
  });

  // Manejar cambio de tipo de lista
  const expenseTypeGroup = document.getElementById('expense-type-group');
  const storeGroup = document.getElementById('store-group');
  const listTypeRadios = document.querySelectorAll('input[name="listType"]');

  listTypeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      currentListType = e.target.value;
      const isShopping = currentListType === 'shopping';

      // Mostrar/ocultar campos espec√≠ficos de listas de compra
      expenseTypeGroup.hidden = !isShopping;
      storeGroup.hidden = !isShopping;

      // Actualizar iconos disponibles
      updateIconGrid(currentListType);
    });
  });

  // Cargar miembros del grupo actual
  async function initPage(user) {
    currentUser = user;
    const membersContainer = document.getElementById('members-container');
    if (!membersContainer) return;

    const groupId = getCurrentGroupId();

    if (!groupId) {
      membersContainer.innerHTML = `
        <div class="no-group">
          <p>No tienes un grupo activo.</p>
          <a href="/app/groups" class="btn btn-sm">Ir a grupos</a>
        </div>
      `;
      return;
    }

    try {
      const group = await getGroup(groupId);

      if (!group || !group.members) {
        membersContainer.innerHTML = '<p class="error-text">Error al cargar el grupo</p>';
        return;
      }

      // Convertir miembros a array, excluyendo al usuario actual
      groupMembers = Object.entries(group.members)
        .filter(([uid]) => uid !== currentUser.uid)
        .map(([uid, data]) => ({
          uid,
          name: data.displayName || data.email?.split('@')[0] || 'Usuario',
          photoURL: data.photoURL
        }));

      if (groupMembers.length === 0) {
        membersContainer.innerHTML = `
          <div class="no-members">
            <p>No hay otros miembros en el grupo.</p>
            <small>Invita a alguien desde la gesti√≥n del grupo.</small>
          </div>
        `;
        return;
      }

      membersContainer.innerHTML = `
        <div class="members-list">
          ${groupMembers.map(member => `
            <label class="member-checkbox">
              <input type="checkbox" name="members" value="${member.uid}" />
              <div class="member-info">
                <div class="member-avatar-small">
                  ${member.photoURL
                    ? `<img src="${member.photoURL}" alt="">`
                    : `<span>${member.name[0].toUpperCase()}</span>`
                  }
                </div>
                <span class="member-name">${member.name}</span>
              </div>
            </label>
          `).join('')}
        </div>
      `;

      // Manejar selecci√≥n de miembros
      membersContainer.querySelectorAll('input[name="members"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          selectedMembers = Array.from(membersContainer.querySelectorAll('input[name="members"]:checked'))
            .map(cb => cb.value);
        });
      });
    } catch (error) {
      console.error('Error loading members:', error);
      membersContainer.innerHTML = '<p class="error-text">Error al cargar miembros</p>';
    }
  }

  // Comprobar estado de auth
  if (isAuthResolved()) {
    const user = getCurrentUser();
    if (user) initPage(user);
  } else {
    window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
  }

  // Lista recurrente
  const recurringCheckbox = document.getElementById('recurring');
  const recurringOptions = document.getElementById('recurring-options');

  recurringCheckbox.addEventListener('change', () => {
    recurringOptions.hidden = !recurringCheckbox.checked;
  });

  // Enviar formulario
  const form = document.getElementById('new-list-form');
  const submitBtn = document.getElementById('submit-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentUser) {
      toast.error('Debes iniciar sesi√≥n');
      return;
    }

    const name = document.getElementById('name').value.trim();
    if (!name) {
      toast.warning('El nombre es obligatorio');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Creando...';

    const icon = document.getElementById('icon').value;
    const store = document.getElementById('store').value.trim();
    const date = document.getElementById('date').value;
    const isRecurring = recurringCheckbox.checked;
    const frequency = document.getElementById('frequency').value;
    const listType = document.querySelector('input[name="listType"]:checked').value;

    // expenseType solo aplica a listas de compra
    const expenseType = listType === 'shopping'
      ? document.querySelector('input[name="expenseType"]:checked').value
      : null;

    try {
      // Crear lista usando el servicio
      const newList = await createList({
        name,
        icon,
        listType,
        store: listType === 'shopping' ? (store || null) : null,
        expenseType,
        groupIds: getCurrentGroupId() ? [getCurrentGroupId()] : [],
        scheduledDate: date || null,
        isRecurring,
        recurringPattern: isRecurring ? { frequency } : null
      }, selectedMembers);

      window.location.href = `/app/list?id=${newList.id}`;
    } catch (error) {
      console.error('Error creating list:', error);
      toast.error('Error al crear la lista: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Crear lista';
    }
  });
</script>

<style is:global>
  .new-list-page {
    max-width: 560px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  h1 {
    margin-bottom: var(--space-xl);
  }

  .form-group {
    margin-bottom: var(--space-lg);
  }

  .form-group > label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
  }

  .form-row {
    display: flex;
    gap: var(--space-md);
  }

  .icon-name-row {
    align-items: flex-end;
  }

  .icon-group {
    flex-shrink: 0;
  }

  .name-group {
    flex: 1;
  }

  .icon-selector-btn {
    width: 56px;
    height: 42px;
    font-size: 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .icon-selector-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .icon-picker {
    position: relative;
    margin-top: calc(-1 * var(--space-md));
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
  }

  .icon-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--space-xs);
  }

  .icon-option {
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
    border: 2px solid transparent;
    border-radius: var(--radius-sm);
    background: var(--color-bg-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .icon-option:hover {
    background: var(--color-bg-tertiary);
    transform: scale(1.1);
  }

  .icon-option.selected {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
  }

  /* Tipo de lista */
  .list-type-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-sm);
  }

  .list-type-option {
    cursor: pointer;
  }

  .list-type-option input {
    display: none;
  }

  .list-type-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-lg) var(--space-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    text-align: center;
  }

  .list-type-option input:checked + .list-type-card {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
  }

  .list-type-card:hover {
    border-color: var(--color-primary);
  }

  .list-type-icon {
    font-size: 2rem;
  }

  .list-type-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .list-type-info strong {
    font-size: var(--font-size-base);
  }

  .list-type-info small {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  /* Tipo de gasto */
  .expense-type-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .expense-option {
    cursor: pointer;
  }

  .expense-option input {
    display: none;
  }

  .expense-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .expense-option input:checked + .expense-card {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
  }

  .expense-card:hover {
    border-color: var(--color-primary);
  }

  .expense-icon {
    font-size: 1.5rem;
  }

  .expense-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .expense-info strong {
    font-size: var(--font-size-base);
  }

  .expense-info small {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  /* Miembros */
  .members-container {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .members-list {
    display: flex;
    flex-direction: column;
  }

  .member-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .member-checkbox:not(:last-child) {
    border-bottom: 1px solid var(--color-border);
  }

  .member-checkbox:hover {
    background: var(--color-bg-secondary);
  }

  .member-checkbox:has(input:checked) {
    background: rgba(37, 99, 235, 0.05);
  }

  .member-checkbox:has(input:checked) .member-name {
    font-weight: 500;
  }

  .member-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .member-avatar-small {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--color-text-tertiary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    overflow: hidden;
  }

  .member-avatar-small img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .no-group,
  .no-members {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .no-group p,
  .no-members p {
    margin-bottom: var(--space-xs);
  }

  .no-members small {
    font-size: var(--font-size-xs);
  }

  .form-help {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .no-groups {
    padding: var(--space-md);
    text-align: center;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
  }

  .no-groups p {
    margin-bottom: var(--space-sm);
    color: var(--color-text-secondary);
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--font-size-sm);
  }

  /* Inputs */
  .form-group input[type="text"],
  .form-group input[type="date"],
  .form-group select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* Opciones avanzadas */
  .advanced-options {
    margin-bottom: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .advanced-options summary {
    padding: var(--space-md);
    cursor: pointer;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .advanced-options summary:hover {
    color: var(--color-text);
  }

  .advanced-content {
    padding: 0 var(--space-md) var(--space-md);
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
  }

  .recurring-options {
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    margin-top: var(--space-sm);
  }

  .recurring-options .form-group {
    margin-bottom: 0;
  }

  /* Actions */
  .form-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .loading-text,
  .error-text {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .error-text {
    color: var(--color-danger);
  }

  @media (max-width: 480px) {
    .icon-grid {
      grid-template-columns: repeat(5, 1fr);
    }

    .expense-card {
      padding: var(--space-sm);
    }
  }
</style>
