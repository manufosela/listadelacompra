---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Nueva Lista">
  <div class="new-list-page">
    <a href="/app/lists" class="back-link">‚Üê Volver</a>

    <h1>Crear Nueva Lista</h1>

    <form id="new-list-form" class="form">
      <!-- Icono y Nombre -->
      <div class="form-row icon-name-row">
        <div class="form-group icon-group">
          <label>Icono</label>
          <div class="icon-selector-wrapper">
            <button type="button" id="icon-selector-btn" class="icon-selector-btn">
              <span id="selected-icon">üõí</span>
              <img id="icon-preview" class="icon-preview" hidden alt="Icono personalizado" />
            </button>
            <label class="upload-icon-btn" title="Subir imagen personalizada">
              <input type="file" id="icon-file" accept="image/*" hidden />
              üì∑
            </label>
          </div>
          <input type="hidden" id="icon" value="üõí" />
          <input type="hidden" id="icon-url" value="" />
        </div>
        <div class="form-group name-group">
          <label for="name">Nombre de la lista *</label>
          <input type="text" id="name" required placeholder="Ej: Compra semanal" />
        </div>
      </div>

      <!-- Selector de iconos (modal) -->
      <div id="icon-picker" class="icon-picker" hidden>
        <div class="icon-grid">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <!-- Tipo de lista -->
      <div class="form-group">
        <label>Tipo de lista</label>
        <div class="list-type-options">
          <label class="list-type-option">
            <input type="radio" name="listType" value="shopping" checked />
            <div class="list-type-card">
              <span class="list-type-icon">üõí</span>
              <div class="list-type-info">
                <strong>Lista de Compra</strong>
                <small>Productos con cantidades, unidades y precios</small>
              </div>
            </div>
          </label>
          <label class="list-type-option">
            <input type="radio" name="listType" value="agnostic" />
            <div class="list-type-card">
              <span class="list-type-icon">üìù</span>
              <div class="list-type-info">
                <strong>Lista General</strong>
                <small>Items con notas y prioridad, sin costes</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Tipo de gasto (solo para listas de compra) -->
      <div class="form-group" id="expense-type-group">
        <label>Tipo de gasto</label>
        <div class="expense-type-options">
          <label class="expense-option">
            <input type="radio" name="expenseType" value="common" checked />
            <div class="expense-card">
              <span class="expense-icon">üè†</span>
              <div class="expense-info">
                <strong>Gasto Com√∫n</strong>
                <small>Se paga de un fondo com√∫n del grupo</small>
              </div>
            </div>
          </label>
          <label class="expense-option">
            <input type="radio" name="expenseType" value="shared" />
            <div class="expense-card">
              <span class="expense-icon">‚ûó</span>
              <div class="expense-info">
                <strong>Gasto a dividir</strong>
                <small>Se divide entre los miembros seleccionados</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Miembros -->
      <div class="form-group">
        <label>Compartir con miembros</label>
        <div id="members-container" class="members-container">
          <p class="loading-text">Cargando miembros...</p>
        </div>
        <small class="form-help">Selecciona qu√© miembros del grupo pueden ver y editar esta lista</small>
      </div>

      <!-- Productos del cat√°logo (solo para listas de compra) -->
      <div class="form-group" id="products-group">
        <label>Productos iniciales</label>
        <button type="button" id="add-products-btn" class="add-products-btn">
          <span class="add-products-icon">üì¶</span>
          <span class="add-products-text">A√±adir productos del cat√°logo</span>
          <span id="selected-products-count" class="selected-count" hidden>0</span>
        </button>
        <small class="form-help">Selecciona productos de tu cat√°logo para a√±adirlos a la lista</small>
      </div>

      <!-- Tienda (opcional, solo para listas de compra) -->
      <div class="form-group" id="store-group">
        <label for="store">Tienda (opcional)</label>
        <input type="text" id="store" placeholder="Ej: Mercadona, Carrefour..." />
      </div>

      <!-- Opciones avanzadas -->
      <details class="advanced-options">
        <summary>Opciones avanzadas</summary>
        <div class="advanced-content">
          <div class="form-group">
            <label for="date">Fecha programada</label>
            <input type="date" id="date" />
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="recurring" />
              Lista recurrente
            </label>
          </div>

          <div id="recurring-options" class="recurring-options" hidden>
            <div class="form-group">
              <label for="frequency">Frecuencia</label>
              <select id="frequency">
                <option value="weekly">Semanal</option>
                <option value="biweekly">Quincenal</option>
                <option value="monthly">Mensual</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <div class="form-actions">
        <a href="/app/lists" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary" id="submit-btn">Crear lista</button>
      </div>
    </form>

    <!-- Modal de productos del cat√°logo -->
    <div id="products-modal" class="modal" hidden>
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Seleccionar productos</h2>
          <button type="button" class="modal-close" id="close-products-modal">&times;</button>
        </div>
        <div class="modal-search">
          <input type="text" id="product-search" placeholder="Buscar producto..." />
        </div>
        <div class="modal-body" id="products-list">
          <p class="loading-text">Cargando productos...</p>
        </div>
        <div class="modal-footer">
          <span id="modal-selected-count">0 productos seleccionados</span>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-products-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirm-products-btn">Confirmar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { toast } from '/js/toast.js';
  import { getCurrentGroupId, getGroup } from '/js/group.js';
  import { createList } from '/js/lists.js';
  import { uploadListIcon, resizeImage } from '/js/storage.js';
  import { navigateTo } from '/js/navigate.js';
  import { getAllProducts, UNITS } from '/js/db.js';
  import { getCategoriesForList, DEFAULT_SHOPPING_CATEGORIES } from '/js/categories.js';

  // Iconos disponibles seg√∫n tipo de lista
  const SHOPPING_ICONS = [
    'üõí', 'üõçÔ∏è', 'üè™', 'üè¨', 'üõµ', 'üì¶',
    'ü•ó', 'üçé', 'ü•©', 'üßÄ', 'ü•ñ', 'üç™',
    'üßπ', 'üß¥', 'üíä', 'üêï', 'üéÅ', 'üéÑ'
  ];

  const GENERAL_ICONS = [
    'üìù', '‚úÖ', 'üìã', 'üéØ', 'üí°', '‚≠ê',
    '‚úàÔ∏è', '‚õ∫', 'üèïÔ∏è', 'üéí', 'üß≥', 'üó∫Ô∏è',
    'üíª', 'üì±', 'üéÆ', '‚öΩ', 'üèÉ', 'üö¥',
    'üè†', 'üîß', 'üìö', '‚úèÔ∏è', 'üíº', 'üìÑ'
  ];

  let currentListType = 'shopping';

  let groupMembers = [];
  let selectedMembers = [];
  let currentUser = null;

  // Estado para productos del cat√°logo
  let catalogProducts = [];
  let selectedProducts = {}; // { productId: { product, quantity, unit } }
  let productCategories = [];

  // Inicializar selector de iconos
  const iconGrid = document.querySelector('.icon-grid');
  const iconPicker = document.getElementById('icon-picker');
  const iconSelectorBtn = document.getElementById('icon-selector-btn');
  const selectedIconSpan = document.getElementById('selected-icon');
  const iconInput = document.getElementById('icon');
  const iconUrlInput = document.getElementById('icon-url');
  const iconFileInput = document.getElementById('icon-file');
  const iconPreview = document.getElementById('icon-preview');
  const nameInput = document.getElementById('name');

  let selectedImageFile = null;

  // Manejar subida de imagen
  iconFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      // Validar tipo
      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        toast.error('Tipo de archivo no v√°lido. Usa JPG, PNG, GIF o WebP.');
        return;
      }

      // Validar tama√±o (m√°ximo 2MB)
      if (file.size > 2 * 1024 * 1024) {
        toast.error('La imagen es demasiado grande. M√°ximo 2MB.');
        return;
      }

      // Redimensionar y mostrar previsualizaci√≥n
      const resizedBlob = await resizeImage(file);
      selectedImageFile = new File([resizedBlob], 'icon.webp', { type: 'image/webp' });

      // Mostrar previsualizaci√≥n
      iconPreview.src = URL.createObjectURL(resizedBlob);
      iconPreview.hidden = false;
      selectedIconSpan.hidden = true;
      iconInput.value = ''; // Limpiar emoji seleccionado

      toast.success('Imagen seleccionada');
    } catch (error) {
      console.error('Error processing image:', error);
      toast.error('Error al procesar la imagen');
    }
  });

  // Al seleccionar un emoji, quitar la imagen
  function selectEmoji(emoji) {
    selectedIconSpan.textContent = emoji;
    selectedIconSpan.hidden = false;
    iconInput.value = emoji;
    iconPreview.hidden = true;
    selectedImageFile = null;
    iconUrlInput.value = '';
  }

  // Funci√≥n para actualizar el grid de iconos seg√∫n el tipo de lista
  function updateIconGrid(listType) {
    const icons = listType === 'shopping' ? SHOPPING_ICONS : GENERAL_ICONS;
    const defaultIcon = listType === 'shopping' ? 'üõí' : 'üìù';

    iconGrid.innerHTML = '';
    icons.forEach(icon => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'icon-option';
      btn.textContent = icon;
      btn.addEventListener('click', () => {
        selectEmoji(icon);
        iconPicker.hidden = true;
        document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
      if (icon === defaultIcon) btn.classList.add('selected');
      iconGrid.appendChild(btn);
    });

    // Actualizar icono seleccionado por defecto (solo si no hay imagen)
    if (!selectedImageFile) {
      selectEmoji(defaultIcon);
    }

    // Actualizar placeholder del nombre
    nameInput.placeholder = listType === 'shopping'
      ? 'Ej: Compra semanal'
      : 'Ej: Cosas para el viaje';
  }

  // Inicializar con tipo shopping
  updateIconGrid('shopping');

  iconSelectorBtn.addEventListener('click', () => {
    iconPicker.hidden = !iconPicker.hidden;
  });

  // Cerrar picker al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!iconPicker.contains(e.target) && e.target !== iconSelectorBtn && !iconSelectorBtn.contains(e.target)) {
      iconPicker.hidden = true;
    }
  });

  // Manejar cambio de tipo de lista
  const expenseTypeGroup = document.getElementById('expense-type-group');
  const storeGroup = document.getElementById('store-group');
  const productsGroup = document.getElementById('products-group');
  const listTypeRadios = document.querySelectorAll('input[name="listType"]');

  listTypeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      currentListType = e.target.value;
      const isShopping = currentListType === 'shopping';

      // Mostrar/ocultar campos espec√≠ficos de listas de compra
      expenseTypeGroup.hidden = !isShopping;
      storeGroup.hidden = !isShopping;
      productsGroup.hidden = !isShopping;

      // Actualizar iconos disponibles
      updateIconGrid(currentListType);
    });
  });

  // Cargar miembros del grupo actual
  async function initPage(user) {
    currentUser = user;
    const membersContainer = document.getElementById('members-container');
    if (!membersContainer) return;

    const groupId = getCurrentGroupId();

    if (!groupId) {
      membersContainer.innerHTML = `
        <div class="no-group">
          <p>No tienes un grupo activo.</p>
          <a href="/app/groups" class="btn btn-sm">Ir a grupos</a>
        </div>
      `;
      return;
    }

    try {
      const group = await getGroup(groupId);

      if (!group || !group.members) {
        membersContainer.innerHTML = '<p class="error-text">Error al cargar el grupo</p>';
        return;
      }

      // Convertir miembros a array, excluyendo al usuario actual
      groupMembers = Object.entries(group.members)
        .filter(([uid]) => uid !== currentUser.uid)
        .map(([uid, data]) => ({
          uid,
          name: data.displayName || data.email?.split('@')[0] || 'Usuario',
          photoURL: data.photoURL
        }));

      if (groupMembers.length === 0) {
        membersContainer.innerHTML = `
          <div class="no-members">
            <p>No hay otros miembros en el grupo.</p>
            <small>Invita a alguien desde la gesti√≥n del grupo.</small>
          </div>
        `;
        return;
      }

      membersContainer.innerHTML = `
        <div class="members-list">
          ${groupMembers.map(member => `
            <label class="member-checkbox">
              <input type="checkbox" name="members" value="${member.uid}" />
              <div class="member-info">
                <div class="member-avatar-small">
                  ${member.photoURL
                    ? `<img src="${member.photoURL}" alt="">`
                    : `<span>${member.name[0].toUpperCase()}</span>`
                  }
                </div>
                <span class="member-name">${member.name}</span>
              </div>
            </label>
          `).join('')}
        </div>
      `;

      // Manejar selecci√≥n de miembros
      membersContainer.querySelectorAll('input[name="members"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          selectedMembers = Array.from(membersContainer.querySelectorAll('input[name="members"]:checked'))
            .map(cb => cb.value);
        });
      });
    } catch (error) {
      console.error('Error loading members:', error);
      membersContainer.innerHTML = '<p class="error-text">Error al cargar miembros</p>';
    }
  }

  // Comprobar estado de auth
  if (isAuthResolved()) {
    const user = getCurrentUser();
    if (user) initPage(user);
  } else {
    window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
  }

  // Lista recurrente
  const recurringCheckbox = document.getElementById('recurring');
  const recurringOptions = document.getElementById('recurring-options');

  recurringCheckbox.addEventListener('change', () => {
    recurringOptions.hidden = !recurringCheckbox.checked;
  });

  // ========== Modal de productos del cat√°logo ==========
  const productsModal = document.getElementById('products-modal');
  const addProductsBtn = document.getElementById('add-products-btn');
  const closeProductsModal = document.getElementById('close-products-modal');
  const cancelProductsBtn = document.getElementById('cancel-products-btn');
  const confirmProductsBtn = document.getElementById('confirm-products-btn');
  const productsList = document.getElementById('products-list');
  const productSearch = document.getElementById('product-search');
  const modalSelectedCount = document.getElementById('modal-selected-count');
  const selectedProductsCount = document.getElementById('selected-products-count');

  // Abrir modal
  addProductsBtn.addEventListener('click', async () => {
    productsModal.hidden = false;
    document.body.style.overflow = 'hidden';
    await loadCatalogProducts();
  });

  // Cerrar modal
  function closeModal() {
    productsModal.hidden = true;
    document.body.style.overflow = '';
    productSearch.value = '';
  }

  closeProductsModal.addEventListener('click', closeModal);
  cancelProductsBtn.addEventListener('click', () => {
    // Restaurar selecci√≥n previa
    closeModal();
  });

  productsModal.querySelector('.modal-backdrop').addEventListener('click', closeModal);

  // Cargar productos del cat√°logo
  async function loadCatalogProducts() {
    productsList.innerHTML = '<p class="loading-text">Cargando productos...</p>';

    const groupId = getCurrentGroupId();
    if (!groupId) {
      productsList.innerHTML = `
        <div class="no-products">
          <p>No hay grupo activo</p>
          <small>Debes tener un grupo para ver el cat√°logo de productos</small>
        </div>
      `;
      return;
    }

    try {
      // Cargar productos y categor√≠as en paralelo
      const [products, categories] = await Promise.all([
        getAllProducts(groupId),
        getCategoriesForList(groupId, 'shopping')
      ]);

      catalogProducts = products;
      productCategories = categories;

      if (catalogProducts.length === 0) {
        productsList.innerHTML = `
          <div class="no-products">
            <p>No hay productos en el cat√°logo</p>
            <small>Los productos se a√±aden autom√°ticamente cuando compras</small>
          </div>
        `;
        return;
      }

      renderProductsList();
    } catch (error) {
      console.error('Error loading products:', error);
      productsList.innerHTML = `<p class="error-text">Error al cargar productos: ${error.message}</p>`;
    }
  }

  // Renderizar lista de productos agrupados por categor√≠a
  function renderProductsList(filter = '') {
    const filterLower = filter.toLowerCase();

    // Agrupar productos por categor√≠a
    const grouped = {};
    catalogProducts.forEach(product => {
      if (filter && !product.name.toLowerCase().includes(filterLower)) return;

      const cat = product.category || 'otros';
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(product);
    });

    // Ordenar productos dentro de cada categor√≠a
    Object.values(grouped).forEach(products => {
      products.sort((a, b) => a.name.localeCompare(b.name));
    });

    // Obtener orden de categor√≠as
    const categoryOrder = productCategories.map(c => c.id);

    if (Object.keys(grouped).length === 0) {
      productsList.innerHTML = '<p class="no-results">No se encontraron productos</p>';
      return;
    }

    productsList.innerHTML = Object.entries(grouped)
      .sort(([a], [b]) => {
        const aIdx = categoryOrder.indexOf(a);
        const bIdx = categoryOrder.indexOf(b);
        return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx);
      })
      .map(([categoryId, products]) => {
        const category = productCategories.find(c => c.id === categoryId) ||
          DEFAULT_SHOPPING_CATEGORIES.find(c => c.id === categoryId) ||
          { name: categoryId, icon: 'üì¶' };

        return `
          <div class="product-category-group">
            <div class="product-category-header">
              <span>${category.icon || 'üì¶'} ${category.name}</span>
              <span class="category-count">${products.length}</span>
            </div>
            <div class="product-items">
              ${products.map(product => {
                const selected = selectedProducts[product.id];
                const isChecked = !!selected;
                const quantity = selected?.quantity || 1;
                const unit = selected?.unit || product.defaultUnit || 'unidad';

                return `
                  <div class="product-item ${isChecked ? 'selected' : ''}" data-id="${product.id}">
                    <label class="product-checkbox">
                      <input type="checkbox" ${isChecked ? 'checked' : ''} />
                      <span class="product-name">${product.name}</span>
                    </label>
                    <div class="product-quantity" ${isChecked ? '' : 'hidden'}>
                      <input type="number" min="0.1" step="0.1" value="${quantity}" class="qty-input" />
                      <select class="unit-select">
                        ${UNITS.map(u =>
                          `<option value="${u.id}" ${unit === u.id ? 'selected' : ''}>${u.name}</option>`
                        ).join('')}
                      </select>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');

    // A√±adir event listeners
    productsList.querySelectorAll('.product-item').forEach(item => {
      const productId = item.dataset.id;
      const product = catalogProducts.find(p => p.id === productId);
      const checkbox = item.querySelector('input[type="checkbox"]');
      const quantityDiv = item.querySelector('.product-quantity');
      const qtyInput = item.querySelector('.qty-input');
      const unitSelect = item.querySelector('.unit-select');

      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          selectedProducts[productId] = {
            product,
            quantity: parseFloat(qtyInput.value) || 1,
            unit: unitSelect.value
          };
          item.classList.add('selected');
          quantityDiv.hidden = false;
        } else {
          delete selectedProducts[productId];
          item.classList.remove('selected');
          quantityDiv.hidden = true;
        }
        updateSelectedCount();
      });

      qtyInput.addEventListener('change', () => {
        if (selectedProducts[productId]) {
          selectedProducts[productId].quantity = parseFloat(qtyInput.value) || 1;
        }
      });

      unitSelect.addEventListener('change', () => {
        if (selectedProducts[productId]) {
          selectedProducts[productId].unit = unitSelect.value;
        }
      });
    });
  }

  // B√∫squeda de productos
  productSearch.addEventListener('input', (e) => {
    renderProductsList(e.target.value);
  });

  // Actualizar contador de seleccionados
  function updateSelectedCount() {
    const count = Object.keys(selectedProducts).length;
    modalSelectedCount.textContent = `${count} producto${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;

    if (count > 0) {
      selectedProductsCount.textContent = count;
      selectedProductsCount.hidden = false;
    } else {
      selectedProductsCount.hidden = true;
    }
  }

  // Confirmar selecci√≥n
  confirmProductsBtn.addEventListener('click', () => {
    updateSelectedCount();
    closeModal();
    const count = Object.keys(selectedProducts).length;
    if (count > 0) {
      toast.success(`${count} producto${count !== 1 ? 's' : ''} a√±adido${count !== 1 ? 's' : ''}`);
    }
  });

  // ========== Fin Modal ==========

  // Enviar formulario
  const form = document.getElementById('new-list-form');
  const submitBtn = document.getElementById('submit-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentUser) {
      toast.error('Debes iniciar sesi√≥n');
      return;
    }

    const name = document.getElementById('name').value.trim();
    if (!name) {
      toast.warning('El nombre es obligatorio');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Creando...';

    const icon = document.getElementById('icon').value;
    const store = document.getElementById('store').value.trim();
    const date = document.getElementById('date').value;
    const isRecurring = recurringCheckbox.checked;
    const frequency = document.getElementById('frequency').value;
    const listType = document.querySelector('input[name="listType"]:checked').value;

    // expenseType solo aplica a listas de compra
    const expenseType = listType === 'shopping'
      ? document.querySelector('input[name="expenseType"]:checked').value
      : null;

    try {
      let iconUrl = null;

      // Crear lista primero (necesitamos el ID para subir la imagen)
      const newList = await createList({
        name,
        icon: selectedImageFile ? null : icon, // Solo emoji si no hay imagen
        iconUrl: null, // Se actualizar√° despu√©s si hay imagen
        listType,
        store: listType === 'shopping' ? (store || null) : null,
        expenseType,
        groupIds: getCurrentGroupId() ? [getCurrentGroupId()] : [],
        scheduledDate: date || null,
        isRecurring,
        recurringPattern: isRecurring ? { frequency } : null
      }, selectedMembers);

      // Si hay imagen seleccionada, subirla y actualizar la lista
      if (selectedImageFile) {
        submitBtn.textContent = 'Subiendo imagen...';
        try {
          iconUrl = await uploadListIcon(selectedImageFile, newList.id);
          // Actualizar la lista con la URL de la imagen
          const { updateList } = await import('/js/lists.js');
          await updateList(newList.id, { iconUrl, icon: null });
        } catch (uploadError) {
          console.error('Error uploading icon:', uploadError);
          toast.warning('Lista creada, pero hubo un error al subir la imagen');
        }
      }

      // A√±adir productos seleccionados del cat√°logo
      const selectedProductsList = Object.values(selectedProducts);
      if (selectedProductsList.length > 0) {
        submitBtn.textContent = 'A√±adiendo productos...';
        try {
          const { db } = await import('/js/firebase-config.js');
          const { collection, addDoc, updateDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');

          const itemsRef = collection(db, 'users', currentUser.uid, 'lists', newList.id, 'items');

          for (const { product, quantity, unit } of selectedProductsList) {
            await addDoc(itemsRef, {
              name: product.name,
              quantity: quantity,
              unit: unit,
              category: product.category || 'otros',
              productId: product.id,
              checked: false,
              checkedAt: null,
              checkedBy: null,
              createdAt: serverTimestamp(),
              createdBy: currentUser.uid
            });
          }

          // Actualizar contador de items
          const listRef = doc(db, 'users', currentUser.uid, 'lists', newList.id);
          await updateDoc(listRef, {
            itemCount: selectedProductsList.length,
            updatedAt: serverTimestamp()
          });
        } catch (itemsError) {
          console.error('Error adding items:', itemsError);
          toast.warning('Lista creada, pero hubo un error al a√±adir algunos productos');
        }
      }

      navigateTo(`/app/list?id=${newList.id}`);
    } catch (error) {
      console.error('Error creating list:', error);
      toast.error('Error al crear la lista: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Crear lista';
    }
  });
</script>

<style is:global>
  .new-list-page {
    max-width: 560px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  h1 {
    margin-bottom: var(--space-xl);
  }

  .form-group {
    margin-bottom: var(--space-lg);
  }

  .form-group > label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
  }

  .form-row {
    display: flex;
    gap: var(--space-md);
  }

  .icon-name-row {
    align-items: flex-end;
  }

  .icon-group {
    flex-shrink: 0;
  }

  .name-group {
    flex: 1;
  }

  .icon-selector-wrapper {
    display: flex;
    gap: var(--space-xs);
  }

  .icon-selector-btn {
    width: 56px;
    height: 42px;
    font-size: 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
  }

  .icon-selector-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .icon-preview {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .upload-icon-btn {
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    border: 1px dashed var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .upload-icon-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .icon-picker {
    position: relative;
    margin-top: calc(-1 * var(--space-md));
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
  }

  .icon-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--space-xs);
  }

  .icon-option {
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
    border: 2px solid transparent;
    border-radius: var(--radius-sm);
    background: var(--color-bg-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .icon-option:hover {
    background: var(--color-bg-tertiary);
    transform: scale(1.1);
  }

  .icon-option.selected {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
  }

  /* Tipo de lista */
  .list-type-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-sm);
  }

  .list-type-option {
    cursor: pointer;
  }

  .list-type-option input {
    display: none;
  }

  .list-type-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-lg) var(--space-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
    text-align: center;
  }

  .list-type-option input:checked + .list-type-card {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
  }

  .list-type-card:hover {
    border-color: var(--color-primary);
  }

  .list-type-icon {
    font-size: 2rem;
  }

  .list-type-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .list-type-info strong {
    font-size: var(--font-size-base);
  }

  .list-type-info small {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  /* Tipo de gasto */
  .expense-type-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .expense-option {
    cursor: pointer;
  }

  .expense-option input {
    display: none;
  }

  .expense-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .expense-option input:checked + .expense-card {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
  }

  .expense-card:hover {
    border-color: var(--color-primary);
  }

  .expense-icon {
    font-size: 1.5rem;
  }

  .expense-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .expense-info strong {
    font-size: var(--font-size-base);
  }

  .expense-info small {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  /* Miembros */
  .members-container {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .members-list {
    display: flex;
    flex-direction: column;
  }

  .member-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .member-checkbox:not(:last-child) {
    border-bottom: 1px solid var(--color-border);
  }

  .member-checkbox:hover {
    background: var(--color-bg-secondary);
  }

  .member-checkbox:has(input:checked) {
    background: rgba(37, 99, 235, 0.05);
  }

  .member-checkbox:has(input:checked) .member-name {
    font-weight: 500;
  }

  .member-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .member-avatar-small {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--color-text-tertiary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    overflow: hidden;
  }

  .member-avatar-small img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .no-group,
  .no-members {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .no-group p,
  .no-members p {
    margin-bottom: var(--space-xs);
  }

  .no-members small {
    font-size: var(--font-size-xs);
  }

  .form-help {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .no-groups {
    padding: var(--space-md);
    text-align: center;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
  }

  .no-groups p {
    margin-bottom: var(--space-sm);
    color: var(--color-text-secondary);
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--font-size-sm);
  }

  /* Inputs */
  .form-group input[type="text"],
  .form-group input[type="date"],
  .form-group select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* Opciones avanzadas */
  .advanced-options {
    margin-bottom: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .advanced-options summary {
    padding: var(--space-md);
    cursor: pointer;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .advanced-options summary:hover {
    color: var(--color-text);
  }

  .advanced-content {
    padding: 0 var(--space-md) var(--space-md);
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
  }

  .recurring-options {
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    margin-top: var(--space-sm);
  }

  .recurring-options .form-group {
    margin-bottom: 0;
  }

  /* Actions */
  .form-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .loading-text,
  .error-text {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .error-text {
    color: var(--color-danger);
  }

  @media (max-width: 480px) {
    .icon-grid {
      grid-template-columns: repeat(5, 1fr);
    }

    .expense-card {
      padding: var(--space-sm);
    }
  }

  /* Bot√≥n a√±adir productos */
  .add-products-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    width: 100%;
    padding: var(--space-md);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
  }

  .add-products-btn:hover {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
    color: var(--color-primary);
  }

  .add-products-icon {
    font-size: 1.5rem;
  }

  .add-products-text {
    flex: 1;
    text-align: left;
  }

  .selected-count {
    background: var(--color-primary);
    color: white;
    font-size: var(--font-size-xs);
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 9999px;
  }

  /* Modal de productos */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-md);
  }

  .modal[hidden] {
    display: none;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .modal-header h2 {
    font-size: var(--font-size-lg);
    margin: 0;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-secondary);
    border-radius: var(--radius-sm);
  }

  .modal-close:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .modal-search {
    padding: var(--space-sm) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .modal-search input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  .modal-search input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-md) var(--space-lg);
  }

  .modal-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid var(--color-border);
  }

  .modal-footer span {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .modal-actions {
    display: flex;
    gap: var(--space-sm);
  }

  /* Lista de productos en modal */
  .product-category-group {
    margin-bottom: var(--space-md);
  }

  .product-category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }

  .category-count {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    background: var(--color-bg);
    padding: 2px 6px;
    border-radius: 9999px;
  }

  .product-items {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .product-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    transition: background var(--transition-fast);
  }

  .product-item:hover {
    background: var(--color-bg-secondary);
  }

  .product-item.selected {
    background: rgba(37, 99, 235, 0.08);
  }

  .product-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    flex: 1;
    min-width: 0;
  }

  .product-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .product-quantity {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    flex-shrink: 0;
  }

  .qty-input {
    width: 60px;
    padding: 4px 8px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    text-align: center;
  }

  .unit-select {
    padding: 4px 8px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-bg);
    color: var(--color-text);
  }

  .no-products,
  .no-results {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .no-products small {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--font-size-xs);
  }

  @media (max-width: 480px) {
    .modal-content {
      max-height: 90vh;
    }

    .product-item {
      flex-wrap: wrap;
    }

    .product-quantity {
      width: 100%;
      margin-top: var(--space-xs);
      padding-left: 24px;
    }
  }
</style>
