---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Editar Lista">
  <div class="edit-list-page">
    <a href="/app/lists" class="back-link">‚Üê Volver a listas</a>

    <h1>Editar Lista</h1>

    <div id="loading-state" class="loading-state">
      <p>Cargando lista...</p>
    </div>

    <form id="edit-list-form" class="form" hidden>
      <!-- Icono y Nombre -->
      <div class="form-row icon-name-row">
        <div class="form-group icon-group">
          <label>Icono</label>
          <div class="icon-selector-wrapper">
            <button type="button" id="icon-selector-btn" class="icon-selector-btn">
              <span id="selected-icon">üõí</span>
              <img id="icon-preview" class="icon-preview" hidden alt="Icono personalizado" />
            </button>
            <label class="upload-icon-btn" title="Subir imagen personalizada">
              <input type="file" id="icon-file" accept="image/*" hidden />
              üì∑
            </label>
          </div>
          <input type="hidden" id="icon" value="üõí" />
          <input type="hidden" id="icon-url" value="" />
        </div>
        <div class="form-group name-group">
          <label for="name">Nombre de la lista *</label>
          <input type="text" id="name" required placeholder="Ej: Compra semanal" />
        </div>
      </div>

      <!-- Selector de iconos (modal) -->
      <div id="icon-picker" class="icon-picker" hidden>
        <div class="icon-grid">
          <!-- Se llena din√°micamente -->
        </div>
      </div>

      <!-- Tipo de lista (solo lectura) -->
      <div class="form-group">
        <label>Tipo de lista</label>
        <div class="list-type-display">
          <span id="list-type-icon" class="list-type-badge-icon">üõí</span>
          <span id="list-type-label">Lista de Compra</span>
        </div>
        <small class="form-help">El tipo de lista no se puede cambiar despu√©s de crearla</small>
      </div>

      <!-- Tipo de gasto (solo para listas de compra) -->
      <div class="form-group" id="expense-type-group" hidden>
        <label>Tipo de gasto</label>
        <div class="expense-type-options">
          <label class="expense-option">
            <input type="radio" name="expenseType" value="common" />
            <div class="expense-card">
              <span class="expense-icon">üè†</span>
              <div class="expense-info">
                <strong>Gasto Com√∫n</strong>
                <small>Se paga de un fondo com√∫n del grupo</small>
              </div>
            </div>
          </label>
          <label class="expense-option">
            <input type="radio" name="expenseType" value="shared" />
            <div class="expense-card">
              <span class="expense-icon">‚ûó</span>
              <div class="expense-info">
                <strong>Gasto a dividir</strong>
                <small>Se divide entre los miembros seleccionados</small>
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Miembros -->
      <div class="form-group">
        <label>Compartir con miembros</label>
        <div id="members-container" class="members-container">
          <p class="loading-text">Cargando miembros...</p>
        </div>
        <small class="form-help">Selecciona qu√© miembros del grupo pueden ver y editar esta lista</small>
      </div>

      <!-- Productos del cat√°logo (solo para listas de compra) -->
      <div class="form-group" id="products-group" hidden>
        <label>Productos adicionales</label>
        <button type="button" id="add-products-btn" class="add-products-btn">
          <span class="add-products-icon">üì¶</span>
          <span class="add-products-text">A√±adir productos del cat√°logo</span>
          <span id="selected-products-count" class="selected-count" hidden>0</span>
        </button>
        <small class="form-help">Selecciona productos del cat√°logo para a√±adirlos a esta lista</small>
      </div>

      <!-- Tienda (opcional, solo para listas de compra) -->
      <div class="form-group" id="store-group" hidden>
        <label for="store">Tienda (opcional)</label>
        <input type="text" id="store" placeholder="Ej: Mercadona, Carrefour..." />
      </div>

      <!-- Opciones avanzadas -->
      <details class="advanced-options">
        <summary>Opciones avanzadas</summary>
        <div class="advanced-content">
          <div class="form-group">
            <label for="date">Fecha programada</label>
            <input type="date" id="date" />
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="recurring" />
              Lista recurrente
            </label>
          </div>

          <div id="recurring-options" class="recurring-options" hidden>
            <div class="form-group">
              <label for="frequency">Frecuencia</label>
              <select id="frequency">
                <option value="weekly">Semanal</option>
                <option value="biweekly">Quincenal</option>
                <option value="monthly">Mensual</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <div class="form-actions">
        <a href="/app/lists" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary" id="submit-btn">Guardar cambios</button>
      </div>
    </form>

    <!-- Modal de productos del cat√°logo -->
    <div id="products-modal" class="modal" hidden>
      <div class="modal-backdrop"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Seleccionar productos</h2>
          <button type="button" class="modal-close" id="close-products-modal">&times;</button>
        </div>
        <div class="modal-search">
          <input type="text" id="product-search" placeholder="Buscar producto..." />
        </div>
        <div class="modal-body" id="products-list">
          <p class="loading-text">Cargando productos...</p>
        </div>
        <div class="modal-footer">
          <span id="modal-selected-count">0 productos seleccionados</span>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancel-products-btn">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirm-products-btn">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="error-state" class="error-state" hidden>
      <p>No se pudo cargar la lista</p>
      <a href="/app/lists" class="btn btn-secondary">Volver a listas</a>
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { toast } from '/js/toast.js';
  import { getCurrentGroupId, getGroup } from '/js/group.js';
  import { getList, updateList, updateListMembers } from '/js/lists.js';
  import { uploadListIcon, resizeImage, deleteListIcon } from '/js/storage.js';
  import { navigateTo } from '/js/navigate.js';
  import { getAllProducts, UNITS } from '/js/db.js';
  import { getCategoriesForList, DEFAULT_SHOPPING_CATEGORIES } from '/js/categories.js';

  // Iconos disponibles seg√∫n tipo de lista
  const SHOPPING_ICONS = [
    'üõí', 'üõçÔ∏è', 'üè™', 'üè¨', 'üõµ', 'üì¶',
    'ü•ó', 'üçé', 'ü•©', 'üßÄ', 'ü•ñ', 'üç™',
    'üßπ', 'üß¥', 'üíä', 'üêï', 'üéÅ', 'üéÑ'
  ];

  const GENERAL_ICONS = [
    'üìù', '‚úÖ', 'üìã', 'üéØ', 'üí°', '‚≠ê',
    '‚úàÔ∏è', '‚õ∫', 'üèïÔ∏è', 'üéí', 'üß≥', 'üó∫Ô∏è',
    'üíª', 'üì±', 'üéÆ', '‚öΩ', 'üèÉ', 'üö¥',
    'üè†', 'üîß', 'üìö', '‚úèÔ∏è', 'üíº', 'üìÑ'
  ];

  let currentList = null;
  let groupMembers = [];
  let selectedMembers = [];
  let currentUser = null;
  let selectedImageFile = null;
  let originalIconUrl = null;
  let catalogProducts = [];
  let selectedProducts = {};
  let productCategories = [];

  // Elementos DOM
  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const form = document.getElementById('edit-list-form');
  const iconGrid = document.querySelector('.icon-grid');
  const iconPicker = document.getElementById('icon-picker');
  const iconSelectorBtn = document.getElementById('icon-selector-btn');
  const selectedIconSpan = document.getElementById('selected-icon');
  const iconInput = document.getElementById('icon');
  const iconUrlInput = document.getElementById('icon-url');
  const iconFileInput = document.getElementById('icon-file');
  const iconPreview = document.getElementById('icon-preview');
  const nameInput = document.getElementById('name');
  const expenseTypeGroup = document.getElementById('expense-type-group');
  const storeGroup = document.getElementById('store-group');
  const listTypeIcon = document.getElementById('list-type-icon');
  const listTypeLabel = document.getElementById('list-type-label');
  const productsGroup = document.getElementById('products-group');
  const productsModal = document.getElementById('products-modal');
  const addProductsBtn = document.getElementById('add-products-btn');
  const closeProductsModal = document.getElementById('close-products-modal');
  const cancelProductsBtn = document.getElementById('cancel-products-btn');
  const confirmProductsBtn = document.getElementById('confirm-products-btn');
  const productsList = document.getElementById('products-list');
  const productSearch = document.getElementById('product-search');
  const modalSelectedCount = document.getElementById('modal-selected-count');
  const selectedProductsCount = document.getElementById('selected-products-count');

  // Obtener ID de la lista de la URL
  function getListIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  // Cargar lista y datos
  async function loadListData(user) {
    currentUser = user;
    const listId = getListIdFromUrl();

    if (!listId) {
      showError();
      return;
    }

    try {
      currentList = await getList(listId, true);

      if (!currentList) {
        showError();
        return;
      }

      // Verificar que el usuario es el propietario
      if (currentList.ownerId !== user.uid && currentList.createdBy !== user.uid) {
        toast.error('No tienes permiso para editar esta lista');
        navigateTo('/app/lists');
        return;
      }

      // Mostrar formulario
      loadingState.hidden = true;
      form.hidden = false;

      // Llenar datos
      populateForm();
      await loadGroupMembers();

    } catch (error) {
      console.error('Error loading list:', error);
      showError();
    }
  }

  function showError() {
    loadingState.hidden = true;
    errorState.hidden = false;
  }

  function populateForm() {
    // Nombre
    nameInput.value = currentList.name || '';

    // Icono
    originalIconUrl = currentList.iconUrl || null;
    if (currentList.iconUrl) {
      iconPreview.src = currentList.iconUrl;
      iconPreview.hidden = false;
      selectedIconSpan.hidden = true;
      iconUrlInput.value = currentList.iconUrl;
    } else {
      const icon = currentList.icon || 'üõí';
      selectedIconSpan.textContent = icon;
      iconInput.value = icon;
    }

    // Tipo de lista (solo lectura)
    const isShopping = currentList.listType === 'shopping' || !currentList.listType;
    listTypeIcon.textContent = isShopping ? 'üõí' : 'üìù';
    listTypeLabel.textContent = isShopping ? 'Lista de Compra' : 'Lista General';

    // Campos espec√≠ficos de listas de compra
    if (isShopping) {
      expenseTypeGroup.hidden = false;
      storeGroup.hidden = false;
      productsGroup.hidden = false;

      // Tipo de gasto
      const expenseType = currentList.expenseType || 'common';
      const expenseRadio = document.querySelector(`input[name="expenseType"][value="${expenseType}"]`);
      if (expenseRadio) expenseRadio.checked = true;

      // Tienda
      document.getElementById('store').value = currentList.store || '';
    }

    // Fecha programada
    if (currentList.scheduledDate) {
      const date = currentList.scheduledDate.toDate ? currentList.scheduledDate.toDate() : new Date(currentList.scheduledDate);
      document.getElementById('date').value = date.toISOString().split('T')[0];
    }

    // Recurrente
    const recurringCheckbox = document.getElementById('recurring');
    const recurringOptions = document.getElementById('recurring-options');
    if (currentList.isRecurring) {
      recurringCheckbox.checked = true;
      recurringOptions.hidden = false;
      if (currentList.recurringPattern?.frequency) {
        document.getElementById('frequency').value = currentList.recurringPattern.frequency;
      }
    }

    // Actualizar grid de iconos
    updateIconGrid(currentList.listType || 'shopping');
  }

  function updateIconGrid(listType) {
    const icons = listType === 'shopping' ? SHOPPING_ICONS : GENERAL_ICONS;

    iconGrid.innerHTML = '';
    icons.forEach(icon => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'icon-option';
      btn.textContent = icon;
      btn.addEventListener('click', () => {
        selectEmoji(icon);
        iconPicker.hidden = true;
        document.querySelectorAll('.icon-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
      // Marcar el icono actual
      if (icon === iconInput.value) btn.classList.add('selected');
      iconGrid.appendChild(btn);
    });
  }

  function selectEmoji(emoji) {
    selectedIconSpan.textContent = emoji;
    selectedIconSpan.hidden = false;
    iconInput.value = emoji;
    iconPreview.hidden = true;
    selectedImageFile = null;
    iconUrlInput.value = '';
  }

  // Cargar miembros del grupo
  async function loadGroupMembers() {
    const membersContainer = document.getElementById('members-container');
    if (!membersContainer) return;

    const groupId = getCurrentGroupId();

    if (!groupId) {
      membersContainer.innerHTML = `
        <div class="no-group">
          <p>No tienes un grupo activo.</p>
        </div>
      `;
      return;
    }

    try {
      const group = await getGroup(groupId);

      if (!group || !group.members) {
        membersContainer.innerHTML = '<p class="error-text">Error al cargar el grupo</p>';
        return;
      }

      // Convertir miembros a array, excluyendo al usuario actual
      groupMembers = Object.entries(group.members)
        .filter(([uid]) => uid !== currentUser.uid)
        .map(([uid, data]) => ({
          uid,
          name: data.displayName || data.email?.split('@')[0] || 'Usuario',
          photoURL: data.photoURL
        }));

      if (groupMembers.length === 0) {
        membersContainer.innerHTML = `
          <div class="no-members">
            <p>No hay otros miembros en el grupo.</p>
            <small>Invita a alguien desde la gesti√≥n del grupo.</small>
          </div>
        `;
        return;
      }

      // Miembros actuales de la lista (excluyendo al propietario)
      const currentMembers = (currentList.members || []).filter(m => m !== currentUser.uid);

      membersContainer.innerHTML = `
        <div class="members-list">
          ${groupMembers.map(member => `
            <label class="member-checkbox">
              <input type="checkbox" name="members" value="${member.uid}"
                ${currentMembers.includes(member.uid) ? 'checked' : ''} />
              <div class="member-info">
                <div class="member-avatar-small">
                  ${member.photoURL
                    ? `<img src="${member.photoURL}" alt="">`
                    : `<span>${member.name[0].toUpperCase()}</span>`
                  }
                </div>
                <span class="member-name">${member.name}</span>
              </div>
            </label>
          `).join('')}
        </div>
      `;

      // Inicializar selectedMembers
      selectedMembers = currentMembers;

      // Manejar selecci√≥n de miembros
      membersContainer.querySelectorAll('input[name="members"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          selectedMembers = Array.from(membersContainer.querySelectorAll('input[name="members"]:checked'))
            .map(cb => cb.value);
        });
      });
    } catch (error) {
      console.error('Error loading members:', error);
      membersContainer.innerHTML = '<p class="error-text">Error al cargar miembros</p>';
    }
  }

  // Event listeners
  iconFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!validTypes.includes(file.type)) {
        toast.error('Tipo de archivo no v√°lido. Usa JPG, PNG, GIF o WebP.');
        return;
      }

      if (file.size > 2 * 1024 * 1024) {
        toast.error('La imagen es demasiado grande. M√°ximo 2MB.');
        return;
      }

      const resizedBlob = await resizeImage(file);
      selectedImageFile = new File([resizedBlob], 'icon.webp', { type: 'image/webp' });

      iconPreview.src = URL.createObjectURL(resizedBlob);
      iconPreview.hidden = false;
      selectedIconSpan.hidden = true;
      iconInput.value = '';

      toast.success('Imagen seleccionada');
    } catch (error) {
      console.error('Error processing image:', error);
      toast.error('Error al procesar la imagen');
    }
  });

  iconSelectorBtn.addEventListener('click', () => {
    iconPicker.hidden = !iconPicker.hidden;
  });

  document.addEventListener('click', (e) => {
    if (!iconPicker.contains(e.target) && e.target !== iconSelectorBtn && !iconSelectorBtn.contains(e.target)) {
      iconPicker.hidden = true;
    }
  });

  // Lista recurrente
  const recurringCheckbox = document.getElementById('recurring');
  const recurringOptions = document.getElementById('recurring-options');

  recurringCheckbox.addEventListener('change', () => {
    recurringOptions.hidden = !recurringCheckbox.checked;
  });

  // ========== Modal de productos del cat√°logo ==========
  if (addProductsBtn) {
    addProductsBtn.addEventListener('click', async () => {
      productsModal.hidden = false;
      document.body.style.overflow = 'hidden';
      await loadCatalogProducts();
    });

    function closeModal() {
      productsModal.hidden = true;
      document.body.style.overflow = '';
      productSearch.value = '';
    }

    closeProductsModal.addEventListener('click', closeModal);
    cancelProductsBtn.addEventListener('click', closeModal);
    productsModal.querySelector('.modal-backdrop').addEventListener('click', closeModal);

    async function loadCatalogProducts() {
      productsList.innerHTML = '<p class="loading-text">Cargando productos...</p>';

      const groupId = getCurrentGroupId();
      if (!groupId) {
        productsList.innerHTML = `
          <div class="no-products">
            <p>No hay grupo activo</p>
            <small>Debes tener un grupo para ver el cat√°logo de productos</small>
          </div>
        `;
        return;
      }

      try {
        const [products, categories] = await Promise.all([
          getAllProducts(groupId),
          getCategoriesForList(groupId, 'shopping')
        ]);

        catalogProducts = products;
        productCategories = categories;

        if (catalogProducts.length === 0) {
          productsList.innerHTML = `
            <div class="no-products">
              <p>No hay productos en el cat√°logo</p>
              <small>Los productos se a√±aden autom√°ticamente cuando compras</small>
            </div>
          `;
          return;
        }

        renderProductsList();
      } catch (error) {
        console.error('Error loading products:', error);
        productsList.innerHTML = `<p class="error-text">Error al cargar productos: ${error.message}</p>`;
      }
    }

    function renderProductsList(filter = '') {
      const filterLower = filter.toLowerCase();
      const grouped = {};

      catalogProducts.forEach(product => {
        if (filter && !product.name.toLowerCase().includes(filterLower)) return;
        const cat = product.category || 'otros';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(product);
      });

      Object.values(grouped).forEach(products => {
        products.sort((a, b) => a.name.localeCompare(b.name));
      });

      const categoryOrder = productCategories.map(c => c.id);

      if (Object.keys(grouped).length === 0) {
        productsList.innerHTML = '<p class="no-results">No se encontraron productos</p>';
        return;
      }

      productsList.innerHTML = Object.entries(grouped)
        .sort(([a], [b]) => {
          const aIdx = categoryOrder.indexOf(a);
          const bIdx = categoryOrder.indexOf(b);
          return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx);
        })
        .map(([categoryId, products]) => {
          const category = productCategories.find(c => c.id === categoryId) ||
            DEFAULT_SHOPPING_CATEGORIES.find(c => c.id === categoryId) ||
            { name: categoryId, icon: 'üì¶' };

          return `
            <div class="product-category-group">
              <div class="product-category-header">
                <span>${category.icon || 'üì¶'} ${category.name}</span>
                <span class="category-count">${products.length}</span>
              </div>
              <div class="product-items">
                ${products.map(product => {
                  const selected = selectedProducts[product.id];
                  const isChecked = !!selected;
                  const quantity = selected?.quantity || product.defaultQuantity || 1;
                  const unit = selected?.unit || product.defaultUnit || 'unidad';

                  return `
                    <div class="product-item ${isChecked ? 'selected' : ''}" data-id="${product.id}">
                      <label class="product-checkbox">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} />
                        ${product.imageUrl ? `<img class="product-thumb" src="${product.imageUrl}" alt="">` : '<span class="product-thumb-placeholder">‚Äî</span>'}
                        <div class="product-info">
                          <div class="product-name">${product.name}</div>
                          ${product.storeTag ? `<div class="product-store-tag">${product.storeTag}</div>` : ''}
                        </div>
                      </label>
                      <div class="product-quantity ${isChecked ? '' : 'disabled'}">
                        <input type="number" min="0.1" step="0.1" value="${quantity}" class="qty-input" ${isChecked ? '' : 'disabled'} />
                        <select class="unit-select" ${isChecked ? '' : 'disabled'}>
                          ${UNITS.map(u =>
                            `<option value="${u.id}" ${unit === u.id ? 'selected' : ''}>${u.name}</option>`
                          ).join('')}
                        </select>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('');

      productsList.querySelectorAll('.product-item').forEach(item => {
        const productId = item.dataset.id;
        const product = catalogProducts.find(p => p.id === productId);
        const checkbox = item.querySelector('input[type="checkbox"]');
        const quantityDiv = item.querySelector('.product-quantity');
        const qtyInput = item.querySelector('.qty-input');
        const unitSelect = item.querySelector('.unit-select');

        item.addEventListener('click', (event) => {
          if (event.target.closest('.product-quantity')) return;
          const wasChecked = checkbox.checked;
          setTimeout(() => {
            if (checkbox.checked === wasChecked) {
              checkbox.checked = !wasChecked;
              checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        });

        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedProducts[productId] = {
              product,
              quantity: parseFloat(qtyInput.value) || 1,
              unit: unitSelect.value
            };
            item.classList.add('selected');
            quantityDiv.classList.remove('disabled');
            qtyInput.disabled = false;
            unitSelect.disabled = false;
          } else {
            delete selectedProducts[productId];
            item.classList.remove('selected');
            quantityDiv.classList.add('disabled');
            qtyInput.disabled = true;
            unitSelect.disabled = true;
          }
          updateSelectedCount();
        });

        qtyInput.addEventListener('change', () => {
          if (selectedProducts[productId]) {
            selectedProducts[productId].quantity = parseFloat(qtyInput.value) || 1;
          }
        });

        unitSelect.addEventListener('change', () => {
          if (selectedProducts[productId]) {
            selectedProducts[productId].unit = unitSelect.value;
          }
        });
      });
    }

    productSearch.addEventListener('input', (e) => {
      renderProductsList(e.target.value);
    });

    function updateSelectedCount() {
      const count = Object.keys(selectedProducts).length;
      modalSelectedCount.textContent = `${count} producto${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;

      if (count > 0) {
        selectedProductsCount.textContent = count;
        selectedProductsCount.hidden = false;
      } else {
        selectedProductsCount.hidden = true;
      }
    }

    confirmProductsBtn.addEventListener('click', () => {
      updateSelectedCount();
      closeModal();
      const count = Object.keys(selectedProducts).length;
      if (count > 0) {
        toast.success(`${count} producto${count !== 1 ? 's' : ''} a√±adido${count !== 1 ? 's' : ''}`);
      }
    });
  }
  // ========== Fin Modal ==========

  // Enviar formulario
  const submitBtn = document.getElementById('submit-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentUser || !currentList) {
      toast.error('Error de sesi√≥n');
      return;
    }

    const name = nameInput.value.trim();
    if (!name) {
      toast.warning('El nombre es obligatorio');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Guardando...';

    try {
      const isShopping = currentList.listType === 'shopping' || !currentList.listType;
      const updates = {
        name,
        scheduledDate: document.getElementById('date').value || null,
        isRecurring: recurringCheckbox.checked,
        recurringPattern: recurringCheckbox.checked ? { frequency: document.getElementById('frequency').value } : null
      };

      // Campos espec√≠ficos de listas de compra
      if (isShopping) {
        updates.expenseType = document.querySelector('input[name="expenseType"]:checked')?.value || 'common';
        updates.store = document.getElementById('store').value.trim() || null;
      }

      // Manejar icono
      if (selectedImageFile) {
        submitBtn.textContent = 'Subiendo imagen...';
        // Eliminar icono anterior si existe
        if (originalIconUrl) {
          try {
            await deleteListIcon(currentList.id);
          } catch (e) {
            console.warn('Could not delete old icon:', e);
          }
        }
        const iconUrl = await uploadListIcon(selectedImageFile, currentList.id);
        updates.iconUrl = iconUrl;
        updates.icon = null;
      } else if (iconInput.value) {
        // Se seleccion√≥ un emoji
        updates.icon = iconInput.value;
        // Si hab√≠a una imagen antes, eliminarla
        if (originalIconUrl) {
          updates.iconUrl = null;
          try {
            await deleteListIcon(currentList.id);
          } catch (e) {
            console.warn('Could not delete old icon:', e);
          }
        }
      }

      // Actualizar lista
      await updateList(currentList.id, updates);

      // Actualizar miembros si cambiaron
      const originalMembers = (currentList.members || []).filter(m => m !== currentUser.uid).sort();
      const newMembers = selectedMembers.sort();
      const membersChanged = JSON.stringify(originalMembers) !== JSON.stringify(newMembers);

      if (membersChanged) {
        await updateListMembers(currentList.id, selectedMembers);
      }

      const selectedProductsList = Object.values(selectedProducts);
      if (isShopping && selectedProductsList.length > 0) {
        submitBtn.textContent = 'A√±adiendo productos...';
        try {
          const { db } = await import('/js/firebase-config.js');
          const { collection, addDoc, updateDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');

          const itemsRef = collection(db, 'users', currentUser.uid, 'lists', currentList.id, 'items');

          for (const { product, quantity, unit } of selectedProductsList) {
            await addDoc(itemsRef, {
              name: product.name,
              quantity: quantity,
              unit: unit,
              category: product.category || 'otros',
              productId: product.id,
              checked: false,
              checkedAt: null,
              checkedBy: null,
              createdAt: serverTimestamp(),
              createdBy: currentUser.uid
            });
          }

          const listRef = doc(db, 'users', currentUser.uid, 'lists', currentList.id);
          await updateDoc(listRef, {
            itemCount: (currentList.itemCount || 0) + selectedProductsList.length,
            updatedAt: serverTimestamp()
          });
        } catch (itemsError) {
          console.error('Error adding items:', itemsError);
          toast.warning('Lista actualizada, pero hubo un error al a√±adir algunos productos');
        }
      }

      toast.success('Lista actualizada');
      navigateTo('/app/lists');

    } catch (error) {
      console.error('Error updating list:', error);
      toast.error('Error al actualizar: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Guardar cambios';
    }
  });

  // Inicializaci√≥n
  function tryInit() {
    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) loadListData(user);
    } else {
      window.addEventListener('auth-ready', (e) => loadListData(e.detail.user), { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);
</script>

<style is:global>
  .edit-list-page {
    max-width: 560px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  h1 {
    margin-bottom: var(--space-xl);
  }

  .loading-state,
  .error-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-md);
  }

  .list-type-display {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
  }

  .list-type-badge-icon {
    font-size: 1.5rem;
  }

  .form-group {
    margin-bottom: var(--space-lg);
  }

  .form-group > label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
  }

  .form-row {
    display: flex;
    gap: var(--space-md);
  }

  .icon-name-row {
    align-items: flex-end;
  }

  .icon-group {
    flex-shrink: 0;
  }

  .name-group {
    flex: 1;
  }

  .icon-selector-wrapper {
    display: flex;
    gap: var(--space-xs);
  }

  .icon-selector-btn {
    width: 56px;
    height: 42px;
    font-size: 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
  }

  .icon-selector-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .icon-preview {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .upload-icon-btn {
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    border: 1px dashed var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .upload-icon-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .icon-picker {
    position: relative;
    margin-top: calc(-1 * var(--space-md));
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
  }

  .icon-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: var(--space-xs);
  }

  .icon-option {
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
    border: 2px solid transparent;
    border-radius: var(--radius-sm);
    background: var(--color-bg-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .icon-option:hover {
    background: var(--color-bg-tertiary);
    transform: scale(1.1);
  }

  .icon-option.selected {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
  }

  /* Tipo de gasto */
  .expense-type-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .expense-option {
    cursor: pointer;
  }

  .expense-option input {
    display: none;
  }

  .expense-card {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
  }

  .expense-option input:checked + .expense-card {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
  }

  .expense-card:hover {
    border-color: var(--color-primary);
  }

  .expense-icon {
    font-size: 1.5rem;
  }

  .expense-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .expense-info strong {
    font-size: var(--font-size-base);
  }

  .expense-info small {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  /* Miembros */
  .members-container {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .members-list {
    display: flex;
    flex-direction: column;
  }

  .member-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .member-checkbox:not(:last-child) {
    border-bottom: 1px solid var(--color-border);
  }

  .member-checkbox:hover {
    background: var(--color-bg-secondary);
  }

  .member-checkbox:has(input:checked) {
    background: rgba(37, 99, 235, 0.05);
  }

  .member-checkbox:has(input:checked) .member-name {
    font-weight: 500;
  }

  .member-info {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .member-avatar-small {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--color-text-tertiary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    overflow: hidden;
  }

  .member-avatar-small img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .no-group,
  .no-members {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .form-help {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  /* Inputs */
  .form-group input[type="text"],
  .form-group input[type="date"],
  .form-group select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* Opciones avanzadas */
  .advanced-options {
    margin-bottom: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .advanced-options summary {
    padding: var(--space-md);
    cursor: pointer;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .advanced-options summary:hover {
    color: var(--color-text);
  }

  .advanced-content {
    padding: 0 var(--space-md) var(--space-md);
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
  }

  .recurring-options {
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    margin-top: var(--space-sm);
  }

  .recurring-options .form-group {
    margin-bottom: 0;
  }

  /* Actions */
  .form-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .loading-text,
  .error-text {
    padding: var(--space-md);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .error-text {
    color: var(--color-danger);
  }

  @media (max-width: 480px) {
    .icon-grid {
      grid-template-columns: repeat(5, 1fr);
    }

    .expense-card {
      padding: var(--space-sm);
    }
  }

  /* Bot√≥n a√±adir productos */
  .add-products-btn {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    width: 100%;
    padding: var(--space-md);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--font-size-base);
    color: var(--color-text-secondary);
  }

  .add-products-btn:hover {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
    color: var(--color-primary);
  }

  .add-products-icon {
    font-size: 1.5rem;
  }

  .add-products-text {
    flex: 1;
    text-align: left;
  }

  .selected-count {
    background: var(--color-primary);
    color: white;
    font-size: var(--font-size-xs);
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 9999px;
  }

  /* Modal de productos */
  #products-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-md);
    color: var(--color-text);
  }

  #products-modal[hidden] {
    display: none;
  }

  #products-modal .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 0;
  }

  #products-modal .modal-content {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 500px;
    max-height: 80vh;
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
    color: var(--color-text);
  }

  #products-modal .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  #products-modal .modal-header h2 {
    font-size: var(--font-size-lg);
    margin: 0;
  }

  #products-modal .modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-secondary);
    border-radius: var(--radius-sm);
  }

  #products-modal .modal-close:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  #products-modal .modal-search {
    padding: var(--space-sm) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  #products-modal .modal-search input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  #products-modal .modal-search input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  #products-modal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-md) var(--space-lg);
  }

  #products-modal .modal-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) var(--space-lg);
    border-top: 1px solid var(--color-border);
  }

  #products-modal .modal-footer span {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  #products-modal .modal-actions {
    display: flex;
    gap: var(--space-sm);
  }

  /* Lista de productos en modal */
  #products-modal .product-category-group {
    margin-bottom: var(--space-md);
  }

  #products-modal .product-category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }

  #products-modal .category-count {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    background: var(--color-bg);
    padding: 2px 6px;
    border-radius: 9999px;
  }

  #products-modal .product-items {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  #products-modal .product-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    transition: background var(--transition-fast);
    color: var(--color-text);
    cursor: pointer;
  }

  #products-modal .product-item:hover {
    background: var(--color-bg-secondary);
  }

  #products-modal .product-item.selected {
    background: rgba(37, 99, 235, 0.08);
  }

  #products-modal .product-checkbox {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    flex: 1;
    width: 100%;
    min-width: 0;
    color: var(--color-text);
    font-size: var(--font-size-base);
  }

  #products-modal .product-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    min-width: 0;
    visibility: visible;
    opacity: 1;
  }

  #products-modal .product-name {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--color-text);
    font-size: var(--font-size-base);
    line-height: 1.2;
  }

  #products-modal [hidden],
  #products-modal .product-quantity[hidden] {
    display: none !important;
  }

  #products-modal .product-thumb {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    background: #fff;
  }

  #products-modal .product-thumb-placeholder {
    display: inline-flex;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: 1px dashed var(--color-border);
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    font-size: 0.75rem;
  }

  #products-modal .product-store-tag {
    font-size: var(--font-size-xs);
    color: #0f766e;
    background: rgba(13, 148, 136, 0.12);
    padding: 2px 6px;
    border-radius: var(--radius-full);
    margin-left: var(--space-xs);
    white-space: nowrap;
  }

  #products-modal .product-quantity {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    flex-shrink: 0;
  }

  #products-modal .product-quantity.disabled {
    opacity: 0.6;
  }

  #products-modal .qty-input {
    width: 60px;
    padding: 4px 8px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    text-align: center;
  }

  #products-modal .unit-select {
    padding: 4px 8px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    background: var(--color-bg);
    color: var(--color-text);
  }

  #products-modal .no-products,
  #products-modal .no-results {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  #products-modal .no-products small {
    display: block;
    margin-top: var(--space-xs);
    font-size: var(--font-size-xs);
  }

  @media (max-width: 480px) {
    #products-modal .modal-content {
      max-height: 90vh;
    }

    #products-modal .product-item {
      flex-wrap: wrap;
    }

    #products-modal .product-quantity {
      width: 100%;
      margin-top: var(--space-xs);
      padding-left: 24px;
    }
  }
</style>
