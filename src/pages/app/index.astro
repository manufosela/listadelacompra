---
import AppLayout from '../../layouts/AppLayout.astro';
---

<AppLayout title="Listas">
  <div class="lists-page">
    <header class="page-header">
      <div>
        <h1>Listas</h1>
        <p id="user-greeting"></p>
      </div>
      <div class="header-actions">
        <a href="/app/lists/new" class="btn btn-primary">+ Nueva lista</a>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tab-mine" class="tab active">Mis listas</button>
      <button id="tab-shared" class="tab">
        Compartidas
        <span id="shared-count" class="tab-badge" hidden>0</span>
      </button>
    </div>

    <div id="lists-container" class="lists-container">
      <!-- Se carga dinÃ¡micamente -->
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { getUserLists, getSharedListsForUser } from '/js/lists.js';
  import { db } from '/js/firebase-config.js';
  import { collection, query, onSnapshot, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

  let currentTab = 'mine';
  let myLists = [];
  let sharedLists = [];
  let unsubscribe = null;
  let currentUser = null;

  function getElements() {
    return {
      container: document.getElementById('lists-container'),
      tabMine: document.getElementById('tab-mine'),
      tabShared: document.getElementById('tab-shared'),
      sharedCount: document.getElementById('shared-count'),
      greeting: document.getElementById('user-greeting')
    };
  }

  function setupTabs() {
    const { tabMine, tabShared } = getElements();

    tabMine?.addEventListener('click', () => {
      currentTab = 'mine';
      tabMine.classList.add('active');
      tabShared?.classList.remove('active');
      renderLists();
    });

    tabShared?.addEventListener('click', () => {
      currentTab = 'shared';
      tabShared.classList.add('active');
      tabMine?.classList.remove('active');
      renderLists();
    });
  }

  async function loadSharedLists() {
    const { sharedCount } = getElements();

    try {
      sharedLists = await getSharedListsForUser();

      if (sharedCount) {
        if (sharedLists.length > 0) {
          sharedCount.textContent = sharedLists.length;
          sharedCount.hidden = false;
        } else {
          sharedCount.hidden = true;
        }
      }
    } catch (e) {
      console.warn('Error loading shared lists:', e);
      sharedLists = [];
    }
  }

  async function initPage(user) {
    const { greeting } = getElements();
    currentUser = user;

    // Cancelar suscripciÃ³n anterior si existe
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }

    setupTabs();

    const displayName = user.displayName?.split(' ')[0] || 'Usuario';
    if (greeting) greeting.textContent = `Hola, ${displayName}`;

    // Cargar listas compartidas
    await loadSharedLists();

    // Primero mostrar datos cacheados de mis listas
    try {
      const cachedLists = await getUserLists(user);
      if (cachedLists && cachedLists.length > 0) {
        myLists = cachedLists;
        renderLists();
      }
    } catch (e) {
      console.warn('Error loading cached lists:', e);
    }

    // Luego suscribirse para actualizaciones en tiempo real
    const listsRef = collection(db, 'users', user.uid, 'lists');
    const q = query(listsRef, orderBy('updatedAt', 'desc'));

    unsubscribe = onSnapshot(q, (snapshot) => {
      myLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderLists();
    }, (error) => {
      console.error('Error loading lists:', error);
    });
  }

  function tryInit() {
    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) initPage(user);
    } else {
      window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);

  document.addEventListener('astro:before-swap', () => {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }
  });

  function renderLists() {
    const { container } = getElements();
    if (!container) return;

    const lists = currentTab === 'mine' ? myLists : sharedLists;
    const isSharedTab = currentTab === 'shared';

    if (lists.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p>${isSharedTab ? 'No tienes listas compartidas contigo' : 'No tienes listas todavÃ­a'}</p>
          ${!isSharedTab ? '<a href="/app/lists/new" class="btn btn-primary">Crear mi primera lista</a>' : ''}
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="lists-grid">
        ${lists.map(list => {
          // Para listas compartidas, construir URL con ownerId
          const listUrl = isSharedTab
            ? `/app/list?id=${list.listId}&owner=${list.ownerId}`
            : `/app/list?id=${list.id}`;

          return `
            <a href="${listUrl}" class="list-card">
              <div class="list-card-icon">${list.icon || 'ðŸ›’'}</div>
              <div class="list-card-name">${list.name}</div>
              ${isSharedTab ? `
                <div class="list-card-owner">
                  <span class="owner-badge">De ${list.ownerName}</span>
                </div>
              ` : ''}
              <div class="list-card-meta">
                ${!isSharedTab ? `<span>${list.itemCount || 0} elementos</span>` : ''}
                ${list.members?.length > 1 ? `<span class="members-badge">ðŸ‘¥ ${list.members.length}</span>` : ''}
              </div>
            </a>
          `;
        }).join('')}
      </div>
    `;
  }
</script>

<style is:global>
  .lists-page {
    max-width: 800px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .page-header h1 {
    margin-bottom: var(--space-xs);
  }

  .page-header p {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .tab {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: -1px;
  }

  .tab:hover {
    color: var(--color-text);
  }

  .tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    font-size: 11px;
    font-weight: 600;
    background: var(--color-primary);
    color: white;
    border-radius: 9px;
  }

  /* Grid de listas */
  .lists-container {
    min-height: 200px;
  }

  .lists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-md);
  }

  .list-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-lg) var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
    text-align: center;
  }

  .list-card:hover {
    border-color: var(--color-text);
    transform: translateY(-2px);
  }

  .list-card-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-sm);
  }

  .list-card-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
    line-height: 1.3;
  }

  .list-card-owner {
    margin-bottom: var(--space-xs);
  }

  .owner-badge {
    font-size: var(--font-size-xs);
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  .list-card-meta {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .members-badge {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-2xl) var(--space-lg);
    color: var(--color-text-secondary);
  }

  .empty-state p {
    margin-bottom: var(--space-lg);
  }

  @media (max-width: 480px) {
    .lists-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .list-card {
      padding: var(--space-md);
    }

    .list-card-icon {
      font-size: 2rem;
    }
  }
</style>
