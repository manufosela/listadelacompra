---
import AppLayout from '../../layouts/AppLayout.astro';
---

<AppLayout title="Listas">
  <div class="lists-page">
    <header class="page-header">
      <div>
        <h1>Listas</h1>
        <p id="user-greeting"></p>
      </div>
      <div class="header-actions">
        <a href="/app/lists/new" class="btn btn-primary">+ Nueva lista</a>
      </div>
    </header>

    <!-- Tabs y controles -->
    <div class="tabs-row">
      <div class="tabs">
        <button id="tab-mine" class="tab active">Mis listas</button>
        <button id="tab-archived" class="tab">
          Archivadas
          <span id="archived-count" class="tab-badge" hidden>0</span>
        </button>
        <button id="tab-shared" class="tab">
          Compartidas
          <span id="shared-count" class="tab-badge" hidden>0</span>
        </button>
      </div>
      <div class="view-toggle">
        <button id="view-grid" class="view-toggle-btn" title="Vista iconos">â˜·</button>
        <button id="view-list" class="view-toggle-btn active" title="Vista lista">â˜°</button>
      </div>
    </div>

    <div id="lists-container" class="lists-container">
      <!-- Se carga dinÃ¡micamente -->
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { getUserLists, getSharedListsForUser } from '/js/lists.js';
  import { db } from '/js/firebase-config.js';
  import { collection, query, onSnapshot, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

  let currentTab = 'mine';
  let viewMode = localStorage.getItem('listsViewMode') || 'list'; // 'grid' o 'list', default lista
  let myLists = [];
  let sharedLists = [];
  let unsubscribe = null;
  let currentUser = null;

  function getElements() {
    return {
      container: document.getElementById('lists-container'),
      tabMine: document.getElementById('tab-mine'),
      tabArchived: document.getElementById('tab-archived'),
      tabShared: document.getElementById('tab-shared'),
      archivedCount: document.getElementById('archived-count'),
      sharedCount: document.getElementById('shared-count'),
      greeting: document.getElementById('user-greeting'),
      viewGrid: document.getElementById('view-grid'),
      viewList: document.getElementById('view-list')
    };
  }

  function setupTabs() {
    const { tabMine, tabArchived, tabShared, viewGrid, viewList } = getElements();

    function setActiveTab(tab) {
      tabMine?.classList.remove('active');
      tabArchived?.classList.remove('active');
      tabShared?.classList.remove('active');
      tab?.classList.add('active');
    }

    tabMine?.addEventListener('click', () => {
      currentTab = 'mine';
      setActiveTab(tabMine);
      renderLists();
    });

    tabArchived?.addEventListener('click', () => {
      currentTab = 'archived';
      setActiveTab(tabArchived);
      renderLists();
    });

    tabShared?.addEventListener('click', () => {
      currentTab = 'shared';
      setActiveTab(tabShared);
      renderLists();
    });

    // View toggle
    viewGrid?.addEventListener('click', () => {
      viewMode = 'grid';
      localStorage.setItem('listsViewMode', 'grid');
      viewGrid.classList.add('active');
      viewList?.classList.remove('active');
      renderLists();
    });

    viewList?.addEventListener('click', () => {
      viewMode = 'list';
      localStorage.setItem('listsViewMode', 'list');
      viewList.classList.add('active');
      viewGrid?.classList.remove('active');
      renderLists();
    });

    // Aplicar estado inicial del toggle
    if (viewMode === 'list') {
      viewList?.classList.add('active');
      viewGrid?.classList.remove('active');
    } else {
      viewGrid?.classList.add('active');
      viewList?.classList.remove('active');
    }
  }

  async function loadSharedLists() {
    const { sharedCount } = getElements();

    try {
      sharedLists = await getSharedListsForUser();

      if (sharedCount) {
        if (sharedLists.length > 0) {
          sharedCount.textContent = sharedLists.length;
          sharedCount.hidden = false;
        } else {
          sharedCount.hidden = true;
        }
      }
    } catch (e) {
      console.warn('Error loading shared lists:', e);
      sharedLists = [];
    }
  }

  async function initPage(user) {
    const { greeting } = getElements();
    currentUser = user;

    // Cancelar suscripciÃ³n anterior si existe
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }

    setupTabs();

    const displayName = user.displayName?.split(' ')[0] || 'Usuario';
    if (greeting) greeting.textContent = `Hola, ${displayName}`;

    // Cargar listas compartidas
    await loadSharedLists();

    // Primero mostrar datos cacheados de mis listas
    try {
      const cachedLists = await getUserLists(user);
      if (cachedLists && cachedLists.length > 0) {
        myLists = cachedLists;
        renderLists();
      }
    } catch (e) {
      console.warn('Error loading cached lists:', e);
    }

    // Luego suscribirse para actualizaciones en tiempo real
    const listsRef = collection(db, 'users', user.uid, 'lists');
    const q = query(listsRef, orderBy('updatedAt', 'desc'));

    unsubscribe = onSnapshot(q, (snapshot) => {
      myLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderLists();
    }, (error) => {
      console.error('Error loading lists:', error);
    });
  }

  function tryInit() {
    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) initPage(user);
    } else {
      window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);

  document.addEventListener('astro:before-swap', () => {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }
  });

  function renderLists() {
    const { container, archivedCount } = getElements();
    if (!container) return;

    // Filtrar listas abiertas y cerradas
    const openLists = myLists.filter(l => !l.closed);
    const archivedLists = myLists.filter(l => l.closed);

    // Actualizar badge de archivadas
    if (archivedCount) {
      if (archivedLists.length > 0) {
        archivedCount.textContent = archivedLists.length;
        archivedCount.hidden = false;
      } else {
        archivedCount.hidden = true;
      }
    }

    let lists;
    if (currentTab === 'mine') {
      lists = openLists;
    } else if (currentTab === 'archived') {
      lists = archivedLists;
    } else {
      lists = sharedLists;
    }

    const isSharedTab = currentTab === 'shared';
    const isArchivedTab = currentTab === 'archived';

    if (lists.length === 0) {
      let emptyMessage = 'No tienes listas todavÃ­a';
      if (isSharedTab) {
        emptyMessage = 'No tienes listas compartidas contigo';
      } else if (isArchivedTab) {
        emptyMessage = 'No tienes listas archivadas';
      }

      container.innerHTML = `
        <div class="empty-state">
          <p>${emptyMessage}</p>
          ${!isSharedTab && !isArchivedTab ? '<a href="/app/lists/new" class="btn btn-primary">Crear mi primera lista</a>' : ''}
        </div>
      `;
      return;
    }

    if (viewMode === 'list') {
      // Vista lista/tabla
      container.innerHTML = `
        <div class="lists-table-wrapper">
          <table class="lists-table">
            <thead>
              <tr>
                <th></th>
                <th>Nombre</th>
                <th>Elementos</th>
                ${isSharedTab ? '<th>Propietario</th>' : ''}
              </tr>
            </thead>
            <tbody>
              ${lists.map(list => {
                const listUrl = isSharedTab
                  ? `/app/list?id=${list.listId}&owner=${list.ownerId}`
                  : `/app/list?id=${list.id}`;

                return `
                  <tr onclick="window.location.href='${listUrl}'">
                    <td class="icon-cell">${list.icon || 'ðŸ›’'}</td>
                    <td class="name-cell">
                      ${list.name}
                      ${list.members?.length > 1 ? `<span class="members-badge">ðŸ‘¥ ${list.members.length}</span>` : ''}
                    </td>
                    <td class="count-cell">${list.itemCount || 0}</td>
                    ${isSharedTab ? `<td class="owner-cell">${list.ownerName || ''}</td>` : ''}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      // Vista grid (iconos)
      container.innerHTML = `
        <div class="lists-grid">
          ${lists.map(list => {
            const listUrl = isSharedTab
              ? `/app/list?id=${list.listId}&owner=${list.ownerId}`
              : `/app/list?id=${list.id}`;

            return `
              <a href="${listUrl}" class="list-card">
                <div class="list-card-icon">${list.icon || 'ðŸ›’'}</div>
                <div class="list-card-name">${list.name}</div>
                ${isSharedTab ? `
                  <div class="list-card-owner">
                    <span class="owner-badge">De ${list.ownerName}</span>
                  </div>
                ` : ''}
                <div class="list-card-meta">
                  ${!isSharedTab ? `<span>${list.itemCount || 0} elementos</span>` : ''}
                  ${list.members?.length > 1 ? `<span class="members-badge">ðŸ‘¥ ${list.members.length}</span>` : ''}
                </div>
              </a>
            `;
          }).join('')}
        </div>
      `;
    }
  }
</script>

<style is:global>
  .lists-page {
    max-width: 800px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .page-header h1 {
    margin-bottom: var(--space-xs);
  }

  .page-header p {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
  }

  /* Tabs row */
  .tabs-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: var(--space-xs);
  }

  /* View toggle */
  .view-toggle {
    display: flex;
    background: var(--color-bg-secondary);
    border-radius: 0.375rem;
    padding: 0.125rem;
    margin-bottom: -1px;
  }

  .view-toggle-btn {
    padding: 0.375rem 0.5rem;
    border: none;
    background: transparent;
    border-radius: 0.25rem;
    cursor: pointer;
    font-size: 1rem;
    color: var(--color-text-secondary);
    transition: all 0.15s ease;
    line-height: 1;
  }

  .view-toggle-btn:hover {
    color: var(--color-text);
  }

  .view-toggle-btn.active {
    background: var(--color-bg);
    color: var(--color-primary);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .tab {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: -1px;
  }

  .tab:hover {
    color: var(--color-text);
  }

  .tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .tab-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    font-size: 11px;
    font-weight: 600;
    background: var(--color-primary);
    color: white;
    border-radius: 9px;
  }

  /* Grid de listas */
  .lists-container {
    min-height: 200px;
  }

  .lists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: var(--space-md);
  }

  .list-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-lg) var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-fast);
    text-align: center;
  }

  .list-card:hover {
    border-color: var(--color-text);
    transform: translateY(-2px);
  }

  .list-card-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-sm);
  }

  .list-card-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
    line-height: 1.3;
  }

  .list-card-owner {
    margin-bottom: var(--space-xs);
  }

  .owner-badge {
    font-size: var(--font-size-xs);
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  .list-card-meta {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .members-badge {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-2xl) var(--space-lg);
    color: var(--color-text-secondary);
  }

  .empty-state p {
    margin-bottom: var(--space-lg);
  }

  @media (max-width: 480px) {
    .lists-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .list-card {
      padding: var(--space-md);
    }

    .list-card-icon {
      font-size: 2rem;
    }
  }

  /* Table view styles */
  .lists-table-wrapper {
    overflow-x: auto;
  }

  .lists-table {
    width: 100%;
    border-collapse: collapse;
  }

  .lists-table th,
  .lists-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .lists-table th {
    font-weight: 500;
    font-size: var(--font-size-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    background: var(--color-bg-secondary);
  }

  .lists-table tbody tr {
    cursor: pointer;
    transition: background 0.15s ease;
  }

  .lists-table tbody tr:hover {
    background: var(--color-bg-secondary);
  }

  .lists-table .icon-cell {
    width: 50px;
    font-size: 1.5rem;
    text-align: center;
  }

  .lists-table .name-cell {
    font-weight: 500;
  }

  .lists-table .name-cell .members-badge {
    margin-left: var(--space-sm);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .lists-table .count-cell {
    color: var(--color-text-secondary);
    white-space: nowrap;
  }

  .lists-table .owner-cell {
    color: var(--color-text-secondary);
  }

  @media (max-width: 480px) {
    .tabs-row {
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .view-toggle {
      order: -1;
      width: 100%;
      justify-content: flex-end;
      margin-bottom: var(--space-sm);
    }
  }
</style>
