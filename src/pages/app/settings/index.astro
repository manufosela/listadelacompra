---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Ajustes">
  <div class="settings-page">
    <header class="page-header">
      <h1>Ajustes</h1>
    </header>

    <!-- Cuenta -->
    <section class="settings-section">
      <h2>Cuenta</h2>
      <div id="user-info" class="settings-card clickable">
        <div class="card-content">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-details">
            <span class="user-name" id="user-name">Cargando...</span>
            <span class="user-email" id="user-email"></span>
          </div>
        </div>
        <span class="card-arrow">â€º</span>
      </div>
    </section>

    <!-- Grupo activo -->
    <section class="settings-section">
      <h2>Grupo activo</h2>
      <a href="/app/groups" class="settings-card clickable">
        <div class="card-content">
          <span class="card-icon">ðŸ‘¥</span>
          <div class="card-details">
            <span class="card-title" id="group-name">Cargando...</span>
            <span class="card-subtitle" id="group-members"></span>
          </div>
        </div>
        <span class="card-arrow">â€º</span>
      </a>
    </section>

    <!-- Preferencias -->
    <section class="settings-section">
      <h2>Preferencias</h2>
      <div class="settings-list">
        <div class="settings-item" id="theme-toggle">
          <div class="item-content">
            <span class="item-icon">ðŸŒ™</span>
            <span class="item-label">Tema oscuro</span>
          </div>
          <label class="toggle">
            <input type="checkbox" id="dark-mode-checkbox" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item" id="notifications-toggle">
          <div class="item-content">
            <span class="item-icon">ðŸ””</span>
            <span class="item-label">Notificaciones</span>
          </div>
          <label class="toggle">
            <input type="checkbox" id="notifications-checkbox" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </section>

    <!-- SesiÃ³n -->
    <section class="settings-section">
      <button id="logout-btn" class="btn btn-danger btn-full">
        Cerrar sesiÃ³n
      </button>
    </section>

    <!-- VersiÃ³n -->
    <p class="app-version">HomeCart v1.0.0</p>
  </div>

  <!-- Modal para editar perfil -->
  <div id="edit-profile-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>Editar perfil</h3>
      <form id="edit-profile-form">
        <div class="form-group">
          <label for="edit-name">Nombre</label>
          <input type="text" id="edit-name" class="form-input" required />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="edit-email" class="form-input" disabled />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancel-edit">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser, signOut } from '/js/auth.js';
  import { getCurrentGroupId, getGroup } from '/js/group.js';
  import { modal } from '/js/modal.js';
  import { toast } from '/js/toast.js';
  import { auth } from '/js/firebase-config.js';
  import { updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

  let currentUser = null;

  function initPage(user) {
    if (!user) return;
    currentUser = user;

    // User info
    const userName = document.getElementById('user-name');
    const userEmail = document.getElementById('user-email');
    const userAvatar = document.getElementById('user-avatar');

    if (userName) userName.textContent = user.displayName || 'Sin nombre';
    if (userEmail) userEmail.textContent = user.email;
    if (userAvatar) {
      if (user.photoURL) {
        userAvatar.innerHTML = `<img src="${user.photoURL}" alt="Avatar" />`;
      } else {
        userAvatar.textContent = (user.displayName || user.email || '?')[0].toUpperCase();
      }
    }

    // Group info
    loadGroupInfo();
  }

  async function loadGroupInfo() {
    const groupName = document.getElementById('group-name');
    const groupMembers = document.getElementById('group-members');

    const groupId = getCurrentGroupId();
    if (!groupId) {
      if (groupName) groupName.textContent = 'Sin grupo';
      if (groupMembers) groupMembers.textContent = 'Toca para crear o unirte';
      return;
    }

    try {
      const group = await getGroup(groupId);
      if (group) {
        if (groupName) groupName.textContent = group.name;
        const memberCount = Object.keys(group.members || {}).length;
        if (groupMembers) groupMembers.textContent = `${memberCount} miembro${memberCount !== 1 ? 's' : ''}`;
      }
    } catch (e) {
      console.error('Error loading group:', e);
      if (groupName) groupName.textContent = 'Error al cargar';
    }
  }

  function setupEventListeners() {
    // Logout button
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn && !logoutBtn.dataset.initialized) {
      logoutBtn.dataset.initialized = 'true';
      logoutBtn.addEventListener('click', async () => {
        const confirmed = await modal.confirm({
          title: 'Cerrar sesiÃ³n',
          message: 'Â¿Seguro que quieres cerrar sesiÃ³n?',
          confirmText: 'Cerrar sesiÃ³n',
          cancelText: 'Cancelar',
          danger: true
        });
        if (confirmed) {
          await signOut();
          window.location.href = '/login';
        }
      });
    }

    // Edit profile
    const userInfo = document.getElementById('user-info');
    const editModal = document.getElementById('edit-profile-modal');
    const editForm = document.getElementById('edit-profile-form');
    const cancelEdit = document.getElementById('cancel-edit');

    if (userInfo && !userInfo.dataset.initialized) {
      userInfo.dataset.initialized = 'true';
      userInfo.addEventListener('click', () => {
        if (editModal && currentUser) {
          document.getElementById('edit-name').value = currentUser.displayName || '';
          document.getElementById('edit-email').value = currentUser.email || '';
          editModal.style.display = 'flex';
        }
      });
    }

    if (cancelEdit && !cancelEdit.dataset.initialized) {
      cancelEdit.dataset.initialized = 'true';
      cancelEdit.addEventListener('click', () => {
        if (editModal) editModal.style.display = 'none';
      });
    }

    if (editForm && !editForm.dataset.initialized) {
      editForm.dataset.initialized = 'true';
      editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = document.getElementById('edit-name').value.trim();
        if (!newName) return;

        try {
          await updateProfile(auth.currentUser, { displayName: newName });
          toast.success('Perfil actualizado');
          if (editModal) editModal.style.display = 'none';
          // Refresh display
          const userName = document.getElementById('user-name');
          if (userName) userName.textContent = newName;
        } catch (error) {
          toast.error('Error al actualizar: ' + error.message);
        }
      });
    }

    // Close modal on overlay click
    if (editModal && !editModal.dataset.initialized) {
      editModal.dataset.initialized = 'true';
      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) editModal.style.display = 'none';
      });
    }
  }

  function tryInit() {
    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) {
        initPage(user);
        setupEventListeners();
      }
    } else {
      window.addEventListener('auth-ready', (e) => {
        initPage(e.detail.user);
        setupEventListeners();
      }, { once: true });
    }
  }

  // Ejecutar en carga inicial
  tryInit();

  // Re-ejecutar en navegaciones con View Transitions
  document.addEventListener('astro:page-load', tryInit);
</script>

<style is:global>
  .settings-page {
    max-width: 500px;
  }

  .page-header {
    margin-bottom: var(--space-lg);
  }

  .page-header h1 {
    margin-bottom: 0;
  }

  .settings-section {
    margin-bottom: var(--space-xl);
  }

  .settings-section h2 {
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-sm);
  }

  .settings-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
  }

  .settings-card.clickable {
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .settings-card.clickable:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-secondary);
  }

  .card-content {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 600;
    overflow: hidden;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .user-details, .card-details {
    display: flex;
    flex-direction: column;
  }

  .user-name, .card-title {
    font-weight: 500;
  }

  .user-email, .card-subtitle {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .card-icon {
    font-size: 1.5rem;
  }

  .card-arrow {
    font-size: 1.5rem;
    color: var(--color-text-secondary);
  }

  .settings-list {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .settings-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md);
  }

  .settings-item:not(:last-child) {
    border-bottom: 1px solid var(--color-border);
  }

  .item-content {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .item-icon {
    font-size: 1.25rem;
  }

  .toggle {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 28px;
  }

  .toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 28px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }

  .toggle input:checked + .toggle-slider {
    background-color: var(--color-primary);
  }

  .toggle input:checked + .toggle-slider:before {
    transform: translateX(20px);
  }

  .btn-full {
    width: 100%;
  }

  .btn-danger {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #fecaca;
  }

  .btn-danger:hover {
    background: #fecaca;
  }

  .app-version {
    text-align: center;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-top: var(--space-xl);
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: var(--space-md);
  }

  .modal-content {
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    width: 100%;
    max-width: 400px;
  }

  .modal-content h3 {
    margin-bottom: var(--space-lg);
  }

  .form-group {
    margin-bottom: var(--space-md);
  }

  .form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }

  .form-input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-input:disabled {
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
  }

  .modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
    margin-top: var(--space-lg);
  }
</style>
