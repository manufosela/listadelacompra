---
import AppLayout from '../../layouts/AppLayout.astro';
---

<AppLayout title="Lista de la Compra">
  <div class="list-detail-page">
    <a href="/app/lists" class="back-link">‚Üê Volver a listas</a>
    <div id="list-header" class="list-header">
      <div class="list-header-loading">Cargando...</div>
    </div>
    <div id="list-container"></div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import '/components/hc-shopping-list.js';
  import { db } from '/js/firebase-config.js';
  import { doc, getDoc, updateDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  import { toast } from '/js/toast.js';

  let unsubscribe = null;
  let currentListId = null;

  function showError(headerEl, message, isNetwork = false) {
    const errorText = isNetwork
      ? 'Error de conexi√≥n. Verifica tu conexi√≥n a internet.'
      : message;

    headerEl.innerHTML = `
      <div class="list-error">
        <p>${errorText}</p>
        <div class="list-error-actions">
          <button onclick="location.reload()" class="btn btn-primary">Reintentar</button>
          <a href="/app/lists" class="btn btn-secondary">Volver a listas</a>
        </div>
      </div>
    `;
  }

  async function initPage(user) {
    // Re-leer URL params en cada navegaci√≥n
    const urlParams = new URLSearchParams(window.location.search);
    const listId = urlParams.get('id');
    const ownerId = urlParams.get('owner') || user.uid;

    if (!listId) {
      window.location.href = '/app/lists';
      return;
    }

    // Si es la misma lista, no reinicializar
    if (listId === currentListId && unsubscribe) return;

    currentListId = listId;

    const headerEl = document.getElementById('list-header');
    const container = document.getElementById('list-container');
    if (!headerEl || !container) return;

    // Limpiar contenido previo
    container.innerHTML = '';

    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }

    const listRef = doc(db, 'users', ownerId, 'lists', listId);
    const isOwner = ownerId === user.uid;

    // Funci√≥n para renderizar la lista
    function renderList(list) {
      const isAgnostic = list.listType === 'agnostic';
      const members = list.members || [];
      const memberCount = members.length;

      let typeBadgeHtml = '';
      if (!isAgnostic && list.expenseType) {
        typeBadgeHtml = `
          <span class="type-badge ${list.expenseType === 'shared' ? 'shared' : 'common'}">
            ${list.expenseType === 'shared' ? '‚ûó Dividir' : 'üè† Com√∫n'}
          </span>
        `;
      } else if (isAgnostic) {
        typeBadgeHtml = `<span class="type-badge agnostic">üìù General</span>`;
      }

      const ownerBadge = !isOwner ? `<span class="owner-badge">De ${list.ownerName}</span>` : '';
      const membersBadge = memberCount > 1 ? `<span class="members-badge" id="members-toggle">üë• ${memberCount}</span>` : '';
      const listIconHtml = list.iconUrl
        ? `<img src="${list.iconUrl}" alt="" class="list-icon-img" />`
        : `<span class="list-icon">${list.icon || (isAgnostic ? 'üìù' : 'üõí')}</span>`;

      headerEl.innerHTML = `
        <div class="list-title-row">
          <div class="list-title-main">
            ${listIconHtml}
            <h1>${list.name}</h1>
          </div>
          <div class="list-actions-meta">
            <div class="list-header-actions">
              ${!isAgnostic && !list.closed ? `
                <button id="scan-ticket-btn" class="header-action-btn" title="Escanear ticket">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </button>
              ` : ''}
              ${isOwner ? `
                <a href="/app/lists/edit?id=${listId}" class="header-action-btn" title="Editar lista">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </a>
                <button id="archive-list-btn" class="header-action-btn ${list.closed ? 'active' : ''}" title="${list.closed ? 'Reabrir lista' : 'Archivar lista'}">
                  <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                  </svg>
                </button>
              ` : ''}
            </div>
            <div class="list-meta">
              ${ownerBadge}
              ${typeBadgeHtml}
              ${membersBadge}
              <span class="status-badge ${list.closed ? 'closed' : 'open'}">
                ${list.closed ? 'Cerrada' : 'Abierta'}
              </span>
            </div>
          </div>
        </div>
      `;

      // Event listeners
      document.getElementById('archive-list-btn')?.addEventListener('click', async () => {
        const newClosed = !list.closed;
        await updateDoc(listRef, { closed: newClosed, updatedAt: serverTimestamp() });
        toast.success(newClosed ? 'Lista archivada' : 'Lista reabierta');
      });

      document.getElementById('scan-ticket-btn')?.addEventListener('click', () => {
        const listComponent = document.querySelector('hc-shopping-list');
        if (listComponent) {
          listComponent.dispatchEvent(new CustomEvent('open-scanner'));
        }
      });

      // Crear componente si no existe
      if (!container.querySelector('hc-shopping-list')) {
        const listComponent = document.createElement('hc-shopping-list');
        listComponent.setAttribute('list-id', listId);
        listComponent.setAttribute('user-id', ownerId);
        listComponent.setAttribute('list-type', list.listType || 'shopping');
        if (list.closed) {
          listComponent.setAttribute('readonly', 'true');
        }
        container.appendChild(listComponent);
      }
    }

    // Cargar con getDoc (funciona siempre) en lugar de onSnapshot
    try {
      const snapshot = await getDoc(listRef);

      if (!snapshot.exists()) {
        headerEl.innerHTML = `
          <div class="list-not-found">
            <p>Lista no encontrada</p>
            <a href="/app/lists" class="btn btn-primary">Volver a listas</a>
          </div>
        `;
        return;
      }

      const list = { id: snapshot.id, ...snapshot.data() };
      renderList(list);

      // Intentar suscribirse a cambios (opcional, si falla no pasa nada)
      try {
        unsubscribe = onSnapshot(listRef, (snap) => {
          if (snap.exists()) {
            const updatedList = { id: snap.id, ...snap.data() };
            // Solo actualizar el estado closed del componente
            const existingComponent = container.querySelector('hc-shopping-list');
            if (existingComponent) {
              if (updatedList.closed) {
                existingComponent.setAttribute('readonly', 'true');
              } else {
                existingComponent.removeAttribute('readonly');
              }
            }
          }
        });
      } catch {
        // Si onSnapshot falla, ignorar - ya tenemos los datos con getDoc
        console.warn('onSnapshot no disponible, usando solo getDoc');
      }
    } catch (error) {
      console.error('Error loading list:', error);
      showError(headerEl, 'Error al cargar la lista', true);
    }
  }

  function tryInit() {
    // Solo ejecutar si estamos en la p√°gina de lista (no /app/lists)
    // Acepta /app/list o /app/list/
    const path = window.location.pathname.replace(/\/$/, '');
    if (path !== '/app/list') return;

    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) initPage(user);
    } else {
      // Timeout de 10s para auth
      const authTimeout = setTimeout(() => {
        const headerEl = document.getElementById('list-header');
        if (headerEl && headerEl.querySelector('.list-header-loading')) {
          showError(headerEl, 'Error de autenticaci√≥n. Por favor, recarga la p√°gina.', true);
        }
      }, 10000);

      window.addEventListener('auth-ready', (e) => {
        clearTimeout(authTimeout);
        if (e.detail.user) initPage(e.detail.user);
      }, { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);

  document.addEventListener('astro:before-swap', () => {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }
    currentListId = null;
  });
</script>

<style is:global>
  .list-detail-page {
    max-width: 800px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .list-header {
    margin-bottom: var(--space-xl);
  }

  .list-header-loading {
    color: var(--color-text-secondary);
    padding: var(--space-lg);
  }

  .list-title-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-md);
  }

  .list-title-main {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex: 1;
    min-width: 0;
  }

  .list-title-main h1 {
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .list-icon {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .list-icon-img {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    object-fit: cover;
    flex-shrink: 0;
  }

  .list-actions-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex-wrap: wrap;
  }

  .list-header-actions {
    display: flex;
    gap: var(--space-xs);
    flex-shrink: 0;
  }

  .header-action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
  }

  .header-action-btn:hover {
    background: var(--color-bg-secondary);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .header-action-btn.active {
    background: var(--color-text-secondary);
    border-color: var(--color-text-secondary);
    color: white;
  }

  .list-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    align-items: center;
  }

  .type-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .type-badge.common {
    background: #e0f2fe;
    color: #0369a1;
  }

  .type-badge.shared {
    background: #fef3c7;
    color: #92400e;
  }

  .type-badge.agnostic {
    background: #f3e8ff;
    color: #7c3aed;
  }

  .store-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    background: #f3f4f6;
    color: #6b7280;
  }

  .status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .status-badge.open {
    background: #dcfce7;
    color: #166534;
  }

  .status-badge.closed {
    background: #f3f4f6;
    color: #6b7280;
  }

  .list-actions {
    display: flex;
    gap: var(--space-sm);
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--font-size-sm);
  }

  .list-not-found,
  .list-error {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .list-not-found p,
  .list-error p {
    margin-bottom: var(--space-md);
  }

  .list-error-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    margin-top: var(--space-md);
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-md);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .btn-secondary:hover {
    background: var(--color-border);
  }

  /* Owner badge */
  .owner-badge {
    font-size: var(--font-size-xs);
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  /* Members badge */
  .members-badge {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    background: var(--color-bg-secondary);
  }

  @media (max-width: 480px) {
    .list-title-row {
      gap: var(--space-sm);
    }

    .list-title-main {
      width: 100%;
      flex: none;
    }

    .list-title-main h1 {
      font-size: 1.25rem;
    }

    .list-actions-meta {
      width: 100%;
      justify-content: flex-start;
      gap: var(--space-sm);
    }
  }
</style>
