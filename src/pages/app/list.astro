---
import AppLayout from '../../layouts/AppLayout.astro';
---

<AppLayout title="Lista de la Compra">
  <div class="list-detail-page">
    <a href="/app" class="back-link">‚Üê Volver a listas</a>
    <div id="list-header" class="list-header">
      <div class="list-header-loading">Cargando...</div>
    </div>
    <div id="list-container"></div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import '/components/hc-shopping-list.js';
  import { db } from '/js/firebase-config.js';
  import { doc, onSnapshot, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  import { getCurrentGroupId, getGroup } from '/js/group.js';
  import { updateListMembers } from '/js/lists.js';
  import { toast } from '/js/toast.js';

  let unsubscribe = null;
  let currentListId = null;
  let currentUser = null;
  let groupMembers = [];

  function initPage(user) {
    currentUser = user;

    // Re-leer URL params en cada navegaci√≥n
    const urlParams = new URLSearchParams(window.location.search);
    const listId = urlParams.get('id');
    const ownerId = urlParams.get('owner') || user.uid; // Si no hay owner, es del usuario

    if (!listId) {
      window.location.href = '/app';
      return;
    }

    // Si es la misma lista, no reinicializar
    if (listId === currentListId && unsubscribe) return;

    currentListId = listId;

    const headerEl = document.getElementById('list-header');
    const container = document.getElementById('list-container');
    if (!headerEl || !container) return;

    // Limpiar contenido previo
    container.innerHTML = '';

    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }

    // Cargar miembros del grupo para el selector
    loadGroupMembers();

    // Usar ownerId para la referencia (puede ser de otro usuario)
    const listRef = doc(db, 'users', ownerId, 'lists', listId);
    const isOwner = ownerId === user.uid;

    unsubscribe = onSnapshot(listRef, (snapshot) => {
      const headerEl = document.getElementById('list-header');
      const container = document.getElementById('list-container');
      if (!headerEl) return;

      if (!snapshot.exists()) {
        headerEl.innerHTML = `
          <div class="list-not-found">
            <p>Lista no encontrada</p>
            <a href="/app" class="btn btn-primary">Volver al inicio</a>
          </div>
        `;
        return;
      }

      const list = { id: snapshot.id, ...snapshot.data() };
      const isAgnostic = list.listType === 'agnostic';
      const members = list.members || [];
      const memberCount = members.length;

      // Generar badge de tipo seg√∫n listType
      let typeBadgeHtml = '';
      if (!isAgnostic && list.expenseType) {
        typeBadgeHtml = `
          <span class="type-badge ${list.expenseType === 'shared' ? 'shared' : 'common'}">
            ${list.expenseType === 'shared' ? '‚ûó Dividir' : 'üè† Com√∫n'}
          </span>
        `;
      } else if (isAgnostic) {
        typeBadgeHtml = `<span class="type-badge agnostic">üìù General</span>`;
      }

      // Badge de propietario si no eres t√∫
      const ownerBadge = !isOwner ? `<span class="owner-badge">De ${list.ownerName}</span>` : '';

      // Badge de miembros
      const membersBadge = memberCount > 1 ? `<span class="members-badge" id="members-toggle">üë• ${memberCount}</span>` : '';

      headerEl.innerHTML = `
        <div class="list-title-row">
          <span class="list-icon">${list.icon || (isAgnostic ? 'üìù' : 'üõí')}</span>
          <div class="list-title-info">
            <h1>${list.name}</h1>
            <div class="list-meta">
              ${ownerBadge}
              ${typeBadgeHtml}
              ${membersBadge}
              <span class="status-badge ${list.closed ? 'closed' : 'open'}">
                ${list.closed ? 'Cerrada' : 'Abierta'}
              </span>
            </div>
          </div>
        </div>
        ${isOwner ? `
          <div class="list-actions">
            ${!list.closed ? `
              <button id="close-list-btn" class="btn btn-ghost btn-sm">‚úì Cerrar</button>
            ` : `
              <button id="reopen-list-btn" class="btn btn-ghost btn-sm">‚Ü∫ Reabrir</button>
            `}
            <button id="manage-members-btn" class="btn btn-ghost btn-sm">üë• Miembros</button>
          </div>
        ` : ''}

        <!-- Panel de miembros (oculto por defecto) -->
        <div id="members-panel" class="members-panel" hidden>
          <div class="members-panel-header">
            <h3>Miembros de la lista</h3>
            <button id="close-panel-btn" class="btn-icon">‚úï</button>
          </div>
          <div id="members-panel-content" class="members-panel-content">
            ${isOwner ? '<p class="loading-text">Cargando miembros...</p>' : renderMembersReadonly(list.members || [], list.ownerName)}
          </div>
        </div>
      `;

      // Event listeners
      document.getElementById('close-list-btn')?.addEventListener('click', async () => {
        await updateDoc(listRef, { closed: true, updatedAt: serverTimestamp() });
      });

      document.getElementById('reopen-list-btn')?.addEventListener('click', async () => {
        await updateDoc(listRef, { closed: false, updatedAt: serverTimestamp() });
      });

      document.getElementById('manage-members-btn')?.addEventListener('click', () => {
        const panel = document.getElementById('members-panel');
        if (panel) {
          panel.hidden = !panel.hidden;
          if (!panel.hidden && isOwner) {
            renderMembersEditor(list.members || []);
          }
        }
      });

      document.getElementById('members-toggle')?.addEventListener('click', () => {
        const panel = document.getElementById('members-panel');
        if (panel) panel.hidden = !panel.hidden;
      });

      document.getElementById('close-panel-btn')?.addEventListener('click', () => {
        const panel = document.getElementById('members-panel');
        if (panel) panel.hidden = true;
      });

      if (container && !container.querySelector('hc-shopping-list')) {
        const listComponent = document.createElement('hc-shopping-list');
        listComponent.setAttribute('list-id', listId);
        listComponent.setAttribute('user-id', ownerId); // Usar ownerId para items
        listComponent.setAttribute('list-type', list.listType || 'shopping');
        if (list.closed) {
          listComponent.setAttribute('readonly', 'true');
        }
        container.appendChild(listComponent);
      } else if (container) {
        // Actualizar readonly si la lista ya existe
        const existingComponent = container.querySelector('hc-shopping-list');
        if (existingComponent) {
          if (list.closed) {
            existingComponent.setAttribute('readonly', 'true');
          } else {
            existingComponent.removeAttribute('readonly');
          }
        }
      }
    }, (error) => {
      console.error('Error loading list:', error);
      const headerEl = document.getElementById('list-header');
      if (headerEl) {
        headerEl.innerHTML = `<div class="list-error">Error al cargar la lista</div>`;
      }
    });
  }

  async function loadGroupMembers() {
    const groupId = getCurrentGroupId();
    if (!groupId) return;

    try {
      const group = await getGroup(groupId);
      if (group?.members) {
        groupMembers = Object.entries(group.members)
          .filter(([uid]) => uid !== currentUser.uid)
          .map(([uid, data]) => ({
            uid,
            name: data.displayName || data.email?.split('@')[0] || 'Usuario'
          }));
      }
    } catch (e) {
      console.warn('Error loading group members:', e);
    }
  }

  function renderMembersReadonly(memberUids, ownerName) {
    return `
      <div class="members-readonly">
        <p>Propietario: <strong>${ownerName}</strong></p>
        <p>${memberUids.length} miembro${memberUids.length !== 1 ? 's' : ''} en total</p>
      </div>
    `;
  }

  function renderMembersEditor(currentMembers) {
    const content = document.getElementById('members-panel-content');
    if (!content) return;

    if (groupMembers.length === 0) {
      content.innerHTML = `
        <div class="no-members-to-add">
          <p>No hay otros miembros en tu grupo.</p>
          <a href="/app/groups" class="btn btn-sm">Ir a grupos</a>
        </div>
      `;
      return;
    }

    content.innerHTML = `
      <form id="members-form" class="members-form">
        ${groupMembers.map(member => `
          <label class="member-row">
            <input type="checkbox" name="member" value="${member.uid}"
              ${currentMembers.includes(member.uid) ? 'checked' : ''} />
            <span>${member.name}</span>
          </label>
        `).join('')}
        <button type="submit" class="btn btn-primary btn-sm btn-full">Guardar</button>
      </form>
    `;

    document.getElementById('members-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const checked = Array.from(content.querySelectorAll('input[name="member"]:checked'))
        .map(cb => cb.value);

      try {
        await updateListMembers(currentListId, checked);
        toast.success('Miembros actualizados');
        document.getElementById('members-panel').hidden = true;
      } catch (error) {
        toast.error('Error: ' + error.message);
      }
    });
  }

  function tryInit() {
    // Solo ejecutar si estamos en la p√°gina de lista
    if (!window.location.pathname.startsWith('/app/list')) return;

    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) initPage(user);
    } else {
      window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);

  document.addEventListener('astro:before-swap', () => {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = null;
    }
    currentListId = null;
  });
</script>

<style is:global>
  .list-detail-page {
    max-width: 800px;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .list-header {
    margin-bottom: var(--space-xl);
  }

  .list-header-loading {
    color: var(--color-text-secondary);
    padding: var(--space-lg);
  }

  .list-title-row {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
  }

  .list-icon {
    font-size: 2.5rem;
  }

  .list-title-info h1 {
    margin-bottom: var(--space-xs);
  }

  .list-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    align-items: center;
  }

  .type-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .type-badge.common {
    background: #e0f2fe;
    color: #0369a1;
  }

  .type-badge.shared {
    background: #fef3c7;
    color: #92400e;
  }

  .type-badge.agnostic {
    background: #f3e8ff;
    color: #7c3aed;
  }

  .store-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    background: #f3f4f6;
    color: #6b7280;
  }

  .status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .status-badge.open {
    background: #dcfce7;
    color: #166534;
  }

  .status-badge.closed {
    background: #f3f4f6;
    color: #6b7280;
  }

  .list-actions {
    display: flex;
    gap: var(--space-sm);
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-md);
    font-size: var(--font-size-sm);
  }

  .list-not-found,
  .list-error {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .list-not-found p {
    margin-bottom: var(--space-md);
  }

  /* Owner badge */
  .owner-badge {
    font-size: var(--font-size-xs);
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  /* Members badge clickable */
  .members-badge {
    font-size: var(--font-size-xs);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    background: var(--color-bg-secondary);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .members-badge:hover {
    background: var(--color-border);
  }

  /* Members Panel */
  .members-panel {
    margin-top: var(--space-md);
    padding: var(--space-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .members-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .members-panel-header h3 {
    font-size: var(--font-size-sm);
    font-weight: 600;
    margin: 0;
  }

  .btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-xs);
    color: var(--color-text-secondary);
    font-size: var(--font-size-md);
    line-height: 1;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
  }

  .btn-icon:hover {
    background: var(--color-bg);
    color: var(--color-text);
  }

  .members-panel-content {
    font-size: var(--font-size-sm);
  }

  /* Members readonly view */
  .members-readonly {
    color: var(--color-text-secondary);
  }

  .members-readonly p {
    margin: 0 0 var(--space-xs) 0;
  }

  .members-readonly strong {
    color: var(--color-text);
  }

  /* Members form (editor) */
  .members-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .member-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-bg);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background var(--transition-fast);
  }

  .member-row:hover {
    background: var(--color-border);
  }

  .member-row input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--color-primary);
  }

  .member-row span {
    flex: 1;
  }

  .no-members-to-add {
    text-align: center;
    color: var(--color-text-secondary);
    padding: var(--space-md);
  }

  .no-members-to-add p {
    margin-bottom: var(--space-sm);
  }

  .btn-full {
    width: 100%;
  }

  .loading-text {
    color: var(--color-text-secondary);
    font-style: italic;
  }

  @media (max-width: 480px) {
    .list-title-row {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .list-meta {
      justify-content: center;
    }

    .list-actions {
      justify-content: center;
    }
  }
</style>
