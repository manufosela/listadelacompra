---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Escanear Ticket">
  <div class="upload-page">
    <a href="/app/tickets" class="back-link">‚Üê Volver a tickets</a>
    <h1>Escanear Ticket</h1>
    <p class="page-description">
      Sube una foto de tu ticket de compra y la IA extraer√° los productos autom√°ticamente.
    </p>

    <div class="purchase-options" id="purchase-options">
      <div class="form-group">
        <label for="list-select">Asociar a lista (opcional)</label>
        <select id="list-select" class="form-select">
          <option value="">Sin lista asociada</option>
        </select>
        <small class="form-hint">Si asocias a una lista, los costes se repartir√°n seg√∫n el tipo de gasto</small>
      </div>

      <div class="form-group" id="purchase-type-group" style="display: none;">
        <label>Tipo de compra</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="purchase-type" value="total" checked />
            <span class="radio-label">
              <strong>Compra total</strong>
              <small>Compr√© todo lo de la lista</small>
            </span>
          </label>
          <label class="radio-option">
            <input type="radio" name="purchase-type" value="partial" />
            <span class="radio-label">
              <strong>Compra parcial</strong>
              <small>Solo compr√© algunos productos</small>
            </span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="paid-by-select">Pagado por</label>
        <select id="paid-by-select" class="form-select">
          <option value="">Cargando miembros...</option>
        </select>
      </div>
    </div>

    <hc-ticket-scanner></hc-ticket-scanner>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { toast } from '/js/toast.js';
  import '/components/hc-ticket-scanner.js';
  import { getCurrentGroupId, getGroup } from '/js/group.js';
  import { db } from '/js/firebase-config.js';
  import {
    collection,
    doc,
    getDoc,
    getDocs,
    addDoc,
    query,
    where,
    orderBy,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

  let lists = [];
  let members = [];
  let currentUser = null;
  let groupId = null;

  async function initPage(user) {
    const purchaseOptions = document.getElementById('purchase-options');
    if (!purchaseOptions) return;

    currentUser = user;
    groupId = getCurrentGroupId();

    if (!groupId) {
      purchaseOptions.innerHTML = `
        <div class="warning">Debes tener un grupo configurado para registrar compras.</div>
      `;
      return;
    }

    await loadListsAndMembers();
  }

  function tryInit() {
    if (isAuthResolved()) {
      const user = getCurrentUser();
      if (user) initPage(user);
    } else {
      window.addEventListener('auth-ready', (e) => initPage(e.detail.user), { once: true });
    }
  }

  // Ejecutar en carga inicial
  tryInit();

  // Re-ejecutar en navegaciones con View Transitions
  document.addEventListener('astro:page-load', tryInit);

  async function loadListsAndMembers() {
    // Cargar listas del usuario que tienen este grupo
    const listsRef = collection(db, 'users', currentUser.uid, 'lists');
    const q = query(listsRef, orderBy('updatedAt', 'desc'));
    const listsSnapshot = await getDocs(q);

    lists = listsSnapshot.docs
      .map(doc => ({ id: doc.id, ...doc.data() }))
      .filter(list => list.groupIds?.includes(groupId));

    // Cargar miembros del grupo
    const group = await getGroup(groupId);
    if (group?.members) {
      members = Object.entries(group.members).map(([id, data]) => ({
        id,
        ...data
      }));
    }

    // Actualizar selects (verificar que existen)
    const listSelect = document.getElementById('list-select');
    const purchaseTypeGroup = document.getElementById('purchase-type-group');

    if (listSelect) {
      listSelect.innerHTML = `
        <option value="">Sin lista asociada (gasto com√∫n)</option>
        ${lists.map(list => `
          <option value="${list.id}" data-expense-type="${list.expenseType || 'common'}">
            ${list.icon || 'üõí'} ${list.name}
            ${list.expenseType === 'shared' ? '(a dividir)' : '(com√∫n)'}
          </option>
        `).join('')}
      `;

      // Mostrar/ocultar opci√≥n de tipo de compra seg√∫n selecci√≥n de lista
      listSelect.addEventListener('change', () => {
        if (purchaseTypeGroup) {
          purchaseTypeGroup.style.display = listSelect.value ? 'block' : 'none';
        }
      });
    }

    const paidBySelect = document.getElementById('paid-by-select');
    if (paidBySelect) {
      paidBySelect.innerHTML = members.map(member => `
        <option value="${member.id}" ${member.id === currentUser.uid ? 'selected' : ''}>
          ${member.displayName || member.email}
        </option>
      `).join('');
    }
  }

  async function calculateDistribution(ticketData, listId, paidById) {
    const totalAmount = ticketData.total || 0;
    const distribution = {};

    if (!listId) {
      // Sin lista: dividir equitativamente entre todos los miembros
      const perPerson = totalAmount / members.length;
      members.forEach(member => {
        distribution[member.id] = {
          amount: perPerson,
          items: []
        };
      });
    } else {
      // Con lista: obtener tipo de gasto y asignaciones
      const list = lists.find(l => l.id === listId);

      if (list?.expenseType === 'shared') {
        // Gasto a dividir: distribuir seg√∫n asignaciones de items
        const itemsRef = collection(db, 'users', currentUser.uid, 'lists', listId, 'items');
        const itemsSnapshot = await getDocs(itemsRef);
        const listItems = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Crear mapa de items del ticket a items de la lista
        const ticketItems = ticketData.items || [];
        let unassignedTotal = 0;

        ticketItems.forEach(ticketItem => {
          // Buscar item correspondiente en la lista por nombre similar
          const matchedListItem = listItems.find(li =>
            li.name?.toLowerCase().includes(ticketItem.name?.toLowerCase()) ||
            ticketItem.name?.toLowerCase().includes(li.name?.toLowerCase())
          );

          const itemPrice = ticketItem.totalPrice || 0;

          if (matchedListItem?.assignedTo) {
            // Item asignado a alguien
            if (!distribution[matchedListItem.assignedTo]) {
              distribution[matchedListItem.assignedTo] = { amount: 0, items: [] };
            }
            distribution[matchedListItem.assignedTo].amount += itemPrice;
            distribution[matchedListItem.assignedTo].items.push(ticketItem.name);
          } else {
            // Item no asignado: se acumula para dividir despu√©s
            unassignedTotal += itemPrice;
          }
        });

        // Dividir items no asignados entre todos los miembros
        if (unassignedTotal > 0 && members.length > 0) {
          const perPerson = unassignedTotal / members.length;
          members.forEach(member => {
            if (!distribution[member.id]) {
              distribution[member.id] = { amount: 0, items: [] };
            }
            distribution[member.id].amount += perPerson;
          });
        }
      } else {
        // Gasto com√∫n: dividir equitativamente
        const perPerson = totalAmount / members.length;
        members.forEach(member => {
          distribution[member.id] = {
            amount: perPerson,
            items: []
          };
        });
      }
    }

    // Ajustar: quien pag√≥ no se debe a s√≠ mismo
    // Los dem√°s deben su parte a quien pag√≥
    const debts = {};
    Object.entries(distribution).forEach(([memberId, data]) => {
      if (memberId !== paidById) {
        debts[memberId] = {
          owesTo: paidById,
          amount: data.amount,
          items: data.items
        };
      }
    });

    return { distribution, debts };
  }

  document.addEventListener('ticket-confirmed', async (e) => {
    if (!groupId) {
      toast.error('Debes tener un grupo configurado');
      return;
    }

    const ticketData = e.detail.ticketData;
    const listId = document.getElementById('list-select').value || null;
    const paidById = document.getElementById('paid-by-select').value;
    const purchaseType = document.querySelector('input[name="purchase-type"]:checked')?.value || 'total';

    if (!paidById) {
      toast.warning('Selecciona qui√©n pag√≥ esta compra');
      return;
    }

    try {
      // Calcular distribuci√≥n
      const { distribution, debts } = await calculateDistribution(ticketData, listId, paidById);

      // Crear registro de compra
      const purchasesRef = collection(db, 'groups', groupId, 'purchases');
      await addDoc(purchasesRef, {
        store: ticketData.store || 'Desconocida',
        date: ticketData.date ? new Date(ticketData.date) : serverTimestamp(),
        totalAmount: ticketData.total || 0,
        items: ticketData.items || [],
        listId: listId,
        purchaseType: listId ? purchaseType : null,
        paidBy: paidById,
        distribution: distribution,
        debts: debts,
        createdBy: currentUser?.uid,
        createdAt: serverTimestamp()
      });

      // Redirigir despu√©s de 2 segundos
      setTimeout(() => {
        window.location.href = '/app/tickets';
      }, 2000);
    } catch (error) {
      console.error('Error saving purchase:', error);
      toast.error('Error al guardar la compra: ' + error.message);
    }
  });
</script>

<style>
  .upload-page {
    max-width: 600px;
    margin: 0 auto;
  }

  .back-link {
    display: inline-block;
    margin-bottom: var(--space-lg);
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  h1 {
    margin-bottom: var(--space-xs);
  }

  .page-description {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-lg);
  }

  .purchase-options {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
  }

  .form-group {
    margin-bottom: var(--space-md);
  }

  .form-group:last-child {
    margin-bottom: 0;
  }

  .form-group label {
    display: block;
    font-weight: 500;
    margin-bottom: var(--space-xs);
  }

  .form-select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    background: white;
  }

  .form-select:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-hint {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-top: var(--space-xs);
  }

  .warning {
    padding: var(--space-md);
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: var(--radius-md);
    color: #92400e;
  }

  .radio-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .radio-option {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .radio-option:hover {
    border-color: var(--color-primary);
  }

  .radio-option:has(input:checked) {
    border-color: var(--color-primary);
    background: rgba(37, 99, 235, 0.05);
  }

  .radio-option input {
    margin-top: 0.25rem;
  }

  .radio-label {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .radio-label strong {
    font-weight: 500;
  }

  .radio-label small {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }
</style>
