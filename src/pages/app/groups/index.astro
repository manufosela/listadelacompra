---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Grupos">
  <div class="groups-page">
    <header class="page-header">
      <div>
        <h1>Grupos</h1>
        <p>Gestiona tus grupos compartidos</p>
      </div>
      <button id="add-group-btn" class="btn btn-primary">+ Nuevo grupo</button>
    </header>

    <div id="groups-list" class="groups-list">
      <p class="loading">Cargando grupos...</p>
    </div>
  </div>

  <!-- Modal para nuevo grupo -->
  <dialog id="group-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title">Nuevo Grupo</h2>

      <div class="modal-tabs">
        <button class="tab active" data-tab="create">Crear grupo</button>
        <button class="tab" data-tab="join">Unirse con código</button>
      </div>

      <form id="create-form" class="tab-content active" data-tab="create">
        <div class="form-group">
          <label for="group-name">Nombre del grupo</label>
          <input type="text" id="group-name" placeholder="Ej: Familia García" required />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancel-create">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear grupo</button>
        </div>
      </form>

      <form id="join-form" class="tab-content" data-tab="join">
        <div class="form-group">
          <label for="invite-code">Código de invitación</label>
          <input type="text" id="invite-code" placeholder="XXXXXX" maxlength="6" required />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancel-join">Cancelar</button>
          <button type="submit" class="btn btn-primary">Unirse</button>
        </div>
      </form>
    </div>
  </dialog>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { toast } from '/js/toast.js';
  import { modal as confirmModal } from '/js/modal.js';
  import {
    getGroup,
    getUserGroups,
    getCurrentGroupId,
    setCurrentGroup,
    createGroup,
    joinGroupWithCode
  } from '/js/group.js';

  let currentGroupId = null;

  async function loadGroups() {
    const container = document.getElementById('groups-list');
    if (!container) return;

    currentGroupId = getCurrentGroupId();

    try {
      const groups = await getUserGroups();

      if (groups.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No perteneces a ningún grupo.</p>
            <button id="first-group-btn" class="btn btn-primary">Crear mi primer grupo</button>
          </div>
        `;
        document.getElementById('first-group-btn')?.addEventListener('click', () => {
          groupModal?.showModal();
        });
        return;
      }

      container.innerHTML = `
        <table class="groups-table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Miembros</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${groups.map(g => `
              <tr data-id="${g.id}" class="${g.id === currentGroupId ? 'active' : ''}">
                <td class="group-name">${g.name}</td>
                <td class="group-members">${Object.keys(g.members || {}).length}</td>
                <td class="group-status">
                  ${g.id === currentGroupId
                    ? '<span class="badge badge-primary">Activo</span>'
                    : '<button class="btn btn-sm btn-secondary select-group-btn">Seleccionar</button>'}
                </td>
                <td class="group-actions">
                  <button class="btn btn-sm btn-ghost manage-btn">Gestionar</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      // Event listeners para seleccionar grupo
      container.querySelectorAll('.select-group-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const groupId = row.dataset.id;
          setCurrentGroup(groupId);
          toast.success('Grupo seleccionado');
          loadGroups(); // Recargar para actualizar UI
        });
      });

      // Event listeners para gestionar grupo
      container.querySelectorAll('.manage-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const groupId = row.dataset.id;
          window.location.href = `/app/groups/manage?id=${groupId}`;
        });
      });
    } catch (error) {
      console.error('Error loading groups:', error);
      container.innerHTML = '<p class="error">Error al cargar los grupos.</p>';
    }
  }

  function tryInit() {
    if (isAuthResolved()) {
      if (getCurrentUser()) loadGroups();
    } else {
      window.addEventListener('auth-ready', () => loadGroups(), { once: true });
    }
  }

  // Ejecutar en carga inicial
  tryInit();

  // Re-ejecutar en navegaciones con View Transitions
  document.addEventListener('astro:page-load', tryInit);

  // Modal
  const groupModal = document.getElementById('group-modal');
  const addGroupBtn = document.getElementById('add-group-btn');
  const createForm = document.getElementById('create-form');
  const joinForm = document.getElementById('join-form');

  addGroupBtn?.addEventListener('click', () => groupModal?.showModal());

  // Tabs
  document.querySelectorAll('.modal-tabs .tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.modal-tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      tab.classList.add('active');
      const targetTab = tab.dataset.tab;
      document.querySelector(`.tab-content[data-tab="${targetTab}"]`)?.classList.add('active');
    });
  });

  // Cancel buttons
  document.getElementById('cancel-create')?.addEventListener('click', () => groupModal?.close());
  document.getElementById('cancel-join')?.addEventListener('click', () => groupModal?.close());

  // Crear grupo
  createForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('group-name')?.value;
    if (!name) return;

    try {
      await createGroup(name);
      toast.success('Grupo creado');
      groupModal?.close();
      loadGroups();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });

  // Unirse con código
  joinForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = document.getElementById('invite-code')?.value;
    if (!code) return;

    try {
      await joinGroupWithCode(code);
      toast.success('Te has unido al grupo');
      groupModal?.close();
      loadGroups();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });
</script>

<style>
  .groups-page {
    max-width: 800px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
  }

  .page-header h1 {
    margin-bottom: var(--space-xs);
  }

  .page-header p {
    color: var(--color-text-secondary);
  }

  .groups-list {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .groups-table {
    width: 100%;
    border-collapse: collapse;
  }

  .groups-table th,
  .groups-table td {
    padding: var(--space-md);
    text-align: left;
  }

  .groups-table th {
    background: var(--color-bg-secondary);
    font-weight: 500;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .groups-table tr:not(:last-child) td {
    border-bottom: 1px solid var(--color-border);
  }

  .groups-table tr.active {
    background: rgba(37, 99, 235, 0.05);
  }

  .group-name {
    font-weight: 500;
  }

  .group-members {
    color: var(--color-text-secondary);
  }

  .group-actions {
    text-align: right;
  }

  .badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: 500;
  }

  .badge-primary {
    background: rgba(37, 99, 235, 0.1);
    color: var(--color-primary);
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
  }

  .btn-ghost {
    background: transparent;
    color: var(--color-text-secondary);
  }

  .btn-ghost:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .modal {
    border: none;
    border-radius: var(--radius-lg);
    padding: 0;
    max-width: 450px;
    width: 90%;
  }

  .modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    padding: var(--space-xl);
  }

  .modal-content h2 {
    margin-bottom: var(--space-lg);
  }

  .modal-tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
    padding-bottom: var(--space-sm);
  }

  .tab {
    padding: var(--space-sm) var(--space-md);
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .tab:hover {
    background: var(--color-bg-secondary);
  }

  .tab.active {
    background: var(--color-primary);
    color: white;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .form-group {
    margin-bottom: var(--space-lg);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
  }

  .form-group input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
  }

  .modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .empty-state .btn {
    margin-top: var(--space-md);
  }

  .loading,
  .error {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .error {
    color: var(--color-danger);
  }
</style>
