---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Gestionar Grupo">
  <div class="manage-page">
    <a href="/app/groups" class="back-link">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
      Grupos
    </a>

    <div id="group-content" class="group-content">
      <div class="loading-state">Cargando...</div>
    </div>
  </div>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { toast } from '/js/toast.js';
  import { modal as confirmModal } from '/js/modal.js';
  import { db } from '/js/firebase-config.js';
  import {
    doc,
    getDoc,
    updateDoc,
    deleteDoc,
    deleteField
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  import {
    getCurrentGroupId,
    setCurrentGroup,
    inviteUserByEmail,
    getGroupInvitations,
    deleteInvitation
  } from '/js/group.js';

  let groupId = null;
  let groupData = null;
  let currentUser = null;
  let invitations = [];

  function getGroupIdFromUrl() {
    const urlParams = new URLSearchParams(globalThis.location.search);
    return urlParams.get('id');
  }

  async function loadGroup() {
    const container = document.getElementById('group-content');
    if (!container) return;

    groupId = getGroupIdFromUrl();
    if (!groupId) {
      container.innerHTML = '<div class="error-state">ID de grupo no especificado</div>';
      return;
    }

    try {
      const groupRef = doc(db, 'groups', groupId);
      const groupSnap = await getDoc(groupRef);

      if (!groupSnap.exists()) {
        container.innerHTML = `
          <div class="error-state">
            <p>Grupo no encontrado</p>
            <a href="/app/groups" class="btn btn-primary">Volver a grupos</a>
          </div>
        `;
        return;
      }

      groupData = { id: groupSnap.id, ...groupSnap.data() };
      const members = groupData.members || {};
      const membersList = Object.entries(members);
      const isAdmin = members[currentUser.uid]?.role === 'admin';
      const isCreator = groupData.createdBy === currentUser.uid;
      const currentGroupActive = getCurrentGroupId() === groupId;

      // Load invitations if admin
      invitations = isAdmin ? await getGroupInvitations(groupId) : [];
      const pendingInvitations = invitations.filter(i => i.status === 'pending');

      container.innerHTML = `
        <!-- Header -->
        <header class="page-header">
          <div class="header-main">
            <div class="header-title">
              <h1 id="group-name-display">${groupData.name}</h1>
              ${isAdmin ? `
                <button id="edit-name-btn" class="btn-icon" title="Editar nombre" aria-label="Editar nombre">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
              ` : ''}
            </div>
            <div class="header-meta">
              <span>${membersList.length} miembro${membersList.length !== 1 ? 's' : ''}</span>
              ${currentGroupActive ? '<span class="status-badge">Activo</span>' : ''}
            </div>
          </div>
        </header>

        <!-- Miembros -->
        <section class="section">
          <h2 class="section-title">Miembros</h2>
          <div class="members-row">
            ${membersList.map(([uid, member]) => `
              <div class="member-chip ${uid === currentUser.uid ? 'is-you' : ''}" data-uid="${uid}">
                <div class="member-avatar">
                  ${member.photoURL
                    ? `<img src="${member.photoURL}" alt="" loading="lazy">`
                    : `<span>${(member.displayName || member.email || '?')[0].toUpperCase()}</span>`
                  }
                </div>
                <span class="member-name">${member.displayName || member.email?.split('@')[0]}${uid === currentUser.uid ? ' (tú)' : ''}</span>
                ${member.role === 'admin' ? '<span class="member-badge">Admin</span>' : ''}
                ${isAdmin && uid !== currentUser.uid ? `
                  <button class="chip-remove remove-member-btn" data-uid="${uid}" title="Eliminar" aria-label="Eliminar miembro">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                  </button>
                ` : ''}
              </div>
            `).join('')}
          </div>
        </section>

        <!-- Invitar (solo admin) -->
        ${isAdmin ? `
          <section class="section">
            <h2 class="section-title">Invitar</h2>
            <form id="invite-form" class="invite-form">
              <input
                type="email"
                id="invite-email"
                placeholder="email@ejemplo.com"
                autocomplete="off"
                required
              />
              <button type="submit" class="btn btn-primary">Enviar invitación</button>
            </form>
            ${pendingInvitations.length > 0 ? `
              <div class="pending-list">
                <span class="pending-label">${pendingInvitations.length} pendiente${pendingInvitations.length !== 1 ? 's' : ''}:</span>
                ${pendingInvitations.map(inv => `
                  <span class="pending-chip">
                    ${inv.invitedEmail}
                    <button class="chip-remove delete-invitation-btn" data-id="${inv.id}" title="Cancelar" aria-label="Cancelar invitación">
                      <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M18 6L6 18M6 6l12 12"/>
                      </svg>
                    </button>
                  </span>
                `).join('')}
              </div>
            ` : ''}
          </section>
        ` : ''}

        <!-- Historial de invitaciones (solo admin, colapsable) -->
        ${isAdmin && invitations.length > pendingInvitations.length ? `
          <details class="section-collapsible">
            <summary>
              <span>Historial de invitaciones</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </summary>
            <div class="invitations-history">
              ${invitations.filter(i => i.status !== 'pending').map(inv => {
                const statusLabels = {
                  accepted: 'Aceptada',
                  rejected: 'Rechazada',
                  expired: 'Expirada'
                };
                return `
                  <div class="history-row">
                    <span class="history-email">${inv.invitedEmail}</span>
                    <span class="history-status status-${inv.status}">${statusLabels[inv.status] || inv.status}</span>
                    <button class="btn-icon btn-icon-sm delete-invitation-btn" data-id="${inv.id}" title="Eliminar">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                      </svg>
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </details>
        ` : ''}

        <!-- Zona de peligro -->
        <details class="section-danger">
          <summary>
            <span>Zona de peligro</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"/>
            </svg>
          </summary>
          <div class="danger-content">
            ${!isCreator ? `
              <div class="danger-row">
                <div class="danger-info">
                  <strong>Abandonar grupo</strong>
                  <p>Perderás acceso a las listas compartidas.</p>
                </div>
                <button id="leave-group-btn" class="btn btn-danger-outline">Abandonar</button>
              </div>
            ` : ''}
            ${isCreator ? `
              <div class="danger-row">
                <div class="danger-info">
                  <strong>Eliminar grupo</strong>
                  <p>Se eliminarán todos los datos permanentemente.</p>
                </div>
                <button id="delete-group-btn" class="btn btn-danger">Eliminar</button>
              </div>
            ` : ''}
          </div>
        </details>
      `;

      setupEventListeners(isAdmin, isCreator);
    } catch (error) {
      console.error('Error loading group:', error);
      container.innerHTML = '<div class="error-state">Error al cargar el grupo</div>';
    }
  }

  function setupEventListeners(isAdmin, isCreator) {
    // Editar nombre
    document.getElementById('edit-name-btn')?.addEventListener('click', async () => {
      const newName = prompt('Nuevo nombre del grupo:', groupData.name);
      if (newName && newName.trim() && newName !== groupData.name) {
        try {
          const groupRef = doc(db, 'groups', groupId);
          await updateDoc(groupRef, { name: newName.trim() });
          toast.success('Nombre actualizado');
          loadGroup();
        } catch (error) {
          toast.error('Error al actualizar: ' + error.message);
        }
      }
    });

    // Enviar invitación por email
    document.getElementById('invite-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('invite-email');
      const email = emailInput?.value?.trim();
      if (!email) return;

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';

      try {
        await inviteUserByEmail(groupId, email);
        toast.success(`Invitación enviada a ${email}`);
        emailInput.value = '';
        loadGroup();
      } catch (error) {
        toast.error(error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar invitación';
      }
    });

    // Eliminar invitación
    document.querySelectorAll('.delete-invitation-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const invitationId = btn.dataset.id;

        const confirmed = await confirmModal.confirm(
          '¿Eliminar esta invitación?',
          'El usuario ya no podrá unirse con esta invitación.'
        );

        if (confirmed) {
          try {
            await deleteInvitation(invitationId);
            toast.success('Invitación eliminada');
            loadGroup();
          } catch (error) {
            toast.error('Error: ' + error.message);
          }
        }
      });
    });

    // Eliminar miembro
    document.querySelectorAll('.remove-member-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const uid = btn.dataset.uid;
        const member = groupData.members[uid];

        const confirmed = await confirmModal.confirm(
          `¿Eliminar a ${member.displayName || member.email}?`,
          'Esta acción no se puede deshacer.'
        );

        if (confirmed) {
          try {
            const groupRef = doc(db, 'groups', groupId);
            await updateDoc(groupRef, {
              [`members.${uid}`]: deleteField()
            });
            toast.success('Miembro eliminado');
            loadGroup();
          } catch (error) {
            toast.error('Error: ' + error.message);
          }
        }
      });
    });

    // Abandonar grupo
    document.getElementById('leave-group-btn')?.addEventListener('click', async () => {
      const confirmed = await confirmModal.confirm(
        '¿Abandonar este grupo?',
        'Perderás acceso a las listas compartidas.'
      );

      if (confirmed) {
        try {
          const groupRef = doc(db, 'groups', groupId);
          await updateDoc(groupRef, {
            [`members.${currentUser.uid}`]: deleteField()
          });

          if (getCurrentGroupId() === groupId) {
            setCurrentGroup(null);
          }

          toast.success('Has abandonado el grupo');
          globalThis.location.href = '/app/groups';
        } catch (error) {
          toast.error('Error: ' + error.message);
        }
      }
    });

    // Eliminar grupo
    document.getElementById('delete-group-btn')?.addEventListener('click', async () => {
      const confirmed = await confirmModal.confirm(
        '¿Eliminar este grupo?',
        'Se eliminarán todas las listas y datos. Esta acción no se puede deshacer.'
      );

      if (confirmed) {
        try {
          const groupRef = doc(db, 'groups', groupId);
          await deleteDoc(groupRef);

          if (getCurrentGroupId() === groupId) {
            setCurrentGroup(null);
          }

          toast.success('Grupo eliminado');
          globalThis.location.href = '/app/groups';
        } catch (error) {
          toast.error('Error: ' + error.message);
        }
      }
    });
  }

  function tryInit() {
    if (isAuthResolved()) {
      currentUser = getCurrentUser();
      if (currentUser) loadGroup();
    } else {
      globalThis.addEventListener('auth-ready', (e) => {
        currentUser = e.detail.user;
        loadGroup();
      }, { once: true });
    }
  }

  tryInit();
  document.addEventListener('astro:page-load', tryInit);
</script>

<style is:global>
  /* ========================================
     PAGE LAYOUT
     ======================================== */
  .manage-page {
    max-width: 560px;
    margin: 0 auto;
  }

  /* ========================================
     BACK LINK
     ======================================== */
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    text-decoration: none;
    margin-bottom: var(--space-lg);
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-text);
  }

  /* ========================================
     HEADER
     ======================================== */
  .page-header {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }

  .header-title {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .header-title h1 {
    font-size: var(--font-size-xl);
    font-weight: 600;
    letter-spacing: -0.025em;
    margin: 0;
  }

  .header-meta {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: 4px;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    border-radius: var(--radius-full);
  }

  /* ========================================
     SECTIONS
     ======================================== */
  .section {
    margin-bottom: var(--space-xl);
  }

  .section-title {
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-md) 0;
  }

  /* ========================================
     MEMBERS ROW - Horizontal chips
     ======================================== */
  .members-row {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .member-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px 4px 4px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    transition: all var(--transition-fast);
  }

  .member-chip:hover {
    background: var(--color-bg-tertiary);
  }

  .member-chip.is-you {
    background: rgba(37, 99, 235, 0.06);
    border-color: rgba(37, 99, 235, 0.2);
  }

  .member-avatar {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--color-text-tertiary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    font-weight: 600;
    overflow: hidden;
    flex-shrink: 0;
  }

  .member-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .member-name {
    color: var(--color-text);
    font-weight: 500;
  }

  .member-badge {
    padding: 1px 5px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    color: var(--color-primary);
    background: rgba(37, 99, 235, 0.1);
    border-radius: var(--radius-sm);
  }

  .chip-remove {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    margin-left: 2px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    color: var(--color-text-tertiary);
    transition: all var(--transition-fast);
  }

  .chip-remove:hover {
    background: var(--color-danger);
    color: white;
  }

  /* ========================================
     INVITE FORM
     ======================================== */
  .invite-form {
    display: flex;
    gap: var(--space-sm);
  }

  .invite-form input {
    flex: 1;
    min-width: 0;
    padding: 8px 12px;
    font-size: var(--font-size-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    transition: border-color var(--transition-fast);
  }

  .invite-form input:focus {
    outline: none;
    border-color: var(--color-text);
  }

  .invite-form input::placeholder {
    color: var(--color-text-tertiary);
  }

  /* Pending invitations */
  .pending-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .pending-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .pending-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 6px 3px 8px;
    font-size: var(--font-size-xs);
    color: var(--color-warning);
    background: rgba(245, 158, 11, 0.1);
    border-radius: var(--radius-sm);
  }

  /* ========================================
     COLLAPSIBLE SECTIONS
     ======================================== */
  .section-collapsible,
  .section-danger {
    margin-bottom: var(--space-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .section-collapsible summary,
  .section-danger summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text-secondary);
    background: var(--color-bg);
    cursor: pointer;
    user-select: none;
    list-style: none;
  }

  .section-collapsible summary::-webkit-details-marker,
  .section-danger summary::-webkit-details-marker {
    display: none;
  }

  .section-collapsible summary svg,
  .section-danger summary svg {
    transition: transform var(--transition-fast);
  }

  .section-collapsible[open] summary svg,
  .section-danger[open] summary svg {
    transform: rotate(180deg);
  }

  .section-collapsible[open] summary,
  .section-danger[open] summary {
    border-bottom: 1px solid var(--color-border);
  }

  /* Invitations history */
  .invitations-history {
    padding: var(--space-sm);
    background: var(--color-bg-secondary);
  }

  .history-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
  }

  .history-row:hover {
    background: var(--color-bg);
  }

  .history-email {
    flex: 1;
    min-width: 0;
    font-size: var(--font-size-xs);
    color: var(--color-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .history-status {
    font-size: 10px;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
  }

  .history-status.status-accepted {
    color: var(--color-success);
    background: rgba(34, 197, 94, 0.1);
  }

  .history-status.status-rejected {
    color: var(--color-danger);
    background: rgba(239, 68, 68, 0.1);
  }

  .history-status.status-expired {
    color: var(--color-text-tertiary);
    background: var(--color-bg-tertiary);
  }

  /* Danger zone */
  .section-danger summary {
    color: var(--color-danger);
  }

  .danger-content {
    padding: var(--space-md);
    background: rgba(239, 68, 68, 0.02);
  }

  .danger-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-md);
  }

  .danger-row + .danger-row {
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }

  .danger-info strong {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: 2px;
  }

  .danger-info p {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* ========================================
     BUTTONS
     ======================================== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xs);
    padding: 8px 14px;
    font-size: var(--font-size-sm);
    font-weight: 500;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .btn-primary {
    background: var(--color-text);
    color: var(--color-bg);
  }

  .btn-primary:hover {
    background: var(--color-text-secondary);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-danger {
    background: var(--color-danger);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-danger-outline {
    background: transparent;
    color: var(--color-danger);
    border: 1px solid var(--color-danger);
  }

  .btn-danger-outline:hover {
    background: var(--color-danger);
    color: white;
  }

  .btn-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    border-radius: var(--radius-md);
    cursor: pointer;
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
  }

  .btn-icon:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .btn-icon-sm {
    width: 24px;
    height: 24px;
  }

  .btn-icon-sm:hover {
    color: var(--color-danger);
    background: rgba(239, 68, 68, 0.1);
  }

  /* ========================================
     STATES
     ======================================== */
  .loading-state,
  .error-state {
    text-align: center;
    padding: var(--space-2xl);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .error-state {
    color: var(--color-danger);
  }

  /* ========================================
     RESPONSIVE
     ======================================== */
  @media (max-width: 480px) {
    .invite-form {
      flex-direction: column;
    }

    .invite-form .btn {
      width: 100%;
    }

    .danger-row {
      flex-direction: column;
      align-items: stretch;
      gap: var(--space-sm);
    }

    .danger-row .btn {
      width: 100%;
    }
  }
</style>
