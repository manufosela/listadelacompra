---
import AppLayout from '../../../layouts/AppLayout.astro';
---

<AppLayout title="Productos">
  <div class="products-page">
    <header class="page-header">
      <div>
        <h1>Productos</h1>
        <p>Cat√°logo de productos de tu grupo</p>
      </div>
      <button id="add-product-btn" class="btn btn-primary">+ Nuevo producto</button>
    </header>

    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="search-input" placeholder="Buscar productos..." />
    </div>

    <div id="products-list" class="products-list">
      <p class="loading">Cargando productos...</p>
    </div>
  </div>

  <dialog id="product-modal" class="modal">
    <form id="product-form" method="dialog" class="modal-content">
      <h2 id="modal-title">Nuevo Producto</h2>
      <input type="hidden" id="product-id" />

      <div class="form-group">
        <label for="product-name">Nombre *</label>
        <input type="text" id="product-name" placeholder="ej: leche, pan, tomates..." required />
        <small class="form-hint">Se mantiene el uso de may√∫sculas/min√∫sculas</small>
      </div>

      <div class="form-group">
        <label for="product-category">Categor√≠a</label>
        <select id="product-category" class="category-select"></select>
      </div>

      <div class="form-group">
        <label for="product-store-tag">Supermercado</label>
        <input
          type="text"
          id="product-store-tag"
          placeholder="ej: Carrefour, Mercadona..."
          list="store-tag-list"
        />
        <datalist id="store-tag-list"></datalist>
      </div>

      <div class="form-group">
        <label>Unidades por defecto</label>
        <div class="product-defaults-row">
          <input type="number" id="product-default-quantity" min="0.1" step="0.1" />
          <select id="product-default-unit"></select>
        </div>
        <small class="form-hint">Puedes cambiarlo al a√±adir el producto a una lista</small>
      </div>

      <div class="form-group">
        <label for="product-image">Foto</label>
        <div class="product-image-row">
          <div class="product-image-preview" id="product-image-preview">
            <span>Sin foto</span>
          </div>
          <div class="product-image-actions">
            <input type="file" id="product-image" accept="image/*" />
            <button type="button" class="btn btn-ghost" id="remove-product-image" hidden>Quitar foto</button>
          </div>
        </div>
        <small class="form-hint">JPG/PNG/WebP, m√°ximo 2MB</small>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="cancel-modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="delete-product" hidden>Eliminar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </dialog>
</AppLayout>

<script type="module">
  import { isAuthResolved, getCurrentUser } from '/js/auth.js';
  import { modal as confirmModal } from '/js/modal.js';
  import { toast } from '/js/toast.js';
  import { getAllProducts, createProduct, updateProduct, deleteProduct, normalizeProductName } from '/js/db.js';
  import { getCurrentGroupId } from '/js/group.js';
  import { getCategoriesForList } from '/js/categories.js';
  import { uploadProductImage, deleteProductImage } from '/js/storage.js';
  import { UNITS } from '/js/db.js';

  let allProducts = [];
  let allCategories = []; // Incluye default + custom
  let sortColumn = localStorage.getItem('productsSortColumn') || 'name';
  let sortDirection = localStorage.getItem('productsSortDirection') || 'asc';
  const productModal = document.getElementById('product-modal');
  const productCategory = document.getElementById('product-category');
  const productStoreTag = document.getElementById('product-store-tag');
  const storeTagList = document.getElementById('store-tag-list');
  const productDefaultQuantity = document.getElementById('product-default-quantity');
  const productDefaultUnit = document.getElementById('product-default-unit');
  const productImageInput = document.getElementById('product-image');
  const productImagePreview = document.getElementById('product-image-preview');
  const removeProductImageBtn = document.getElementById('remove-product-image');
  let selectedImageFile = null;
  let removeImage = false;
  let previewUrl = null;
  let editingProduct = null;

  function updateCategorySelectSize() {
    if (!productCategory) return;
    productCategory.size = window.matchMedia('(max-width: 640px)').matches ? 8 : 1;
  }

  function resetImageState() {
    selectedImageFile = null;
    removeImage = false;
    if (productImageInput) productImageInput.value = '';
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
      previewUrl = null;
    }
  }

  updateCategorySelectSize();
  window.addEventListener('resize', updateCategorySelectSize);

  function setImagePreview(url) {
    if (!productImagePreview) return;
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
      previewUrl = null;
    }

    if (url) {
      productImagePreview.innerHTML = `<img src="${url}" alt="Foto del producto" />`;
    } else {
      productImagePreview.innerHTML = '<span>Sin foto</span>';
    }
  }

  async function loadCategories(groupId) {
    try {
      allCategories = await getCategoriesForList(groupId, 'shopping');

      // Poblar select de categor√≠as
      if (productCategory) {
        productCategory.innerHTML = '<option value="">Sin categor√≠a</option>';
        allCategories.forEach(cat => {
          productCategory.innerHTML += `<option value="${cat.id}">${cat.icon || 'üì¶'} ${cat.name}</option>`;
        });
      }
    } catch (error) {
      console.warn('Error loading categories:', error);
    }
  }

  function loadUnitOptions() {
    if (!productDefaultUnit) return;
    productDefaultUnit.innerHTML = '';
    UNITS.forEach(unit => {
      productDefaultUnit.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
    });
  }

  function updateStoreTagSuggestions(products) {
    if (!storeTagList) return;
    const tags = Array.from(new Set(
      products.map(p => p.storeTag).filter(Boolean)
    )).sort((a, b) => a.localeCompare(b));
    storeTagList.innerHTML = tags.map(tag => `<option value="${tag}"></option>`).join('');
  }

  function getCategoryDisplay(categoryId) {
    if (!categoryId) return '-';
    const cat = allCategories.find(c => c.id === categoryId);
    return cat ? `${cat.icon || 'üì¶'} ${cat.name}` : categoryId;
  }

  function getCategoryName(categoryId) {
    if (!categoryId) return '';
    const cat = allCategories.find(c => c.id === categoryId);
    return cat ? cat.name : categoryId;
  }

  function sortProducts(products) {
    return [...products].sort((a, b) => {
      let valA, valB;

      if (sortColumn === 'name') {
        valA = a.name?.toLowerCase() || '';
        valB = b.name?.toLowerCase() || '';
      } else if (sortColumn === 'category') {
        valA = getCategoryName(a.category).toLowerCase();
        valB = getCategoryName(b.category).toLowerCase();
      } else if (sortColumn === 'storeTag') {
        valA = (a.storeTag || '').toLowerCase();
        valB = (b.storeTag || '').toLowerCase();
      }

      if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }

  function handleSort(column) {
    if (sortColumn === column) {
      sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      sortColumn = column;
      sortDirection = 'asc';
    }
    localStorage.setItem('productsSortColumn', sortColumn);
    localStorage.setItem('productsSortDirection', sortDirection);
    renderProducts(allProducts);
  }

  async function loadProducts() {
    const container = document.getElementById('products-list');
    if (!container) return;

    const groupId = getCurrentGroupId();
    if (!groupId) {
      container.innerHTML = `
        <div class="empty-state">
          <p>No tienes ning√∫n grupo configurado.</p>
          <a href="/app/groups" class="btn btn-primary">Crear o unirse a un grupo</a>
        </div>
      `;
      return;
    }

    try {
      // Cargar categor√≠as primero (incluye custom del grupo)
      await loadCategories(groupId);

      allProducts = await getAllProducts(groupId);
      updateStoreTagSuggestions(allProducts);
      renderProducts(allProducts);
    } catch (error) {
      console.error('Error loading products:', error);
      container.innerHTML = '<div class="empty-state"><p>Error al cargar productos.</p></div>';
    }
  }

  function renderProducts(products) {
    const container = document.getElementById('products-list');
    if (!container) return;

    if (products.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p>A√∫n no hay productos en el cat√°logo.</p>
          <button id="add-first-product" class="btn btn-primary">+ A√±adir primer producto</button>
        </div>
      `;
      document.getElementById('add-first-product')?.addEventListener('click', () => openModal());
      return;
    }

    const sorted = sortProducts(products);
    const getSortIcon = (col) => {
      if (sortColumn !== col) return '<span class="sort-icon">‚áÖ</span>';
      return sortDirection === 'asc'
        ? '<span class="sort-icon active">‚Üë</span>'
        : '<span class="sort-icon active">‚Üì</span>';
    };

    container.innerHTML = `
      <table class="products-table">
        <thead>
          <tr>
            <th>Foto</th>
            <th class="sortable" data-sort="name">
              Producto ${getSortIcon('name')}
            </th>
            <th class="sortable" data-sort="category">
              Categor√≠a ${getSortIcon('category')}
            </th>
            <th class="sortable" data-sort="storeTag">
              Supermercado ${getSortIcon('storeTag')}
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${sorted.map(p => `
            <tr data-id="${p.id}">
              <td class="product-image-cell">
                ${p.imageUrl ? `<img class="product-thumb" src="${p.imageUrl}" alt="">` : '<span class="product-thumb-placeholder">‚Äî</span>'}
              </td>
              <td class="product-name">
                ${p.name}
                ${p.storeTag ? `<span class="product-store-inline">${p.storeTag}</span>` : ''}
                <button class="btn btn-sm btn-ghost edit-btn edit-inline" aria-label="Editar producto" title="Editar">
                  ‚úèÔ∏è
                </button>
              </td>
              <td class="product-category">${getCategoryDisplay(p.category)}</td>
              <td class="product-store">${p.storeTag || '-'}</td>
              <td class="product-actions">
                <button class="btn btn-sm btn-ghost edit-btn" aria-label="Editar producto" title="Editar">
                  ‚úèÔ∏è
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

    // Event listeners para ordenar
    container.querySelectorAll('.sortable').forEach(th => {
      th.addEventListener('click', () => handleSort(th.dataset.sort));
    });

    // Event listeners para editar
    container.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        editProduct(row.dataset.id);
      });
    });
  }

  function openModal(product = null) {
    const modalTitle = document.getElementById('modal-title');
    const productId = document.getElementById('product-id');
    const productName = document.getElementById('product-name');
    const prodCategory = document.getElementById('product-category');
    const deleteBtn = document.getElementById('delete-product');
    const form = document.getElementById('product-form');

    if (product) {
      editingProduct = product;
      if (modalTitle) modalTitle.textContent = 'Editar Producto';
      if (productId) productId.value = product.id;
      if (productName) productName.value = product.name;
      if (prodCategory) prodCategory.value = product.category || '';
      if (productStoreTag) productStoreTag.value = product.storeTag || '';
      if (productDefaultQuantity) productDefaultQuantity.value = product.defaultQuantity || 1;
      if (productDefaultUnit) productDefaultUnit.value = product.defaultUnit || 'unidad';
      if (deleteBtn) deleteBtn.hidden = false;
      resetImageState();
      setImagePreview(product.imageUrl || '');
      if (removeProductImageBtn) {
        removeProductImageBtn.hidden = !product.imageUrl;
      }
    } else {
      editingProduct = null;
      if (modalTitle) modalTitle.textContent = 'Nuevo Producto';
      if (productId) productId.value = '';
      form?.reset();
      if (deleteBtn) deleteBtn.hidden = true;
      if (productDefaultQuantity) productDefaultQuantity.value = 1;
      if (productDefaultUnit) productDefaultUnit.value = 'unidad';
      if (productStoreTag) productStoreTag.value = '';
      resetImageState();
      setImagePreview('');
      if (removeProductImageBtn) removeProductImageBtn.hidden = true;
    }

    if (productModal?.isConnected) {
      productModal.showModal();
    }
  }

  async function updateListItemsCategory(productId, category, productName) {
    const user = getCurrentUser();
    if (!user || !productId) return;

    try {
      const { db } = await import('/js/firebase-config.js');
      const { collection, getDocs, updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');

      const listsRef = collection(db, 'users', user.uid, 'lists');
      const listsSnap = await getDocs(listsRef);
      const normalizedName = normalizeProductName(productName || '');

      const updates = [];
      for (const listDoc of listsSnap.docs) {
        const itemsRef = collection(db, 'users', user.uid, 'lists', listDoc.id, 'items');
        const itemsSnap = await getDocs(itemsRef);
        itemsSnap.forEach(itemDoc => {
          const item = itemDoc.data();
          const matchesProduct = item.productId === productId;
          const matchesName = !item.productId && normalizedName &&
            normalizeProductName(item.name || '') === normalizedName;
          if (!matchesProduct && !matchesName) return;
          updates.push(updateDoc(doc(db, 'users', user.uid, 'lists', listDoc.id, 'items', itemDoc.id), {
            category
          }));
        });
      }

      if (updates.length > 0) {
        await Promise.all(updates);
      }
    } catch (error) {
      console.warn('No se pudieron actualizar las categor√≠as en listas:', error);
    }
  }

  function editProduct(id) {
    const product = allProducts.find(p => p.id === id);
    if (product) openModal(product);
  }

  function tryInit() {
    if (isAuthResolved()) {
      if (getCurrentUser()) loadProducts();
    } else {
      window.addEventListener('auth-ready', () => loadProducts(), { once: true });
    }
  }

  // Ejecutar en carga inicial
  tryInit();

  // Re-ejecutar en navegaciones con View Transitions
  document.addEventListener('astro:page-load', tryInit);

  // Filtro de b√∫squeda
  const searchInput = document.getElementById('search-input');
  searchInput?.addEventListener('input', e => {
    const query = e.target.value.toLowerCase();
    const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query));
    renderProducts(filtered);
  });

  // Modal handlers
  document.getElementById('add-product-btn')?.addEventListener('click', () => openModal());
  document.getElementById('cancel-modal')?.addEventListener('click', () => productModal?.close());
  loadUnitOptions();

  productImageInput?.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    selectedImageFile = file;
    removeImage = false;
    previewUrl = URL.createObjectURL(file);
    setImagePreview(previewUrl);
    if (removeProductImageBtn) removeProductImageBtn.hidden = false;
  });

  removeProductImageBtn?.addEventListener('click', () => {
    selectedImageFile = null;
    removeImage = true;
    if (productImageInput) productImageInput.value = '';
    setImagePreview('');
    if (removeProductImageBtn) removeProductImageBtn.hidden = true;
  });

  document.getElementById('product-form')?.addEventListener('submit', async e => {
    e.preventDefault();
    const groupId = getCurrentGroupId();
    const id = document.getElementById('product-id')?.value;

    // Normalizar nombre a lowercase
    const rawName = document.getElementById('product-name')?.value || '';
    const name = rawName.trim();

    const data = {
      name,
      category: document.getElementById('product-category')?.value || null,
      storeTag: productStoreTag?.value?.trim() || null,
      defaultQuantity: parseFloat(productDefaultQuantity?.value) || 1,
      defaultUnit: productDefaultUnit?.value || 'unidad'
    };

    try {
      let productId = id;
      const previousCategory = editingProduct?.category || null;
      const nextCategory = data.category || 'otros';

      if (id) {
        await updateProduct(groupId, id, data);
        if ((previousCategory || 'otros') !== nextCategory) {
          await updateListItemsCategory(id, nextCategory, name);
        }
      } else {
        productId = await createProduct(groupId, data);
      }

      if (removeImage && productId) {
        await deleteProductImage(groupId, productId);
        await updateProduct(groupId, productId, { imageUrl: null });
      }

      if (selectedImageFile && productId) {
        const imageUrl = await uploadProductImage(selectedImageFile, groupId, productId);
        await updateProduct(groupId, productId, { imageUrl });
      }

      if (id) {
        toast.success('Producto actualizado');
      } else {
        toast.success('Producto a√±adido');
      }

      productModal?.close();
      loadProducts();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });

  document.getElementById('delete-product')?.addEventListener('click', async () => {
    const confirmed = await confirmModal.confirm({
      title: 'Eliminar producto',
      message: '¬øEst√°s seguro de que quieres eliminar este producto?',
      confirmText: 'Eliminar',
      cancelText: 'Cancelar',
      danger: true
    });
    if (!confirmed) return;

    const groupId = getCurrentGroupId();
    const id = document.getElementById('product-id')?.value;

    try {
      await deleteProduct(groupId, id);
      productModal?.close();
      toast.success('Producto eliminado');
      loadProducts();
    } catch (error) {
      toast.error('Error: ' + error.message);
    }
  });
</script>

<style is:global>
  .products-page {
    max-width: 800px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
  }

  .page-header h1 {
    margin-bottom: var(--space-xs);
  }

  .page-header p {
    color: var(--color-text-secondary);
  }

  .search-box {
    position: relative;
    margin-bottom: var(--space-lg);
  }

  .search-box input {
    width: 100%;
    padding: var(--space-sm) var(--space-md) var(--space-sm) 2.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
  }

  .search-box .search-icon {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
  }

  .products-list {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .products-table {
    width: 100%;
    border-collapse: collapse;
  }

  .products-table th,
  .products-table td {
    padding: var(--space-md);
    text-align: left;
  }

  .products-table th {
    background: var(--color-bg-secondary);
    font-weight: 500;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
  }

  .products-table th.sortable {
    cursor: pointer;
    user-select: none;
    transition: background 0.15s ease;
  }

  .products-table th.sortable:hover {
    background: var(--color-border);
  }

  .product-image-row {
    display: flex;
    gap: var(--space-md);
    align-items: center;
  }

  .product-image-preview {
    width: 72px;
    height: 72px;
    border-radius: 12px;
    border: 1px dashed var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: #f8fafc;
    color: var(--color-text-secondary);
    font-size: 0.75rem;
  }

  .product-image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-image-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .product-image-actions input[type="file"] {
    font-size: 0.875rem;
  }

  .category-select {
    max-height: 50vh;
    overflow-y: auto;
  }

  .product-defaults-row {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
  }

  .product-defaults-row input,
  .product-defaults-row select {
    padding: 0.375rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .product-defaults-row input {
    width: 80px;
  }

  .product-defaults-row select {
    min-width: 140px;
  }

  .sort-icon {
    margin-left: 0.5rem;
    opacity: 0.4;
    font-size: 0.75rem;
  }

  .sort-icon.active {
    opacity: 1;
    color: var(--color-primary);
  }

  .products-table tr:not(:last-child) td {
    border-bottom: 1px solid var(--color-border);
  }

  .product-name {
    font-weight: 500;
  }

  .product-category {
    color: var(--color-text-secondary);
  }

  .product-store {
    color: var(--color-text-secondary);
    white-space: nowrap;
  }

  .product-store-inline {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    margin-top: 2px;
  }

  .product-image-cell {
    width: 56px;
  }

  .product-thumb {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--color-border);
    background: #fff;
  }

  .product-thumb-placeholder {
    display: inline-flex;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    border: 1px dashed var(--color-border);
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
  }

  .product-actions {
    text-align: right;
  }

  .product-actions .edit-btn {
    font-size: 1rem;
    line-height: 1;
  }

  .edit-inline {
    display: none;
    margin-left: var(--space-xs);
  }

  @media (max-width: 640px) {
    .products-table {
      display: block;
      width: 100%;
      overflow-x: auto;
    }

    .products-table thead,
    .products-table th:last-child,
    .products-table td.product-actions,
    .products-table td.product-store,
    .products-table th[data-sort="storeTag"] {
      display: none;
    }

    .edit-inline {
      display: inline-flex;
    }
  }

  .btn-sm {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--font-size-sm);
  }

  .btn-ghost {
    background: transparent;
    color: var(--color-text-secondary);
  }

  .btn-ghost:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: none;
    border-radius: var(--radius-lg);
    padding: 0;
    max-width: 450px;
    width: 90%;
    background: var(--color-bg);
    color: var(--color-text);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    padding: var(--space-xl);
  }

  .modal-content h2 {
    margin-bottom: var(--space-lg);
    color: var(--color-text);
  }

  .form-group {
    margin-bottom: var(--space-md);
  }

  .form-group label {
    display: block;
    margin-bottom: var(--space-xs);
    font-weight: 500;
    color: var(--color-text);
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    color: var(--color-text);
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .form-hint {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-top: var(--space-xs);
  }

  .modal-actions {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
    margin-top: var(--space-lg);
  }

  .btn-danger {
    background: var(--color-danger);
    color: white;
    margin-right: auto;
  }

  .btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-border);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }

  .empty-state .btn {
    margin-top: var(--space-md);
  }

  .loading {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-secondary);
  }
</style>
